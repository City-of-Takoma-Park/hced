---
title: "&nbsp;"
date: ""
output:
  html_document:
    theme: "yeti"
    number_sections: false
    fig_width: 8
    fig_height: 5
    fig_caption: yes

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, out.width = '100%')



library(tidycensus)
library(sf)
library(leaflet)
library(tidyverse)
library(plotly)
# library(plyr)
library(dplyr)
library(reprex)
library(rlang)
library(glue)
library(RColorBrewer)

# custom packages
library(acsprocess)
library(tpfuncts)
library(leafletwrappers)
library(plotlywrappers)

# race_formatter <- function(df, race_col){
#   df %>%
#     mutate(race = acsprocess::race_recode({{ race_col }}))
# }

pal_race <- brewer.pal(10, "Accent")[c(-4, -5)]


# function to generate graphs of a specific race by location
race_breakout_gen <- function(df, 
                              title, 
                              show_legend = FALSE,
                              x = "educ_recode",
                              name = "location",
                              y = "cumul_pct",
                              type = "scatter",
                              range = c(0, 110),
                              ytick = 20) {
  
  # browser()
  
  name <- sym(name)
  name <- enquo(name) %>%
    quo_set_env(global_env())
  
  x <- sym(x)
  x <- enquo(x) %>%
    quo_set_env(global_env())
  
  y <- sym(y)
  y <- enquo(y) %>%
    quo_set_env(global_env())
  
  plot_ly(data = df %>%
            race_factor(),
          type = type,
          mode = "lines+markers",
          legendgroup = name,
          showlegend = show_legend,
          name = name,
          color = name,
          y = y,
          x = x,
          hovertext = ~ glue("Significant differences: {signif_check}"),
          title = title) %>%
    subplot_title(title = title) %>%
    layout(xaxis = list(title = ""),
           # showgrid = FALSE)
           yaxis = list(title = "",
                        dtick = ytick,
                        tickmode = "linear",
                        range = range))
  # showgrid = FALSE))
}

```

# ![takoma park logo](images/logo.png){height=80px}  Takoma Park Data Explorer {- .tabset}

***About***: This webpage allows Takoma Park residents and staff to learn more about their city through data. Data comes from the Census's [2015-2019 American Community Survey](https://www.census.gov/programs-surveys/acs). Each heading tab opens to a "Summary" sub-tab; click on other sub-tabs to see data-visualizations and detailed explanations. All graphics are interactive; you can click and double-click on legend items to hide or show them, and mousing over graphics will show data-values. The "Methodology" tab describes data sources and statistical significance. Code used to produce this webpage can be found on the [City's Github page](https://github.com/City-of-Takoma-Park/hced). Similar web-maps can be found in the [City's interactive demographic map](https://takomaparkmd.gov/news/learn-about-your-neighborhood-with-interactive-maps/) and in the [City's Social Vulnerability Index maps](https://takomaparkmd.gov/government/housing-and-community-development/planning-and-community-development/data-driven-approach-to-disaster-pandemic-response/).

Please send any questions, comments, or feedback to Public Administration Specialist Dan Powers at danielp@takomaparkmd.gov.

```{r demographics race, echo=FALSE}

data_binder <- function(file_root){
  # browser()
  acsprocess::data_binder(file_root = file_root, dir_root = "./data/output_data/acs5_2019/tp_spec/")
}

race_ethn <- data_binder(file_root = "race_ethn_processed") %>%
  name_num_formatter()

pull_tp_white_all <- race_ethn %>% 
  filter(race_ethnicity == "White alone" & grepl("Takoma", name)) %>%
  pull(pct_race)

race_ethn_processed <- race_ethn %>%
  name_num_formatter("pct_race") %>%
  filter(race_ethnicity != "White alone") %>%
  race_recode(race_ethnicity)

race_ethn_tp <-race_ethn_processed %>%
  filter(grepl("Takoma", location))

tp_race_cats <- race_ethn_tp %>%
  filter(estimate <= 30) %>%
  pull(race)

y_ax_race <- list(title = "Residents")
x_ax_race <- list(title = "Race/ethnicity")

pull_pop_tp <- pull(race_ethn_tp, pop_total)[1]

pull_race_tp <- pull_creator(race_ethn_tp, filter_col = "race")

pull_white_tp_pct <- pull_race_tp("White", "pct_race")

pull_tp_white_hisp <- pull_tp_white_all - pull_white_tp_pct

pull_black_tp_pct <- pull_race_tp("Black", "pct_race")

pull_asian_tp_pct <- pull_race_tp("Asian", "pct_race")


pull_hisp_tp_pct <- pull_race_tp("Hispanic", "pct_race")

```



```{r glue race overall}

text_raceoverall <- glue("**Most Takoma Park residents are persons of color, although non-Hispanic white people represent a plurality of the City's residents at {pull_white_tp_pct}%** (note: throughout this webpage, Hispanic white people are excluded from counts of white people, but Hispanic people of color are included in counts of people of color. White-Hispanic people represent {(pull_tp_white_all - pull_white_tp_pct) %>% commafy}% of Takoma Park's population). The next largest groups of residents are Black residents at {pull_black_tp_pct}%, and Hispanic residents at {pull_hisp_tp_pct}%.")

```


```{r plot race}



fig_race_ethn <- plot_ly(race_ethn_tp %>%
                           race_factor(), 
                         x = ~ race,
                         y = ~ estimate,
                         name = ~ race,
                         color = ~ race,
                         opacity = 0.8,
                         colors = pal_race,
                         text = ~ paste0("Percent: ", pct_race, "%"),
                         type = "bar") %>%
  plotly::layout(xaxis = x_ax_race,
                 yaxis = y_ax_race,
                 title = "Population by race/ethnicity",
                 showlegend = F)

```



```{r sex}

age_sex <- data_binder("^age_gender") %>%
  name_num_formatter() %>%
  mutate(sex = case_when(grepl("Male", gender) ~ "Male",
                         grepl("Female", gender) ~ "Female"))

sex <- age_sex %>%
  ungroup %>%
  select(name, location,sex, tot_people, tot_people_moe, tot_gender, tot_gender_moe) %>%
  distinct %>%
  derive_pct_est_moe(c("pct_sex"), "tot_people", "tot_people_moe", "tot_gender", "tot_gender_moe") %>%
  name_num_formatter()

pull_sex <- pull_creator(sex %>% filter(grepl("Takoma", location)),
                         "sex")

pull_woman_pct <- pull_sex("Female", "pct_sex")

```


```{r age tot}

age <- age_sex %>%
  est_moe_derive(c("name", "age"), name_col = "age_tot") %>%
  select(name, location, tot_people, tot_people_moe, age, age_tot_est, age_tot_moe) %>%
  distinct() %>%
  derive_pct_est_moe("pct_age", 
                     "tot_people",
                     "tot_people_moe",
                     "age_tot_est",
                     "age_tot_moe") %>%
  name_num_formatter()


age <- age_recode(age, age)

age_grped <- age %>%
  est_moe_derive(c("name", "age_group"), "age_tot_est", "age_tot_moe", "age_grp") %>%
  select(name, age_group, location, tot_people, tot_people_moe, age_grp_est, age_grp_moe) %>%
  distinct %>%
  derive_pct_est_moe("pct_age", "tot_people", "tot_people_moe", "age_grp_est", "age_grp_moe") %>%
  name_num_formatter()

write_age_grped <- age_grped %>%
  select(location, age_group, tot_people, tot_people_moe, age_grp_est, age_grp_moe, pct_age, pct_moe)

write.csv(write_age_grped, "./data/output_data/write_age_grped.csv")

pull_age <- pull_creator(age_grped, c("name", "age_group"))

pull_tp_4049 <- pull_age(c("Takoma", "40-49"), pull_col = "pct_age")

pull_tp_3039 <- pull_age(c("Takoma", "30-39"), pull_col = "pct_age")

pull_mont_4049 <- pull_age(c("Montg", "40-49"), pull_col = "pct_age")

pull_md_4049 <- pull_age(c("^Maryland", "40-49"), pull_col = "pct_age")

pull_tp_09 <- pull_age(c("Takoma", "0-9"), pull_col = "pct_age")

pull_mont_09 <- pull_age(c("Montg", "0-9"), pull_col = "pct_age")

pull_md_09 <- pull_age(c("^Maryland", "0-9"), pull_col = "pct_age")

pull_tp_70more <- pull_age(c("Takoma", "(70-79)|(80)"), pull_col = "pct_age") %>%
  sum

pull_mont_70more <- pull_age(c("Montg", "(70-79)|(80)"), pull_col = "pct_age") %>%
  sum

pull_md_70more <- pull_age(c("^Maryland", "(70-79)|(80)"), pull_col = "pct_age") %>%
  sum

pull_tp_2029 <- pull_age(c("Takoma", "20-29"), pull_col = "pct_age")

pull_mont_2029 <- pull_age(c("Montg", "20-29"), pull_col = "pct_age")

pull_md_2029 <- pull_age(c("^Maryland", "20-29"), pull_col = "pct_age")


```



```{r disability overall}

disability_age_sex <- data_binder("disability_overall") %>%
  name_num_formatter() %>%
  age_recode(age, regroup = F)

disability <- disability_age_sex %>%
  est_moe_derive(c("name", "disability"), name_col = "disability") %>%
  select(name, location, tot_pop, tot_pop_moe, disability, disability_est, disability_moe) %>%
  distinct %>%
  derive_pct_est_moe("pct_disability",
                     "tot_pop",
                     "tot_pop_moe",
                     "disability_est",
                     "disability_moe") %>%
  name_num_formatter() 

disability_processed <- disability %>%
  filter(grepl("With a disability", disability))

pull_disability <- pull_creator(disability_processed, c("name"))

pull_disability_tp_pct <- pull_disability("Takoma", "pct_disability")

pull_disability_tp_tot <- pull_disability("Takoma", "disability_est") %>%
  commafy


pull_disability_mont_pct <- pull_disability("Montgomery", "pct_disability")

pull_disability_md_pct <- pull_disability("^Maryland", "pct_disability")

```



```{r foreign birth, echo=FALSE}
foreign_birth <- data_binder("foreign_born_birth_processed") %>%
  name_formatter() %>%
  mutate(continent = gsub(":", "", continent),
         continent_pct = round(continent_pct, 2))

pull_foreign_birth <- pull_creator(foreign_birth, c("name", "continent"))

pull_tp_africa <- pull_foreign_birth(c("Takoma", "Africa"), "continent_pct") %>%
  commafy()


pull_tp_latin <- pull_foreign_birth(c("Takoma", "Latin America"), "continent_pct") %>%
  commafy()


pull_mont_africa <- pull_foreign_birth(c("Montgomery", "Africa"), "continent_pct") %>%
  commafy()

pull_tp_asia <- pull_foreign_birth(c("Takoma", "asia"), "continent_pct") %>%
  commafy()

pull_mont_asia <- pull_foreign_birth(c("Montgomery", "asia"), "continent_pct") %>%
  commafy()



```

```{r foreign borne, echo=FALSE}
foreign <- data_binder("foreign_born_processed") %>%
  name_formatter() %>%
  num_formatter()

pull_foreign_birth <- pull_creator(foreign, c("name", "birthplace"))

pull_tp_foreign <- pull_foreign_birth(c("Takoma", "foreign"), "birth_pct")

pull_md_foreign <- pull_foreign_birth(c("^Maryland$", "foreign"), "birth_pct")

pull_mont_foreign <- pull_foreign_birth(c("Montgomery", "foreign"), "birth_pct")

```


```{r foreign born race, echo=FALSE}
race_foreign_born <- data_binder("race_foreign_born_byrace") %>%
  filter(!grepl("white alone$", race)) %>%
  race_recode(race) %>%
  name_formatter() %>%
  num_formatter() %>%
  filter(grepl("Takoma", location) & race_total > 150) %>%
  mutate(race = factor(race, .$race, .$race),
         birthplace = factor(birthplace, .$birthplace, .$birthplace))

race_foreign_born <- birth_recode(race_foreign_born, birthplace)

pull_race_foreign_born <- pull_creator(race_foreign_born, c("name", "birthplace", "race"))

pull_black_foreignborn <- pull_race_foreign_born(c("Takoma", "Foreign", "Black"), "pct_race")

pull_hispanic_foreignborn <- pull_race_foreign_born(c("Takoma", "Foreign", "hispanic"), "pct_race")

pull_asian_foreignborn <- pull_race_foreign_born(c("Takoma", "Foreign", "asian"), "pct_race")

pull_other_foreignborn <- pull_race_foreign_born(c("Takoma", "Foreign", "other"), "pct_race")

pull_white_otherstate <- pull_race_foreign_born(c("Takoma", "Other state", "white"), "pct_race")

pull_multi_otherstate <- pull_race_foreign_born(c("Takoma", "Other state", "multi"), "pct_race")


```

```{r process asian disag}

asian_disag <- data_binder("asian_disag") %>%
  name_num_formatter() %>%
  asian_country_recode(ethnicity)

asian_disag_tp <- filter(asian_disag, grepl("Takoma", name))

asian_disag_process <- asian_disag_tp %>%
  filter(estimate > 0)

pull_asian_disag <- pull_creator(asian_disag_tp, c("ethnicity"))

pull_indian <- pull_asian_disag("Indian", "estimate")

pull_indian_pct <- pull_asian_disag("Indian", "pct_asian")

pull_chinese <- pull_asian_disag("chinese", "estimate")

pull_chinese_pct <- pull_asian_disag("chinese", "pct_asian")

pull_vietnamese <- pull_asian_disag("vietnamese", "estimate")

pull_vietnamese_pct <- pull_asian_disag("vietnamese", "pct_asian")

```


```{r plot asian disag}

plot_asian_disag <- plot_ly(asian_disag_process, 
                            x = ~ new_ethnicity,
                            y = ~ estimate,
                            name = ~ new_ethnicity,
                            hovertext = ~ glue("Percent total: {pct_asian}%
                           Margin of error: {moe}"),
                           color = ~ new_ethnicity) %>%
  layout(xaxis = list(title = "Ethnicity"),
         yaxis = list(title = "Total"),
         title = "Asian residents by ethnicity")

```


```{r language at home}

language <- data_binder("home_lang") %>%
  name_formatter() %>%
  num_formatter() %>%
  mutate(language = gsub(":", "", language))

pull_language <- pull_creator(language, c("name", "language"))

pull_tp_english <- pull_language(c("Takoma", "English"), pull_col = "pct_language")

pull_tp_other <- 100 - pull_tp_english

pull_tp_spanish <- pull_language(c("Takoma", "Spanish"), pull_col = "pct_language")

pull_tp_other <- pull_language(c("Takoma", "Other"), pull_col = "pct_language")


pull_md_english <- pull_language(c("^Maryland$", "English"), pull_col = "pct_language")

pull_md_other <- 100 - pull_md_english

pull_md_spanish <- pull_language(c("^Maryland$", "Spanish"), pull_col = "pct_language")

pull_md_other <- pull_language(c("^Maryland$", "Other"), pull_col = "pct_language")

pull_md_english <- pull_language(c("^Maryland$", "English"), pull_col = "pct_language")


```

```{r age lang}

age_lang <- data_binder("lang_age")


lang_order <- c("Only English",
                "Spanish",
                "Asian and Pacific Island languages",
                "Other Indo-European languages",
                "Other languages")

age_lang_tp <- age_lang %>%
  filter(grepl("Takoma", name)) %>%
  age_recode(age) %>%
  mutate(homelang = gsub("Speak ", "", homelang),
         homelang = gsub("only", "Only", homelang),
         homelang = gsub("other", "Other", homelang),
         homelang = factor(homelang, lang_order, lang_order))

```

```{r age sex}
age_sex_processed <- age_recode(age_sex, age) %>%
  filter(grepl("Takoma", name)) %>%
  est_moe_derive(c("sex", "age_group"), name_col = "age_grp") %>%
  select(name, sex, age_group, age_grp_est, age_grp_moe, tot_people, tot_people_moe, tot_gender, tot_gender_moe) %>%
  distinct() %>%
  derive_pct_est_moe("pct_age", "tot_gender", "tot_gender_moe", "age_grp_est", "age_grp_moe") %>%
  derive_pct_est_moe("pct_age_pop", "tot_people", "tot_people_moe", "age_grp_est", "age_grp_moe") %>%
  name_num_formatter()

pull_age_sex <- pull_creator(age_sex_processed, c("sex", "age_group"))

pull_female_3039_pct <- pull_age_sex(c("female", "30-39"), "pct_age")

pull_female_3039_pctpop <- pull_age_sex(c("female", "30-39"), "pct_age_pop")

pull_female_3039_tot <- pull_age_sex(c("female", "30-39"), "age_grp_est")



pull_male_3039_pct <- pull_age_sex(c("^male", "30-39"), "pct_age")

pull_male_3039_tot <- pull_age_sex(c("^male", "30-39"), "age_grp_est")


pull_female_4049_pct <- pull_age_sex(c("female", "40-49"), "pct_age")

pull_female_4049_pctpop <- pull_age_sex(c("female", "40-49"), "pct_age_pop")


pull_male_4049_pct <- pull_age_sex(c("^male", "40-49"), "pct_age")

pull_male_4049_pctpop <- pull_age_sex(c("^male", "40-49"), "pct_age_pop")



pull_male_09_pct <- pull_age_sex(c("^male", "0-9"), "pct_age")

pull_male_09_pctpop <- pull_age_sex(c("^male", "0-9"), "pct_age_pop")

pull_male_09_tot <- pull_age_sex(c("^male", "0-9"), "age_grp_est")


pull_female_09_pct <- pull_age_sex(c("^female", "0-9"), "pct_age")

pull_female_09_tot <- pull_age_sex(c("^female", "0-9"), "age_grp_est")


pull_diff_09_tot <- (pull_male_09_tot - pull_female_09_tot) %>% commafy

pull_diff_3039_tot <- (pull_female_3039_tot - pull_male_3039_tot) %>% commafy


```

```{r hous famtype}

recode_houstype <- function(df, col_name = hous_type){
  recode_string <- function(string){
    process <- gsub(" householder, no (spouse or partner|spouse) present:", "", string) %>%
      gsub(":", "", .) %>%
      gsub("Married-couple", "Married", .) %>%
      gsub("Male", "Male", .) %>%
      gsub("Female", "Female", .) %>%
      gsub(" household", "", .) %>%
      gsub("-", " ", .) %>%
      gsub(" family", "", .)
    
  }
  
  df %>%
    dplyr::mutate({{col_name}} := recode_string({{col_name}}))
}

recode_housfam <- function(df, houscol = houstype, famcol = famtype){
  
  recode_hous <- function(string){
    gsub(" households:", "", string)
  }
  
  recode_famtype <- function(string){
    str <- string %>%
      gsub(" family", "", .) %>%
      gsub(", no spouse present", "", .) %>%
      gsub("not living alone", "living with others", .) %>%
      gsub("Female householder", "Single female", .) %>%
      gsub("Male householder", "Single male", .)
    
    case_when(!grepl("Householder", str) ~ paste0(str, " family"),
              TRUE ~ str)
    
  }
  
  df %>%
    dplyr::mutate({{houscol}} := recode_hous({{houscol}}),
                  {{famcol}} := recode_famtype({{famcol}}))
  
}

hous_famtype <- data_binder("hous_famtype_overall") %>%
  # recode_houstype(famtype) %>%
  derive_pct_est_moe("pct_houstyp", aggregate_est = "type_households", aggregate_moe = "type_households_moe") %>%
  derive_pct_est_moe("pct_allhous", aggregate_est = "households", aggregate_moe = "households_moe") %>%
  name_num_formatter() %>%
  signif_mont_tp(join_col = c("houstype", "famtype"), name_pct = pct_allhous) %>%
  signif_checker(signif_cols = list("MC" = "signif_mont", "MD" = "signif_maryland")) %>%
  recode_housfam()

plot_hous_famtype_tp <- plot_ly(hous_famtype %>%
                                  filter(grepl("Takoma", location)),
                                x = ~ houstype,
                                y = ~ estimate,
                                color = ~ famtype,
                                hovertext = ~ glue(
                                  "Percent household-type: {pct_houstyp}%
                                Margin of error: {moe %>% commafy}"),
                                text = ~ glue(
                                  "Total:
                                {estimate %>% commafy}"),
                                textposition = "inside",
                                textfont = list(color = "black"),
                                name = ~ famtype,
                                type = "bar",
                                legendgroup = ~ famtype,
                                showlegend = T) %>%
  layout(barmode = "stack",
         title = "Takoma Park households by family-type",
         yaxis = list(title = "Households"),
         xaxis = list(title = "Household type"))

plot_hous_famtype_loc <- plot_ly(hous_famtype,
                                 x = ~ location,
                                 showlegend = F,
                                 text = ~ glue("{pct_allhous}%"),
                                 textposition = "inside",
                                 textfont = list(color = "black"),
                                 hovertext = ~ glue("Total: {estimate %>% commafy}
                                                    Margin of error: {pct_moe}%
                                                    Significant differences: {signif_check}"),
                                 y = ~ pct_allhous,
                                 color = ~ famtype,
                                 name = ~ famtype,
                                 legendgroup = ~ famtype,
                                 type = "bar") %>%
  layout(xaxis = list(title = ""),
         yaxis = list(title = "Percent of households"),
         title = "Households by familty type and location")

pull_hous_famtype <- pull_creator(hous_famtype, c("location", "famtype"), default_pull = "pct_allhous")

pull_tot_households <- (hous_famtype %>%
                          filter(location == 'Takoma Park') %>%
                          pull(households))[1]

pull_hous_family <- pull_hous_famtype(c("Takoma", "Married"), "type_households")

pull_hous_nonfamily <- pull_hous_famtype(c("Takoma", "Householder living"), "type_households")[1]

pull_housfam_married <- pull_hous_famtype(c("Takoma", "Married"), "estimate")

pull_housfam_alone <- pull_hous_famtype(c("Takoma", "living alone"), "estimate")

pull_housfam_singfem <- pull_hous_famtype(c("Takoma", "Single female"), "estimate")

pull_housfam_singfem_pct <- pull_hous_famtype(c("Takoma", "Single female"))

pull_housfam_married_pct <- pull_hous_famtype(c("Takoma", "Married"))

pull_housfam_singfem_pct_mont <- pull_hous_famtype(c("Mont", "Single female"))

pull_housfam_married_pct_mont <- pull_hous_famtype(c("Mont", "Married"))

```


```{r family}

# function to recode house type
recode_houstype <- function(df, col_name = hous_type){
  recode_string <- function(string){
    process <- gsub(" householder, no (spouse or partner|spouse) present:", "", string) %>%
      gsub(":", "", .) %>%
      gsub("Married-couple", "Married", .) %>%
      gsub("Male", "Male", .) %>%
      gsub("Female", "Female", .) %>%
      gsub(" household", "", .) %>%
      gsub("-", " ", .) %>%
      gsub(" family", "", .)
    
  }
  
  df %>%
    dplyr::mutate({{col_name}} := recode_string({{col_name}}))
}


recode_hous_ppl <- function(df, col_name = hous_people){
  
  factor <- c(
    "With own children (< 18)",
    "With roommates",
    "With relatives",
    "Alone"
  )
  
  recode_string <- function(string){
    case_when(
      grepl("With relatives", string) ~ factor[3],
      grepl("(no own children)|(alone)", string) ~ factor[4],
      grepl(" own children ", string) ~ factor[1],
      grepl("nonrelatives", string) ~ factor[2]
    )
  }
  
  df %>%
    dplyr::mutate({{col_name}} := factor(
      recode_string({{col_name}}),
      factor,
      factor
    ))
  
}



family_overall <- data_binder(file_root = "family_overall") %>%
  name_num_formatter() %>%
  recode_houstype() %>%
  recode_hous_ppl()

# process by household type and occupants
family_hous_ppl_processed <- family_overall %>%
  process_df_tp(
    group_cols = c("location", "hous_type", "hous_people"), 
    overall_cols = c("location", "hous_type"),
    name_col = "hous_ppl"
  )

# filter to tp
# tp_family_hous_ppl <- family_hous_ppl_processed %>%
#   filter(grepl("Takoma", location))

# # takoma park
# plot_family_byocc_tp <- plot_ly(tp_family_hous_ppl,
#         x = ~ hous_type,
#         y = ~ hous_ppl_est,
#         text = ~ glue("{pct_hous_ppl}%"),
#         textposition = "inside", 
#         textfont = list(color = "black"),
#         name = ~ hous_people,
#         type = "bar") %>%
#   layout(
#     title = "Takoma Park households by relationship and co-occupants",
#     yaxis = list(title = "Households"),
#     xaxis = list(title = "Household type"),
#     barmode = "stack"
#   )



```


```{r pull family hous ppl}
# generate plots family/occupants by place

plot_loc_family_hous_ppl <- function(typ_val, showleg = F, yval = 1.1) {
  df <- family_hous_ppl_processed %>%
    filter(grepl(typ_val, hous_type))
  
  plot_ly(df,
          x = ~ location,
          y = ~ pct_hous_ppl,
          color = ~ hous_people,
          hovertext = ~ glue(
            "Total: {hous_ppl_est %>% commafy}
            Margin of error: {pct_moe}%
            Significant differences: {signif_check}"),
          legendgroup = ~ hous_people,
          showlegend = showleg,
          text = ~ glue("{pct_hous_ppl}%"),
          textposition = "inside",
          textfont = list(color = "black", opacity = 0.8),
          type = "bar") %>%
    layout(xaxis = list(title = ""),
           yaxis = list(title = ""),
           barmode = "stack") %>%
    subplot_title(paste0(typ_val, " percent"), .y = yval)
}


pull_family_housppl <- pull_creator(family_hous_ppl_processed, 
                                    c("location", "hous_type", "hous_people"),
                                    "pct_hous_ppl")

pull_tp_married_child_pct <- pull_family_housppl(c("Takoma", "Married", "children"))
pull_md_married_child_pct <- pull_family_housppl(c("Maryland", "Married", "children"))
pull_mc_married_child_pct <- pull_family_housppl(c("Montgomery", "Married", "children"))

pull_tp_male_alone_pct <- pull_family_housppl(c("Takoma", "^male", "alone"))
pull_md_male_alone_pct <- pull_family_housppl(c("Maryland", "^male", "alone"))
pull_mc_male_alone_pct <- pull_family_housppl(c("Montgomery", "^male", "alone"))

pull_tp_cohab_child_pct <- pull_family_housppl(c("Takoma", "cohab", "children"))
pull_tp_female_child_pct <- pull_family_housppl(c("Takoma", "female", "children"))
pull_tp_male_child_pct <- pull_family_housppl(c("Takoma", "^male", "children"))
pull_tp_female_roommate_pct <- pull_family_housppl(c("Takoma", "female", "roommate"))
pull_tp_male_roommate_pct <- pull_family_housppl(c("Takoma", "^male", "roommate"))


```

```{r households type}

family_hous_processed <- family_overall %>%
  process_df_tp(
    group_cols = c("location", "hous_type"), 
    overall_cols = c("location", "hous_type"),
    name_col = "type"
  )


pull_hous_typ <- pull_creator(family_hous_processed, 
                              filter_col = c("location", 
                                             "hous_type"),
                              default_pull = "pct_type")

pull_married_tp <- pull_hous_typ(c("Takoma", "Married"))
pull_married_md <- pull_hous_typ(c("Maryland", "Married"))
pull_married_mc <- pull_hous_typ(c("Montgomery", "Married"))

pull_female_tp <- pull_hous_typ(c("Takoma", "female"))
pull_female_md <- pull_hous_typ(c("Maryland", "female"))
pull_female_mc <- pull_hous_typ(c("Montgomery", "female"))

pull_male_tp <- pull_hous_typ(c("Takoma", "^male"))

pull_cohab_tp <- pull_hous_typ(c("Takoma", "cohab"))


```

<!-- Half of Takoma Park households are married (`r pull_married_tp`%) or co-habitating couples (`r pull_cohab_tp`%), with single women households making up `r  pull_female_tp`% of the remaining households and single-men households making up `r pull_male_tp`%. Compared to Montgomery County and Maryland, Takoma Park has a lower share of married couple households (`r pull_married_mc`% in Montgomery County and `r pull_married_md`% in Maryland) and a higher share of single women households (`r pull_female_mc`% in the County and `r pull_female_md`% in Maryland). -->

<!-- ```{r plot households type} -->

<!-- plot_family_housetyp_loc <- plot_ly(family_hous_processed, -->
<!--                                     x = ~ location, -->
<!--                                     y = ~ pct_type, -->
<!--                                     name = ~ hous_type, -->
<!--                                     color = ~ hous_type, -->
<!--                                     type= "bar", -->
<!--                                     hovertext = ~ glue( -->
<!--                                       "Total: {type_est %>% commafy} -->
<!--           Margin of error: {pct_moe}% -->
<!--           Significant differences: {signif_check}")) %>% -->
<!--   layout(title = "Households by type",  -->
<!--          xaxis = list(title = "Household-type"), -->
<!--          yaxis = list(title = "Percent-households")) -->

<!-- ``` -->


```{r disability age}

disability_age <- disability_age_sex %>%
  est_moe_derive(c("name", "age_new"), name_col = "age") %>%
  est_moe_derive(c("name", "age_new", "disability"), name_col = "disability") %>%
  select(name, location, age_new, disability, tot_pop, tot_pop_moe, age_est, age_moe, disability_est, disability_moe) %>%
  distinct %>%
  derive_pct_est_moe("pct_disability",
                     "age_est",
                     "age_moe",
                     "disability_est",
                     "disability_moe") %>%
  rename(pct_moe_disab = pct_moe) %>%
  derive_pct_est_moe("pct_disability_pop",
                     "tot_pop",
                     "tot_pop_moe",
                     "disability_est",
                     "disability_moe") %>%
  name_num_formatter() %>%
  filter(grepl("With a disability", disability))

pull_disability_age <- pull_creator(disability_age, c("name", "age_new"))

pull_disab_tp_less5 <- pull_disability_age(c("Takoma", "<"), "pct_disability")  

pull_disab_tp_75 <- pull_disability_age(c("Takoma", "75"), "pct_disability")  

pull_disab_tp_75_tot <- pull_disability_age(c("Takoma", "75"), "disability_est")  


pull_disab_tp_3564 <- pull_disability_age(c("Takoma", "35-64"), "pct_disability")  

pull_disab_tp_3564_tot <- pull_disability_age(c("Takoma", "35-64"), "disability_est")  


pull_disab_mont_75 <- pull_disability_age(c("Montgomery", "75"), "pct_disability")  

pull_disab_md_75 <- pull_disability_age(c("^Maryland", "75"), "pct_disability")  


pull_disab_md_3564 <- pull_disability_age(c("^Maryland", "35-64"), "pct_disability")  

pull_disab_md_517 <- pull_disability_age(c("^Maryland", "5-17"), "pct_disability")  

pull_disab_tp_517 <- pull_disability_age(c("Takoma", "5-17"), "pct_disability")  




```

```{r disability type}

disab_type <- data_binder("disab_type_pop") %>%
  name_num_formatter() %>%
  signif_mont_tp(c("disability"), name_pct = name_disab_type_pct_pop, pct_moe_pop) %>%
  signif_checker(list("MC" = "signif_mont", "MD" = "signif_maryland"))

plot_tp_disabtype <- plot_ly(disab_type %>%
                               filter(grepl("Tako", name)), 
                             x = ~ disability,
                             y = ~ name_disab_type_est,
                             color = ~ disability,
                             type = "bar",
                             name = ~ disability,
                             legendgroup = ~ disability) %>%
  layout(xaxis = list(title = "Disability type"),
         yaxis = list(title = "Total"),
         title = "Takoma Park disability by type")

plot_disabtype_loc <- plot_ly(disab_type,
                              x = ~ disability,
                              y = ~ name_disab_type_pct_pop,
                              color = ~ location,
                              type = "bar",
                              colors = "Accent",
                              name = ~ location,
                              text = ~ glue("Percent of persons with disability: {name_disab_type_pct_disab}%
                      Significant differences: {signif_check}"),
                      legendgroup = ~ location) %>%
  layout(xaxis = list(title = "Disability type"),
         yaxis = list(title = "Percent-population"),
         title = "Disability by type")

pull_disab_type <- pull_creator(disab_type, c("location", "disability"))

pull_disab_type_ambulatory <- pull_disab_type(c("Takoma", "Ambulatory"),
                                              "name_disab_type_pct_pop")

pull_disab_type_ind_pct <- pull_disab_type(c("Takoma", "Independent living"),
                                           "name_disab_type_pct_pop")

pull_disab_type_cognitive_pct <- pull_disab_type(c("Takoma", "Cognitive"),
                                                 "name_disab_type_pct_pop")

pull_disab_type_cognitive_pct_mont <- pull_disab_type(c("Mont", "Cognitive"),
                                                      "name_disab_type_pct_pop")

pull_disab_type_hearing_pct <- pull_disab_type(c("Takoma", "Hearing"),
                                               "name_disab_type_pct_pop")

pull_disab_type_hearing_pct_mont <- pull_disab_type(c("Mont", "Hearing"),
                                                    "name_disab_type_pct_pop")

plots_disabtype_sub <- subplot(plot_tp_disabtype %>%
                                 subplot_title("Takoma Park total"),
                               plot_disabtype_loc %>%
                                 subplot_title("Percent-population"),
                               nrows = 2,
                               shareX = T)
```


```{r disability type age}

disab_type_age <- data_binder("disab_type_age") %>%
  name_num_formatter()

disab_type_age_tp <- disab_type_age %>%
  filter(grepl("Takoma", location)) %>%
  age_recode(age)

plot_disab_type_age <- plot_ly(disab_type_age_tp,
                               x = ~ age_new,
                               y = ~ age_disab_type_est,
                               color = ~ disability,
                               name = ~ disability,
                               legendgroup = ~ disability,
                               # text = ~ glue(""),
                               type = "bar") %>%
  layout(xaxis = list(title = "Age"),
         yaxis = list(title = "Total residents"),
         title = "Takoma Park disability by age and type") %>%
  subplot_title("Total residents")


plot_disab_type_age_scatter <- plot_ly(disab_type_age_tp,
                                       x = ~ age_new,
                                       y = ~ age_disab_type_pct_age,
                                       color = ~ disability,
                                       name = ~ disability,
                                       legendgroup = ~ disability,
                                       showlegend = F,
                                       text = ~ glue("Percent of age-group 
  with a disability: {age_disab_type_pct_disab}%
  Percent population: {age_disab_type_pct_pop}%"),
  type = "scatter",
  mode = "line+marker") %>%
  layout(xaxis = list(title = "Age"),
         yaxis = list(title = "Total residents"),
         title = "Takoma Park disability by age and type") %>%
  subplot_title("Percent age group")

plot_disab_type_age_pct_disab <- plot_ly(disab_type_age_tp,
                                         x = ~ age_new,
                                         y = ~ age_disab_type_pct_disab,
                                         color = ~ disability,
                                         # text = ~ glue("{age_disab_type_pct_disab}%"),
                                         # textposition = "inside",
                                         name = ~ disability,
                                         legendgroup = ~ disability,
                                         # textfont = list(color = "black"),
                                         showlegend = F,
                                         hovertext = ~ glue("Total: {age_disab_type_est}
  Percent population: {age_disab_type_pct_pop}%"),
  type = "bar",
  mode = "line+marker") %>%
  layout(xaxis = list(title = "Age"),
         # barmode = "stack",
         yaxis = list(title = "Total residents"),
         title = "Takoma Park disability by age and type") %>%
  subplot_title("Percent of persons with disability\nin age-group")

plots_disab_type_age_subs <- subplot(
  plot_disab_type_age,
  plot_disab_type_age_scatter,
  plot_disab_type_age_pct_disab,
  shareX = T,
  nrows = 3
)

pull_disab_age_type <- pull_creator(disab_type_age_tp, c("age_new", "disability"))

pull_disab_ambulatory_75_pct <- pull_disab_age_type(c("75+", "Ambulatory"), "age_disab_type_pct_age")

pull_disab_ambulatory_75_pct <- pull_disab_age_type(c("75+", "Ambulatory"), "age_disab_type_pct_age")

pull_disab_ambulatory_517_pct <- pull_disab_age_type(c("5-17", "Ambulatory"), "age_disab_type_pct_age")


pull_disab_cognitive_1834_pct <- pull_disab_age_type(c("18-34", "Cognitive"), "age_disab_type_pct_age")

pull_disab_cognitive_1834_disab <- pull_disab_age_type(c("18-34", "Cognitive"), "age_disab_type_pct_disab")

pull_disab_cognitive_6574_disab <- pull_disab_age_type(c("65-74", "Cognitive"), "age_disab_type_pct_disab")



pull_disab_cognitive_75_pct <- pull_disab_age_type(c("75+", "Cognitive"), "age_disab_type_pct_age")

pull_disab_cognitive_75_disab <- pull_disab_age_type(c("75+", "Cognitive"), "age_disab_type_pct_disab")


pull_disab_selfcare_517_pct <- pull_disab_age_type(c("5-17", "self-care"), "age_disab_type_pct_age")

pull_disab_selfcare_75_pct <- pull_disab_age_type(c("75", "self-care"), "age_disab_type_pct_age")



```

```{r disab type sex}

# disab_type_sex <- data_binder("disab_sex_type") %>%
#   name_num_formatter() %>%
#   signif_compare(sex, "Female", join_col = c(name, disability), sex_disability_type_pct_sex, pct_moe_sex)
# 
# plot_ly(disab_type_sex %>%
#           filter(grepl("Maryland", location)),
#         x = ~ disability,
#         y = ~ sex_disability_type_pct_sex,
#         name = ~ sex,
#         color = ~ sex,
#         text = ~ glue("Significant differences: {signif_female}"),
#         type = "bar")

```

```{r ancestry}

# ancestry_overall$ancestry %>%
#   unique

ancestry_overall <- data_binder("ancestry_overall") %>%  
  name_num_formatter() %>%
  ancestry_recode(ancestry)

ancestry_overall_tp <- ancestry_overall %>%
  filter(grepl("Takoma", name))

ancestry_overall_tp_process <- ancestry_overall_tp %>%
  filter(estimate >= 50)

ancestry_overall_tp_less1 <- ancestry_overall_tp %>%
  filter(pct_ancestry < 50)

ancestry_sub <- data_binder("ancestry_sub") %>%  
  name_num_formatter() %>%
  ancestry_recode(ancestry)

ancestry_sub_tp <- ancestry_sub %>%
  filter(grepl("Takoma", name))

ancestry_sub_tp_process <- ancestry_sub_tp %>%
  filter(estimate >= 50)

pull_num_ancestrygrps <- ancestry_overall_tp_process %>%
  pull(ancestry_new) %>%
  unique %>%
  length

pull_num_ancestrygrps_total <- ancestry_overall_tp %>%
  pull(ancestry_new) %>%
  unique %>%
  length

pull_ancestry_overall <- pull_creator(ancestry_overall_tp_process, c("ancestry_new"))

pull_ssa <- pull_ancestry_overall("sub-Saharan", "estimate")

pull_ssa_pct <- pull_ancestry_overall("sub-Saharan", "pct_ancestry")

pull_german <- pull_ancestry_overall("German", "estimate")

pull_german_pct <- pull_ancestry_overall("German", "pct_ancestry")

pull_english <- pull_ancestry_overall("english", "estimate")

pull_english_pct <- pull_ancestry_overall("english", "pct_ancestry")

pull_westindian <- pull_ancestry_overall("west indian", "estimate")

pull_westindian_pct <- pull_ancestry_overall("west indian", "pct_ancestry")


pull_ancestry_sub <- pull_creator(ancestry_sub_tp, c("country"))

pull_ethiopian <- pull_ancestry_sub("Ethiopian", "estimate")

pull_ethiopian_pct <- pull_ancestry_sub("Ethiopian", "pct_country")

pull_nigeria <- pull_ancestry_sub("nigeria", "estimate")

pull_nigeria_pct <- pull_ancestry_sub("nigeria", "pct_country")


pull_haiti <- pull_ancestry_sub("haiti", "estimate")

pull_haiti_pct <- pull_ancestry_sub("haiti", "pct_country")


pull_jamaica <- pull_ancestry_sub("jamaica", "estimate")

pull_jamaica_pct <- pull_ancestry_sub("jamaica", "pct_country")


pull_jordan_tot <- pull_ancestry_sub("Jordanian", "estimate")

```


```{r gen pltos ancestry}

plot_ancestry_sub <- plot_ly(ancestry_sub_tp_process,
                             x = ~ ancestry_new,
                             name = ~ country,
                             y = ~ estimate,
                             text = ~ glue("{country}:\n{estimate}"),
                             textposition = "inside",
                             textfont = list(color = "black"),
                             hovertext = ~ glue("Percent: {pct_country}%s
                           Margin of error: {moe %>% commafy}"),
                           color = ~ country) %>%
  layout(barmode = "stack",
         yaxis = list(title = "Total"),
         xaxis = list(title = "Ancestry-group"),
         title = "Ancestry by subgroup")

# plot_ly(ancestry_overall_tp_process,
#         x = ~ ancestry_new,
#         y = ~ estimate,
#         name = ~ ancestry,
#         type = "bar",
#         color = ~ ancestry)


plot_ancestry_overall <- plot_ly(ancestry_overall_tp_process,
                                 y = ~ ancestry_new,
                                 orientation = "h",
                                 x = ~ estimate,
                                 hovertext = ~ glue("Percent: {pct_ancestry}%
                           Margin of error: {moe}"),
                           showlegend = T,
                           name = ~ ancestry_new,
                           type = "bar",
                           color = ~ ancestry_new) %>%
  layout(yaxis = list(tickfont = list(size = 10),
                      title = ""),
         xaxis = list(title = "Total"),
         title = "Population by ancestry")

# plot_ly(ancestry_overall_tp_process,
#         # labels = ~ ancestry_new,
#                 textposition = 'inside',
#         textinfo = 'label+percent',
#         hole = 0.4,
#         # orientation = "h",
#         values = ~ estimate,
#         labels = ~ ancestry_new,
#         type = "pie")


```



```{r education plot}

educ_overall <- data_binder("educ_overall") %>%
  name_formatter() %>%
  num_formatter() %>%
  educ_recode(education) %>%
  signif_mont_tp(c("education"), percent_pop, pct_moe) %>%
  signif_checker(list("MC" = "signif_mont",
                      "MD" = "signif_maryland"))

mont_educ_data <- educ_overall %>%
  filter(grepl("Montgomery", location))

maryland_educ_overall <- educ_overall %>%
  filter(grepl("Maryland", location))

takoma_educ_overall <- educ_overall %>%
  filter(grepl("Takoma", location))

pull_educ_place <- pull_creator(educ_overall, c("name", "education"))

pull_tp_graduate <- pull_educ_place(c("Takoma", "Professional"), "percent_pop")

pull_tp_lesshs <- pull_educ_place(c("Takoma", "less than"), "percent_pop")

pull_md_lesshs <- pull_educ_place(c("^Maryland$", "less than"), "percent_pop")

pull_mont_lesshs <- pull_educ_place(c("Mont", "less than"), "percent_pop")


pull_tp_hs <- pull_educ_place(c("Takoma", "equivalency"), "percent_pop")

pull_md_hs <- pull_educ_place(c("^Maryland$", "equivalency"), "percent_pop")


pull_tp_bachelor <- pull_educ_place(c("Takoma", "Bachelor"), "percent_pop")

pull_mont_graduate <- pull_educ_place(c("Montgomery", "Professional"), "percent_pop")

pull_mont_hs <- pull_educ_place(c("Montgomery", "equivalency"), "percent_pop")

pull_mont_bachelor <- pull_educ_place(c("Montgomery", "Bachelor"), "percent_pop")

pull_md_graduate <- pull_educ_place(c("^Maryland$", "Professional"), "percent_pop")

pull_md_hs <- pull_educ_place(c("^Maryland$", "equivalency"), "percent_pop")

pull_md_bachelor <- pull_educ_place(c("^Maryland$", "Bachelor"), "percent_pop")

```


```{r computer access}

comp_age <- data_binder("computer_age") %>%
  name_num_formatter() %>%
  age_recode(age, regroup = F) %>%
  comp_recode(comp, int) %>%
  est_moe_derive(c("name", "age_new", "comp_int"), name_col = "comp_int") %>%
  select(name, location, pop_tot, pop_tot_moe, age_new, age_tot, age_tot_moe, comp_int, comp_int_est, comp_int_moe) %>%
  distinct() %>%
  derive_pct_est_moe("pct_comp_int", 
                     "age_tot",
                     "age_tot_moe",
                     "comp_int_est",
                     "comp_int_moe") %>%
  name_num_formatter()

comp_age <- comp_age %>%
  ungroup %>%
  group_by(name, age_new) %>%
  arrange(desc(comp_int)) %>%
  mutate(cumul_pct = cumsum(pct_comp_int)) %>%
  rename(estimate = comp_int_est, 
         moe = comp_int_moe) 

comp_age <- comp_age %>%
  signif_mont_tp(c("age_new", "comp_int"), name_pct = pct_comp_int, moe_pct = pct_moe) %>%
  signif_overall(comp_age, group_cols = c("comp_int"), est_col = pct_comp_int, pct_moe) %>%
  signif_checker()

comp <- data_binder("computer_age") %>%
  name_num_formatter() %>%
  age_recode(age, regroup = F) %>%
  comp_recode(comp, int) %>%
  est_moe_derive(c("name", "comp_int"), name_col = "comp_int") %>%
  select(name, location, pop_tot, pop_tot_moe, comp_int, comp_int_est, comp_int_moe) %>%
  distinct() %>%
  derive_pct_est_moe("pct_comp_int", 
                     "pop_tot",
                     "pop_tot_moe",
                     "comp_int_est",
                     "comp_int_moe") %>%
  name_num_formatter() %>%
  rename(estimate = comp_int_est,
         moe = comp_int_moe) %>%
  signif_mont_tp(c("comp_int"), pct_comp_int) %>%
  signif_checker(list("MC" = "signif_mont",
                      "MD" = "signif_maryland"))


pull_comp <- pull_creator(comp, c("name", "comp_int"))

pull_tp_noint <- pull_comp(c("Takoma", "No internet"), "pct_comp_int")

pull_mont_noint <- pull_comp(c("Montgome", "No internet"), "pct_comp_int")

pull_tp_noint_tot <- pull_comp(c("Takoma", "No internet"), "estimate")


pull_tp_nocomp <- pull_comp(c("Takoma", "No computer"), "pct_comp_int")

pull_mont_nocomp <- pull_comp(c("Montgome", "No computer"), "pct_comp_int")

pull_mont_broadband <- pull_comp(c("Montgome", "Broadband"), "pct_comp_int")

pull_tp_broadband <- pull_comp(c("Takoma Park", "Broadband"), "pct_comp_int")



pull_tp_nocomp_tot <- pull_comp(c("Takoma", "No computer"), "estimate")


```


```{r health insurance age overall}

health_insur_age <- data_binder("health_age_processed") %>%
  name_num_formatter() %>%
  age_recode(age, regroup = F)

health_insur_overall <- health_insur_age %>%
  health_insur_recode(num = num_plans, type_coverage) %>%
  est_moe_derive(group_cols = c("name", "health_new"), name_col = "health") %>%
  select(name, location, total, total_moe, health_new, health_est, health_moe) %>%
  distinct() %>%
  derive_pct_est_moe("pct_health",
                     "total",
                     "total_moe",
                     "health_est",
                     "health_moe") %>%
  name_num_formatter() %>%
  signif_mont_tp(join_col = c("health_new"), name_pct = pct_health, moe_pct = pct_moe) %>%
  signif_checker(list("MC" = "signif_mont",
                      "MD" = "signif_maryland"))

pull_health <- pull_creator(health_insur_overall, c("name", "health_new"))

pull_tp_noinsur <- pull_health(c("Takoma", "No insur"), "pct_health")

pull_tp_noinsur_tot <- pull_health(c("Takoma", "No insur"), "health_est")

pull_mont_noinsur <- pull_health(c("Montgo", "No insur"), "pct_health")

pull_md_noinsur <- pull_health(c("^Maryland", "No insur"), "pct_health")


pull_tp_medicaid <- pull_health(c("Takoma", "means-tested"), "pct_health")

pull_tp_medicaid_tot <- pull_health(c("Takoma", "means-tested"), "health_est")

pull_mont_medicaid <- pull_health(c("Montgo", "means-tested"), "pct_health")

pull_md_medicaid <- pull_health(c("^Maryland", "means-tested"), "pct_health")


pull_tp_medicaidmedicare <- pull_health(c("Takoma", "Medicaid and Medicare"), "pct_health")

pull_tp_medicaidmedicare_tot <- pull_health(c("Takoma", "Medicaid and Medicare"), "health_est")

pull_mont_medicaidmedicare <- pull_health(c("Montgo", "Medicaid and Medicare"), "pct_health")

pull_md_medicaidmedicare <- pull_health(c("^Maryland", "Medicaid and Medicare"), "pct_health")

```


```{r education by race, echo=FALSE}
educ_race_data <- data_binder("educ_race_df_overall") %>%
  name_formatter() %>%
  num_formatter() %>%
  race_recode(race) %>%
  educ_recode(education)

educ_race_data_processed <- educ_race_data %>%
  filter(!(race %in% tp_race_cats)) %>%
  mutate(race = factor(race, unique(.$race), unique(.$race))) %>%
  rename(estimate = name_race_education_est,
         moe = name_race_education_moe) %>%
  ungroup %>%
  signif_mont_tp(c("race", "educ_recode"), race_education_pct, pct_moe) %>%
  signif_overall(educ_race_data %>% filter(!grepl("hispanic", race)) %>%
                   rename(estimate = name_race_education_est,
                          moe = name_race_education_moe), group_cols = c("location", "educ_recode"), est_col = race_education_pct, pct_moe, bind_overall = "race") %>%
  signif_compare(race, "white", c("location", "educ_recode"), race_education_pct, pct_moe) %>%
  signif_checker(list("Overall" = "signif_overall",
                      "White" = "signif_white",
                      "MC" = "signif_mont",
                      "MD" = "signif_maryland")) %>%
  group_by(location, race) %>%
  mutate(cumul_pct = cumsum(race_education_pct))

educ_black <- educ_race_data_processed %>%
  filter(grepl("Black", race))

educ_white <- educ_race_data_processed %>%
  filter(grepl("White", race))

educ_hisp <- educ_race_data_processed %>%
  filter(grepl("^Hisp", race))

educ_other <- educ_race_data_processed %>%
  filter(grepl("Other", race))

tp_educ_race_data <- educ_race_data_processed %>%
  filter(grepl("Takoma", location) & (race_total > 30 | race == "Overall")) %>%
  mutate(race = factor(race, unique(.$race), unique(.$race))) %>%
  group_by(race) %>%
  mutate(cumul_pct = cumsum(race_education_pct))

tp_races <- tp_educ_race_data %>%
  pull(race)

pull_educ_race_data <- pull_creator(educ_race_data, c("name", "race", "education"))

pull_tp_hisp_lesshs <- pull_educ_race_data(c("Takoma", "Hispanic", "Less than"), "race_education_pct")

pull_md_hisp_lesshs <- pull_educ_race_data(c("^Maryland", "Hispanic", "Less than"), "race_education_pct")

pull_mont_hisp_lesshs <- pull_educ_race_data(c("Montgomery", "Hispanic", "Less than"), "race_education_pct")


pull_tp_white_lesshs <- pull_educ_race_data(c("Takoma", "White", "Less than"), "race_education_pct")

pull_tp_black_lesshs <- pull_educ_race_data(c("Takoma", "black", "Less than"), "race_education_pct")
pull_tp_black_hs <- pull_educ_race_data(c("Takoma", "black", "equivalency"), "race_education_pct")

pull_tp_white_hs <- pull_educ_race_data(c("Takoma", "white", "equivalency"), "race_education_pct")
pull_tp_other_lesshs <- pull_educ_race_data(c("Takoma", "other", "Less than"), "race_education_pct")

other_race_educ <- tp_educ_race_data %>%
  filter(race == "Other" & grepl("Takoma", name) & grepl("Less than", education))

pull_other_race_educ_moe <- other_race_educ %>%
  pull(pct_moe)

pull_other_race_educ_pctupper <- other_race_educ %>%
  pull(pct_upper)

pull_other_race_educ_pctlower <- other_race_educ %>%
  pull(pct_lower)


pull_tp_hisp_lesshs_tot <- pull_educ_race_data(c("Takoma", "Hispanic", "Less than"), "name_race_education_est")

pull_tp_white_lesshs_tot <- pull_educ_race_data(c("Takoma", "White", "Less than"), "name_race_education_est")

pull_tp_black_lesshs_tot <- pull_educ_race_data(c("Takoma", "black", "Less than"), "name_race_education_est")
pull_tp_black_hs_tot <- pull_educ_race_data(c("Takoma", "black", "equivalency"), "name_race_education_est")
pull_tp_white_hs_tot <- pull_educ_race_data(c("Takoma", "white", "equivalency"), "name_race_education_est")
pull_tp_other_lesshs_tot <- pull_educ_race_data(c("Takoma", "other", "Less than"), "name_race_education_est")


other_race_educ <- tp_educ_race_data %>%
  filter(race == "Other" & grepl("Takoma", name) & grepl("Less than", education))

pull_other_race_educ_moe <- other_race_educ %>%
  pull(pct_moe)

pull_other_race_educ_pctupper <- other_race_educ %>%
  pull(pct_upper)

pull_other_race_educ_pctlower <- other_race_educ %>%
  pull(pct_lower)


pull_mont_hisp_lesshs <- pull_educ_race_data(c("Montgomery", "Hispanic", "Less than"), "race_education_pct")

pull_mont_white_lesshs <- pull_educ_race_data(c("Montgomery", "White", "Less than"), "race_education_pct")

pull_mont_black_lesshs <- pull_educ_race_data(c("Montgomery", "black", "Less than"), "race_education_pct")
pull_mont_black_hs <- pull_educ_race_data(c("Montgomery", "black", "equivalency"), "race_education_pct")

pull_mont_white_hs <- pull_educ_race_data(c("Montgomery", "white", "equivalency"), "race_education_pct")
pull_mont_other_lesshs <- pull_educ_race_data(c("Montgomery", "other", "Less than"), "race_education_pct")



pull_md_hisp_lesshs <- pull_educ_race_data(c("^Maryland", "Hispanic", "Less than"), "race_education_pct")

pull_md_white_lesshs <- pull_educ_race_data(c("^Maryland", "White", "Less than"), "race_education_pct")

pull_md_black_lesshs <- pull_educ_race_data(c("^Maryland", "black", "Less than"), "race_education_pct")
pull_md_black_hs <- pull_educ_race_data(c("^Maryland", "black", "equivalency"), "race_education_pct")

pull_md_white_hs <- pull_educ_race_data(c("^Maryland", "white", "equivalency"), "race_education_pct")
pull_md_other_lesshs <- pull_educ_race_data(c("^Maryland", "other", "Less than"), "race_education_pct")



pull_tp_white_bachelor <- pull_educ_race_data(c("Takoma", "White", "Bachelor"), "race_education_pct")

pull_tp_asian_bachelor <- pull_educ_race_data(c("Takoma", "asian", "Bachelor"), "race_education_pct")



pull_mont_white_bachelor <- pull_educ_race_data(c("Montgomery", "White", "Bachelor"), "race_education_pct")

pull_md_white_bachelor <- pull_educ_race_data(c("^Maryland", "White", "Bachelor"), "race_education_pct")


```


```{r computer access race}

# read in ddata
comp_race_bare <- data_binder("comp_race") %>%
  rename_all(tolower) %>%
  name_num_formatter() %>%
  mutate(race = ifelse(grepl("presence of a computer and type of", race), "Overall", race)) %>%
  filter(race != "Overall") %>%
  acsprocess::comp_recode(comp_col = comp_access, int_col = int_type)

comp_race_root <- comp_race_bare %>%
  filter(!grepl("hispanic", race, ignore.case = T))

comp_race <- comp_race_bare %>%
  filter(race != "white alone") %>%
  signif_mont_tp(c("race", "comp_int"), name_pct = percent_race, pct_moe) %>%
  signif_overall(comp_race_bare, c("location", "comp_int"), percent_race, pct_moe, "race") %>% 
  race_recode(race) %>%
  signif_compare(race, "white", c("location", "comp_int"), est_col = percent_race, pct_moe) %>%
  signif_checker(list("Overall" = "signif_overall",
                      "White" = "signif_white",
                      "MC" = "signif_mont",
                      "MD" = "signif_maryland")) %>%
  mutate(percent_race = round(percent_race, 2))  %>%
  filter(!race %in% tp_race_cats) %>%
  mutate(race = factor(race, .$race, .$race))

comp_race_tp <- comp_race %>%
  filter(grepl("Takoma", name))

comp_race_tp_write <- comp_race_tp %>%
  select(race, tot_people, comp_int, estimate, percent_race) %>%
  rename("Race" = race,
         "Race population" = tot_people,
         "Computer/internet access" = comp_int,
         "Race/computer/internet total" = estimate,
         "Race/computer/internet percent" = percent_race)

openxlsx::write.xlsx(comp_race_tp_write, 
                     "./data/output_data/comp_race_tp_write.xlsx", asTable = T)

pull_race_comp <- pull_creator(comp_race, c("name", "race", "comp_int"))

pull_tp_black_noint <- pull_race_comp(c("Takoma", "Black", "No internet"), "percent_race")

pull_tp_hispanic_noint <- pull_race_comp(c("Takoma", "hispanic", "No internet"), "percent_race")

pull_tp_other_noint <- pull_race_comp(c("Takoma", "other", "No internet"), "percent_race")

pull_tp_white_noint <- pull_race_comp(c("Takoma", "white", "No internet"), "percent_race")


pull_tp_black_noint_tot <- pull_race_comp(c("Takoma", "Black", "No internet"), "tot_comp")

pull_tp_hispanic_noint_tot <- pull_race_comp(c("Takoma", "hispanic", "No internet"), "tot_comp")

pull_tp_other_noint_tot <- pull_race_comp(c("Takoma", "other", "No internet"), "tot_comp")

pull_tp_white_noint_tot <- pull_race_comp(c("Takoma", "white", "No internet"), "tot_comp")



pull_tp_hispanic_nocomp <- pull_race_comp(c("Takoma", "hispanic", "No computer"), "percent_race")

pull_tp_other_nocomp <- pull_race_comp(c("Takoma", "other", "No computer"), "percent_race")


pull_tp_hispanic_nocomp_tot <- pull_race_comp(c("Takoma", "hispanic", "No computer"), "tot_comp")

pull_tp_other_nocomp_tot <- pull_race_comp(c("Takoma", "other", "No computer"), "tot_comp")


pull_tp_black_nocomp <- pull_race_comp(c("Takoma", "black", "No computer"), "percent_race")

pull_tp_black_nocomp_tot <- pull_race_comp(c("Takoma", "black", "No computer"), "tot_comp")



pull_tp_other_nocomp <- pull_race_comp(c("Takoma", "other", "No computer"), "percent_race")

pull_tp_black_broad <- pull_race_comp(c("Takoma", "Black", "broadband"), "percent_race")

pull_tp_hispanic_broad <- pull_race_comp(c("Takoma", "hispanic", "broadband"), "percent_race")

pull_tp_other_broad <- pull_race_comp(c("Takoma", "other", "broadband"), "percent_race")


pull_tp_other_broad_upper <- pull_race_comp(c("Takoma", "other", "broadband"), "pct_upper")

pull_tp_other_broad_lower <- pull_race_comp(c("Takoma", "other", "broadband"), "pct_lower")


pull_tp_white_broad <- pull_race_comp(c("Takoma", "white", "broadband"), "percent_race")

pull_tp_asian_broad <- pull_race_comp(c("Takoma", "asian", "broadband"), "percent_race")



pull_tp_other_nocomp_tot <- pull_race_comp(c("Takoma", "other", "No computer"), "tot_comp")

pull_tp_black_broad_tot <- pull_race_comp(c("Takoma", "Black", "broadband"), "tot_comp")

pull_tp_hispanic_broad_tot <- pull_race_comp(c("Takoma", "hispanic", "broadband"), "tot_comp")

pull_tp_other_broad_tot <- pull_race_comp(c("Takoma", "other", "broadband"), "tot_comp")

pull_tp_white_broad_tot <- pull_race_comp(c("Takoma", "white", "broadband"), "tot_comp")

pull_tp_asian_broad_tot <- pull_race_comp(c("Takoma", "asian", "broadband"), "tot_comp")



pull_mont_black_noint <- pull_race_comp(c("Montgomery", "Black", "No internet"), "percent_race")

pull_mont_hispanic_noint <- pull_race_comp(c("Montgomery", "hispanic", "No internet"), "percent_race")

pull_mont_other_noint <- pull_race_comp(c("Montgomery", "other", "No internet"), "percent_race")

pull_mont_white_noint <- pull_race_comp(c("Montgomery", "white", "No internet"), "percent_race")


pull_mont_hispanic_nocomp <- pull_race_comp(c("Montgomery", "hispanic", "No computer"), "percent_race")

pull_mont_other_nocomp <- pull_race_comp(c("Montgomery", "other", "No computer"), "percent_race")


pull_mont_hispanic_nocomp <- pull_race_comp(c("Montgomery", "hispanic", "No computer"), "percent_race")

pull_mont_other_nocomp <- pull_race_comp(c("Montgomery", "other", "No computer"), "percent_race")

pull_mont_black_broad <- pull_race_comp(c("Montgomery", "Black", "broadband"), "percent_race")

pull_mont_hispanic_broad <- pull_race_comp(c("Montgomery", "hispanic", "broadband"), "percent_race")

pull_mont_other_broad <- pull_race_comp(c("Montgomery", "other", "broadband"), "percent_race")

pull_mont_white_broad <- pull_race_comp(c("Montgomery", "white", "broadband"), "percent_race")

pull_mont_asian_broad <- pull_race_comp(c("Montgomery", "asian", "broadband"), "percent_race")



pull_md_black_noint <- pull_race_comp(c("^Maryland$", "Black", "No internet"), "percent_race")

pull_md_hispanic_noint <- pull_race_comp(c("^Maryland$", "hispanic", "No internet"), "percent_race")

pull_md_other_noint <- pull_race_comp(c("^Maryland$", "other", "No internet"), "percent_race")

pull_md_white_noint <- pull_race_comp(c("^Maryland$", "white", "No internet"), "percent_race")


pull_md_hispanic_nocomp <- pull_race_comp(c("^Maryland$", "hispanic", "No computer"), "percent_race")

pull_md_other_nocomp <- pull_race_comp(c("^Maryland$", "other", "No computer"), "percent_race")


pull_md_hispanic_nocomp <- pull_race_comp(c("^Maryland$", "hispanic", "No computer"), "percent_race")

pull_md_other_nocomp <- pull_race_comp(c("^Maryland$", "other", "No computer"), "percent_race")

pull_md_black_broad <- pull_race_comp(c("^Maryland$", "Black", "broadband"), "percent_race")

pull_md_hispanic_broad <- pull_race_comp(c("^Maryland$", "hispanic", "broadband"), "percent_race")

pull_md_other_broad <- pull_race_comp(c("^Maryland$", "other", "broadband"), "percent_race")

pull_md_white_broad <- pull_race_comp(c("^Maryland$", "white", "broadband"), "percent_race")

pull_md_asian_broad <- pull_race_comp(c("^Maryland$", "asian", "broadband"), "percent_race")


comp_race_black <- comp_race %>%
  filter(grepl("Black", race)) %>%
  filter(!grepl("Broadband", comp_int))

comp_race_hispanic <- comp_race %>%
  filter(grepl("Hispanic", race)) %>%
  filter(!grepl("Broadband", comp_int))


comp_race_white <- comp_race %>%
  filter(grepl("White", race)) %>%
  filter(!grepl("Broadband", comp_int))


comp_race_other <- comp_race %>%
  filter(grepl("Other", race)) %>%
  filter(!grepl("Broadband", comp_int))


comp_race_asian <- comp_race %>%
  filter(grepl("Asian", race))%>%
  filter(!grepl("Broadband", comp_int))

range_def <- c(0, (comp_race %>%
                     filter(!grepl("Broadband", comp_int)) %>%
                     pull(percent_race) %>%
                     max() %>% 
                     round) + 4)

sub_gen_comp_race <- function(df, title, showleg = F){
  race_breakout_gen(df, title = title, x = "comp_int", y = "percent_race", name = "location", show_legend = showleg, type = "bar", range = range_def, ytick = 5)
}

sub_comp_race_black <- sub_gen_comp_race(comp_race_black, title = "Black", T)

sub_comp_race_hispanic <- sub_gen_comp_race(comp_race_hispanic, title = "Hispanic")

sub_comp_race_white <- sub_gen_comp_race(comp_race_white, title = "White")

sub_comp_race_other <- sub_gen_comp_race(comp_race_other, title = "Other")

sub_comp_race_asian <- sub_gen_comp_race(comp_race_asian, title = "Asian")


comp_race_broadband <- comp_race %>%
  filter(grepl("Broadband", comp_int))

```


```{r comp age}
pull_comp_age <- pull_creator(comp_age, c("location", "age_new", "comp_int"))

pull_broadband_under18 <- pull_comp_age(c("Takoma", "< ", "broadband"), "pct_comp_int")

pull_broadband_1865 <- pull_comp_age(c("Takoma", "18-64", "broadband"), "pct_comp_int")

pull_broadband_65 <- pull_comp_age(c("Takoma", "65", "broadband"), "pct_comp_int")

pull_comp_under18 <- pull_comp_age(c("Takoma", "< ", "computer"), "pct_comp_int")

pull_comp_1865 <- pull_comp_age(c("Takoma", "65", "computer"), "pct_comp_int")

pull_comp_65 <- pull_comp_age(c("Takoma", "65", "computer"), "pct_comp_int")

pull_noint_under18 <- pull_comp_age(c("Takoma", "< ", "No internet"), "pct_comp_int")

pull_noint_1865 <- pull_comp_age(c("Takoma", "18-64", "No internet"), "pct_comp_int")

pull_noint_65 <- pull_comp_age(c("Takoma", "65", "No internet"), "pct_comp_int")



pull_broadband_under18_mont <- pull_comp_age(c("Montgomery", "< ", "broadband"), "pct_comp_int")

pull_broadband_1865_mont <- pull_comp_age(c("Montgomery", "18-64", "broadband"), "pct_comp_int")

pull_broadband_65_mont <- pull_comp_age(c("Montgomery", "65", "broadband"), "pct_comp_int")

pull_comp_under18_mont <- pull_comp_age(c("Montgomery", "< ", "computer"), "pct_comp_int")

pull_comp_1865_mont <- pull_comp_age(c("Montgomery", "65", "computer"), "pct_comp_int")

pull_comp_65_mont <- pull_comp_age(c("Montgomery", "65", "computer"), "pct_comp_int")

pull_noint_under18_mont <- pull_comp_age(c("Montgomery", "< ", "No internet"), "pct_comp_int")

pull_noint_1865_mont <- pull_comp_age(c("Montgomery", "18-64", "No internet"), "pct_comp_int")

pull_noint_65_mont <- pull_comp_age(c("Montgomery", "65", "No internet"), "pct_comp_int")



```

```{r health insurance age}

health_insur_age_process <- health_insur_age %>%
  health_insur_recode(num = num_plans, type_coverage) %>%
  est_moe_derive(group_cols = c("name", "age_new", "health_new"), name_col = "health") %>%
  select(name, location, total, total_moe, age_new, age_total, age_total_moe, health_new, health_est, health_moe) %>%
  distinct() %>%
  derive_pct_est_moe("pct_health",
                     "age_total",
                     "age_total_moe",
                     "health_est",
                     "health_moe") %>%
  name_num_formatter()   %>%
  rename(estimate = health_est,
         moe= health_moe) 

health_insur_age_process <- health_insur_age_process%>%
  signif_mont_tp(join_col = c("age_new", "health_new"), name_pct = pct_health, pct_moe) %>%
  signif_overall(health_insur_age_process, group_cols = c("location", "health_new"), pct_health, pct_moe, bind_overall = "age_new") %>%
  signif_checker()


types_concern <- health_insur_age_process$health_new %>%
  unique %>%
  levels

types_concern <- types_concern[6:8]


pull_heath_age <- pull_creator(health_insur_age_process %>%
                                 filter(health_new %in% types_concern), c("name", "age_new", "health_new"))

pull_means_under18_tot <- pull_heath_age(c("Takoma", "< 19", "medicaid"), "estimate") %>%   sum

pull_means_under18_pct <- pull_heath_age(c("Takoma", "< 19", "medicaid"), "pct_health") %>%   sum

pull_none_under18_tot <- pull_heath_age(c("Takoma", "< 19", "no insur"), "estimate") %>%   sum

pull_none_under18_pct <- pull_heath_age(c("Takoma", "< 19", "no insur"), "pct_health") %>%   sum


pull_means_1934_tot <- pull_heath_age(c("Takoma", "19-34", "medicaid"), "estimate") %>%   sum

pull_means_1934_pct <- pull_heath_age(c("Takoma", "19-34", "medicaid"), "pct_health") %>%   sum

pull_none_1934_tot <- pull_heath_age(c("Takoma", "19-34", "no insur"), "estimate") %>%   sum

pull_none_1934_pct <- pull_heath_age(c("Takoma", "19-34", "no insur"), "pct_health") %>%   sum


pull_means_3564_tot <- pull_heath_age(c("Takoma", "35-64", "medicaid"), "estimate") %>%   sum

pull_means_3564_pct <- pull_heath_age(c("Takoma", "35-64", "medicaid"), "pct_health") %>%   sum

pull_none_3564_tot <- pull_heath_age(c("Takoma", "35-64", "no insur"), "estimate") %>%   sum

pull_none_3564_pct <- pull_heath_age(c("Takoma", "35-64", "no insur"), "pct_health") %>%   sum


pull_means_65_tot <- pull_heath_age(c("Takoma", "65+", "medicaid"), "estimate") %>%   sum

pull_means_65_pct <- pull_heath_age(c("Takoma", "65+", "medicaid"), "pct_health") %>%   sum

pull_none_65_tot <- pull_heath_age(c("Takoma", "65+", "no insur"), "estimate") %>%   sum

pull_none_65_pct <- pull_heath_age(c("Takoma", "65+", "no insur"), "pct_health") %>%   sum


pull_means_under18_tot_mont <- pull_heath_age(c("Montgomery", "< 19", "medicaid"), "estimate") %>%   sum

pull_means_under18_pct_mont <- pull_heath_age(c("Montgomery", "< 19", "medicaid"), "pct_health") %>%   sum

pull_none_under18_tot_mont <- pull_heath_age(c("Montgomery", "< 19", "no insur"), "estimate") %>%   sum

pull_none_under18_pct_mont <- pull_heath_age(c("Montgomery", "< 19", "no insur"), "pct_health") %>%   sum


pull_means_1934_tot_mont <- pull_heath_age(c("Montgomery", "19-34", "medicaid"), "estimate") %>%   sum

pull_means_1934_pct_mont <- pull_heath_age(c("Montgomery", "19-34", "medicaid"), "pct_health") %>%   sum

pull_none_1934_tot_mont <- pull_heath_age(c("Montgomery", "19-34", "no insur"), "estimate") %>%   sum

pull_none_1934_pct_mont <- pull_heath_age(c("Montgomery", "19-34", "no insur"), "pct_health") %>%   sum


pull_means_3564_tot_mont <- pull_heath_age(c("Montgomery", "35-64", "medicaid"), "estimate") %>%   sum

pull_means_3564_pct_mont <- pull_heath_age(c("Montgomery", "35-64", "medicaid"), "pct_health") %>%   sum

pull_none_3564_tot_mont <- pull_heath_age(c("Montgomery", "35-64", "no insur"), "estimate") %>%   sum

pull_none_3564_pct_mont <- pull_heath_age(c("Montgomery", "35-64", "no insur"), "pct_health") %>%   sum


pull_means_65_tot_mont <- pull_heath_age(c("Montgomery", "65+", "medicaid"), "estimate") %>%   sum

pull_means_65_pct_mont <- pull_heath_age(c("Montgomery", "65+", "medicaid"), "pct_health") %>%   sum

pull_none_65_tot_mont <- pull_heath_age(c("Montgomery", "65+", "no insur"), "estimate") %>%   sum

pull_none_65_pct_mont <- pull_heath_age(c("Montgomery", "65+", "no insur"), "pct_health") %>%   sum




pull_means_under18_tot_md <- pull_heath_age(c("^Maryland", "< 19", "medicaid"), "estimate") %>%   sum

pull_means_under18_pct_md <- pull_heath_age(c("^Maryland", "< 19", "medicaid"), "pct_health") %>%   sum

pull_none_under18_tot_md <- pull_heath_age(c("^Maryland", "< 19", "no insur"), "estimate") %>%   sum

pull_none_under18_pct_md <- pull_heath_age(c("^Maryland", "< 19", "no insur"), "pct_health") %>%   sum


pull_means_1934_tot_md <- pull_heath_age(c("^Maryland", "19-34", "medicaid"), "estimate") %>%   sum

pull_means_1934_pct_md <- pull_heath_age(c("^Maryland", "19-34", "medicaid"), "pct_health") %>%   sum

pull_none_1934_tot_md <- pull_heath_age(c("^Maryland", "19-34", "no insur"), "estimate") %>%   sum

pull_none_1934_pct_md <- pull_heath_age(c("^Maryland", "19-34", "no insur"), "pct_health") %>%   sum


pull_means_3564_tot_md <- pull_heath_age(c("^Maryland", "35-64", "medicaid"), "estimate") %>%   sum

pull_means_3564_pct_md <- pull_heath_age(c("^Maryland", "35-64", "medicaid"), "pct_health") %>%   sum

pull_none_3564_tot_md <- pull_heath_age(c("^Maryland", "35-64", "no insur"), "estimate") %>%   sum

pull_none_3564_pct_md <- pull_heath_age(c("^Maryland", "35-64", "no insur"), "pct_health") %>%   sum


pull_means_65_tot_md <- pull_heath_age(c("^Maryland", "65+", "medicaid"), "estimate") %>%   sum

pull_means_65_pct_md <- pull_heath_age(c("^Maryland", "65+", "medicaid"), "pct_health") %>%   sum

pull_none_65_tot_md <- pull_heath_age(c("^Maryland", "65+", "no insur"), "estimate") %>%
  sum

pull_none_65_pct_md <- pull_heath_age(c("^Maryland", "65+", "no insur"), "pct_health") %>%
  sum


```


```{r text race education}

text_race_educ <- glue("**Significant racial disparities exist in educational attainment in Takoma Park, especially for Black residents, Hispanic residents, and residents with a racial categorization of 'other.'**

                               - {pull_tp_hisp_lesshs}% of the city's Hispanic residents do not have a high school diploma ({pull_tp_hisp_lesshs_tot} total) compared to {pull_tp_white_lesshs}% of the city's white population ({pull_tp_white_lesshs_tot} total). 
                               - {pull_tp_black_lesshs + pull_tp_black_hs}% of the city's Black population have a high school degree or did not complete high school ({(pull_tp_black_lesshs_tot + pull_tp_black_hs_tot) %>% commafy} total), compared to {pull_tp_white_hs + pull_tp_white_lesshs}% of the city's white population ({pull_tp_white_hs_tot + pull_tp_white_lesshs_tot} total). 
                               - {pull_tp_other_lesshs}% of residents with a race of 'other' do not have a high school diploma ({pull_tp_other_lesshs_tot} total); the low number of residents with a race of 'other' and the margin of error of {pull_other_race_educ_moe}% (meaning the actual percentage of residents without a high school degree could be between {pull_other_race_educ_pctlower}% and {pull_other_race_educ_pctupper}%) suggest some caution in interpreting this result, but even the lower bound of {pull_other_race_educ_pctlower}% or residents without a high school diploma would exceed all other groups except for Hispanic residents.
                               - Educational attainment for Asian residents exceeds the City's overall rate and are similar to white residents through high school, but a lower share of Asian residents have a bachelor's degree than white residents at {pull_tp_asian_bachelor}% compared to {pull_tp_white_bachelor}%.")


text_race_educ_summary <- glue("**There are significant gaps in educational attainment by race in Takoma Park, exceeding disparities in the County and state.** {pull_tp_other_lesshs}% of residents with a race of 'other' and {pull_tp_hisp_lesshs}% of the city's Hispanic residents do not have a high school diploma compared to {pull_tp_white_lesshs}% of the city's white residents, and {pull_tp_black_lesshs + pull_tp_black_hs}% of the city's Black population have a high school degree or did not complete high school compared to {pull_tp_white_hs + pull_tp_white_lesshs}% of the city's white residents.")


```


```{r plot educ by race}
# plot_ly(data = tp_educ_race_data,
#         type = "bar",
#         x = ~ race,
#         y = ~ race_education_pct,
#         name = ~ education,
#         color = ~ education,
#         error_y = list(array = ~ pct_moe)) %>%
#         layout(yaxis = list(range = c(0, 85)))

plot_race_educ <- plot_ly(data = tp_educ_race_data %>% num_formatter() %>% race_factor(),
                          type = "scatter",
                          mode = "lines+markers",
                          # orientation = "h",
                          x = ~ educ_recode,
                          y = ~ cumul_pct,
                          name = ~ race,
                          hovertext = ~ glue("Group-percent: {race_education_pct}%
                           Group-total: {estimate}
                           Margin of error: {pct_moe}%
                           Group-significant differences: {signif_check}"),
                          color = ~ race,
                          colors = ~ pal_race) %>%
  # error_y = list(array = ~ pct_moe,
  #                color = '#ADADAD')) %>%
  layout(yaxis = list(title = list(text = "Cumulative percent",
                                   standoff = 0.1)),
         # range = c(0, 100)),
         xaxis = list(title = ""),
         title = "Takoma Park cumulative percent of race by highest-educational attainment")
# legend = list(orientation = "h",
#               xanchor = "center",
#               x = 0.5))



```

```{r text race educ comparison}
text_race_educ_compare <- glue("**Comparing racial/ethnic groups with educational disparities in Takoma Park to the same groups in Montgomery County and Maryland overall reveal higher disparities in Takoma Park than the region and state.** The proportion of Hispanic residents without a high school degree in Takoma Park exceeds Maryland and Montgomery County by {pull_tp_hisp_lesshs- pull_md_hisp_lesshs}% and { pull_tp_hisp_lesshs- pull_mont_hisp_lesshs}% respectively. The share of Black residents without any college education is similar to the state's, but exceeds the county's by {pull_tp_black_lesshs + pull_tp_black_hs - pull_mont_black_lesshs - pull_mont_black_hs}%. And although the large margin of error warrants caution, the share of residents with a race of 'other' without a high school degree exceeds Montgomery County's by {pull_tp_other_lesshs - pull_mont_other_lesshs}%. Finally, white residents in Takoma Park have higher levels of educational attainment than the state or region; {pull_tp_white_bachelor}% of white Takoma Park residents have a bachelor's degree or higher, compared to {pull_md_white_bachelor}% of white people in Maryland and {pull_mont_white_bachelor}% in Montgomery County.")

```

```{r race educ comparison tp plot}
sub_race_compare_educ <- subplot(race_breakout_gen(educ_black, "Black",  TRUE), 
                                 race_breakout_gen(educ_white, "White"),
                                 race_breakout_gen(educ_hisp, "Hispanic"),
                                 race_breakout_gen(educ_other, "Other"), 
                                 shareX = TRUE, 
                                 shareY = TRUE,
                                 nrows = 2) %>%
  layout(title = "Educational attainment by race and place",
         yaxis = list(title = "Cumulative percent"))

```


```{r text computers race}
text_computers_race <- glue("**White and Asian residents of Takoma Park have the greatest access to broadband internet, while residents with a race of 'other,' Hispanic, and Black residents have the least.** {pull_tp_asian_broad}% of the City's Asian residents ({pull_tp_asian_broad_tot} total) and {pull_tp_white_broad}% of its white residents ({pull_tp_white_broad_tot %>% commafy} total) have access to broadband internet, compared to {pull_tp_other_broad}% of residents with a race of 'other' ({pull_tp_other_broad_tot %>% commafy} total), {pull_tp_hispanic_broad}% of Hispanic residents ({pull_tp_hispanic_broad_tot %>% commafy} total), and {pull_tp_black_broad}% of Black residents ({pull_tp_black_broad_tot %>% commafy} total). Most Black residents without broadband have access to a computer but not internet ({pull_tp_black_noint}% and {pull_tp_black_noint_tot %>% commafy} total). Similar shares of Hispanic residents and residents with a race of 'other' can access a computer but not internet ({pull_tp_hispanic_noint}%/{pull_tp_hispanic_noint_tot %>% commafy} total Hispanic residents and {pull_tp_other_noint}%/{pull_tp_other_noint_tot %>% commafy} total residents of another race), but a higher share of Hispanic and 'other' residents also do not have access to a computer ({pull_tp_hispanic_nocomp}% of/{pull_tp_hispanic_nocomp_tot %>% commafy} total Hispanic and {pull_tp_other_nocomp}% of/{pull_tp_other_nocomp_tot %>% commafy} total 'other' residents, compared to {pull_tp_black_nocomp}% of/{pull_tp_black_nocomp_tot %>% commafy} total Black residents).")


```

```{r plot computer access race}

plot_computer_race <- plot_ly(comp_race_tp %>%
                                race_factor(),
                              x = ~ comp_int,
                              y = ~ percent_race,
                              text = ~ glue("Total: {estimate}
                      Margin of error: {pct_moe}%
                      Significant differences: {signif_check}"),
                      color = ~ race,
                      colors = pal_race,
                      opacity = 0.8,
                      name = ~ race,
                      type = "bar") %>%
  layout(title = "Computer/internet access by race",
         xaxis = list(title = ""),
         yaxis = list(title = "Percent race",
                      tickvals = seq(0, 100, by = 5)))

```


```{r text computer compare race}

text_computer_compare_race <- glue("**Asian residents in Takoma Park have higher levels of broadband internet access than Asian residents in Montgomery County or Maryland, white Takoma Park residents have higher rates than Maryland, and residents with a race of 'other' and Hispanic residents have lower access than Maryland or Montgomery County.** In Takoma Park, {pull_tp_asian_broad}% of Asian residents have broadband access compared to {pull_mont_asian_broad}% in Montgomery County and {pull_md_asian_broad}% in Maryland. {pull_tp_white_broad}% of white Takoma Park residents have broadband internet access, compared to {pull_md_white_broad}% in Maryland. Only {pull_tp_hispanic_broad}% of Hispanic residents in Takoma Park have broadband internet access, compared to {pull_md_hispanic_broad}% in Maryland and {pull_mont_hispanic_broad}% in Montgomery County. The share of Takoma Park residents with an 'other' race-categorization who have broadband internet is {pull_tp_other_broad}% (with an upper estimate of {pull_tp_other_broad_upper}% and a lower estimate of {pull_tp_other_broad_lower}%), compared to {pull_mont_other_broad}% in Montgomery County and {pull_md_other_broad}% in Maryland.")

text_computer_race_summary <- glue("**White and Asian residents of Takoma Park have the greatest access to broadband internet while residents with a race of 'other,' Hispanic, and Black residents have the least.** {pull_tp_asian_broad}% of the City's Asian residents and {pull_tp_white_broad}% of its white residents have access to broadband internet, compared to {pull_tp_other_broad}% of residents with a race of 'other,'  {pull_tp_hispanic_broad}% of Hispanic residents, and {pull_tp_black_broad}% of Black residents. Rates of access for Asian Takoma Park residents exceed Asian residents of Montgomery County and Maryland, rates for white residents exceed Maryland, and rates for Hispanic/'other' residents fall-below Maryland and Montgomery County.")


```




```{r plot internet access race compare}

# subplot(sub_comp_race_black, sub_comp_race_hispanic, sub_comp_race_white, sub_comp_race_asian, sub_comp_race_other, nrows = 2, shareX = T, shareY = T) %>%
#   layout(title = "Internet access by race and place")

plot_int_access_race_comp <- plot_ly(comp_race_broadband %>%
                                       filter(!race %in% tp_race_cats) %>%
                                       race_factor(),
                                     x = ~ race,
                                     y = ~ percent_race,
                                     text = ~ paste0("Total: ", estimate %>% commafy,
                                                     "\nUpper percent estimate: ", pct_upper,
                                                     "\nLower percent estimate: ", pct_lower),
                                     name = ~ location,
                                     color = ~ location,
                                     type = "bar") %>%
  layout(title = "Broadband internet access by race and place",
         yaxis = list(title = "Percent race"),
         xaxis = list(title = ""))
```


```{r health insurance race}

health_insur_race_age <- data_binder("health_race_age") %>%
  name_num_formatter()

health_insur_race_age_root <- health_insur_race_age %>%
  filter(!grepl("hispanic", race))

health_insur_race_age_process <- health_insur_race_age %>%
  filter(race != "white alone")

health_race <- process_df_tp(health_insur_race_age_process, 
                             group_cols = c("location", "race", "health"),
                             name_col = "health", 
                             overall_cols = c("location", "health"), 
                             bind_overall = "race",
                             root_df = health_insur_race_age_root) %>%
  race_recode(race_col = race) %>%
  filter(!race %in% tp_race_cats) %>%
  signif_compare(race, "white", c("location", "health"), est_col = pct_health, pct_moe) %>%
  signif_checker(list("Overall" = "signif_overall",
                      "MC" = "signif_mont",
                      "MD" = "signif_maryland",
                      "White" = "signif_white"))

health_race_noinsur <- health_race %>%
  filter(grepl("No health", health))

pull_race_noinsur <- pull_creator(health_race_noinsur, c("location", "race")) 

pull_black_nohealth <- pull_race_noinsur(c("Takoma", "black"), "pct_health")

pull_black_nohealth_tot <- pull_race_noinsur(c("Takoma", "black"), "health_est")

pull_white_nohealth <- pull_race_noinsur(c("Takoma", "white"), "pct_health")

pull_white_nohealth_tot <- pull_race_noinsur(c("Takoma", "white"), "health_est")


pull_asian_nohealth <- pull_race_noinsur(c("Takoma", "asian"), "pct_health")

pull_multi_nohealth <- pull_race_noinsur(c("Takoma", "multi"), "pct_health")


pull_other_nohealth <- pull_race_noinsur(c("Takoma", "other"), "pct_health")

pull_other_nohealth_tot <- pull_race_noinsur(c("Takoma", "other"), "health_est")

pull_hisp_nohealth <- pull_race_noinsur(c("Takoma", "hisp"), "pct_health")

pull_hisp_nohealth_tot <- pull_race_noinsur(c("Takoma", "hisp"), "health_est")


pull_overall_nohealth <- pull_race_noinsur(c("Takoma", "overall"), "pct_health")


pull_black_nohealth_mont <- pull_race_noinsur(c("Mont", "black"), "pct_health")

pull_black_nohealth_md <- pull_race_noinsur(c("Maryland", "black"), "pct_health")


pull_other_nohealth_mont <- pull_race_noinsur(c("Mont", "other"), "pct_health")

text_health_race_noinsur_summary <- glue("**Residents with a race of 'other,' Black residents, and Hispanic residents have less access to health insurance than white residents and residents overall.** Only {pull_white_nohealth}% of white residents do not have any insurance, compared to {pull_other_nohealth}% of residents with a race of 'other', {pull_hisp_nohealth}% of Hispanic residents, and {pull_black_nohealth}% of Black residents. Access to insurance for Black and 'other' residents fall below residents of the same race in Montgomery County.")

text_health_race_noinsur <- glue("**Statistically-significant racial disparities show up in access to health insurance between white residents and other residents, and exceed those in Maryland and Montgomery County:** 

- Residents with a race listed as 'other' in the ACS lack health insurance at the highest rates of any race/ethnicity; {pull_other_nohealth}% of these residents do not have insurance ({pull_other_nohealth_tot} total), compared to the city's overall rate of {pull_overall_nohealth}% and white residents' rate of {pull_white_nohealth}%. 

- Both Hispanic and Black residents also have less access to health insurance than residents overall and white residents at statistically-significant levels. {pull_hisp_nohealth}% of Hispanic residents do not have health insurance ({pull_hisp_nohealth_tot %>% commafy} total), and {pull_black_nohealth}% of Black residents do not have health insurance ({pull_black_nohealth_tot %>% commafy} total).")

text_health_race_noinsur_compare <- glue("**Gaps for Black residents in Takoma Park exceed gaps in Montgomery County and Maryland at statistically significant levels, and gaps for residents with a race of 'other' exceed Montgomery County.** In Montgomery County and Maryland, {pull_black_nohealth_mont}% and {pull_black_nohealth_md}% of Black residents don't have health insurance, compared to {pull_black_nohealth}% of Black Takoma Park residents. {pull_other_nohealth}% of residents with a race of 'other' in Takoma Park do not have health insurance, compared to {pull_other_nohealth_mont}% of  Montgomery County residents with a race of 'other.'")


```


```{r health insurance race plot}

plot_health_race_noinsur <- plot_ly(health_race_noinsur %>% race_factor(),
                                    hovertext = ~ glue("Estimate: {health_est %>% commafy}
        Margin of erorr: {pct_moe}%
        Significance: {signif_check}"),
        x = ~ location,
        y = ~ pct_health,
        name = ~ race,
        color = ~ race,
        colors = pal_race,
        opacity = 0.8,
        type = "bar") %>%
  layout(title = "Population without health insurance by race",
         xaxis = list(title = ""),
         yaxis = list(title = "Percent race"))

```



```{r health insurance race age}

health_insur_race_age_analysis <- health_insur_race_age_process %>%
  name_num_formatter() %>%
  signif_mont_tp(join_col = c("race",  "age", "health"), pct_age) %>%
  signif_compare(race, "white", join_col = c(location,  age, health), est_col = pct_age, moe_col = pct_moe) %>%
  signif_overall(root_df = health_insur_race_age_root,
                 group_cols = c("location", "age", "health"),
                 est_col = pct_age,
                 moe_col = pct_moe,
                 bind_overall = "race")

health_insur_race_age_analysis_nohealth <- health_insur_race_age_analysis %>%
  filter(grepl("no ", health, ignore.case = T)) %>%
  race_recode(race_col = race) %>%
  signif_checker(signif_cols = list("Overall" = "signif_overall",
                                    "MD" = "signif_maryland",
                                    "MC" = "signif_mont",
                                    "White" = "signif_white")) %>%
  age_recode(age_col = age) %>%
  filter(!race %in% tp_race_cats) %>%
  num_formatter()


health_insur_race_age_analysis_nohealth_tp <- health_insur_race_age_analysis_nohealth %>%
  filter(grepl("Takoma", location)) 



pull_race_age_health <- pull_creator(health_insur_race_age_analysis_nohealth, c("location", "race", "age_new"))

pull_health_1964_other <- pull_race_age_health(c("Takoma", "other", "19-64"), "pct_age")

pull_health_1964_other_tot <- pull_race_age_health(c("Takoma", "other", "19-64"), "estimate")

pull_health_1964_other_mont <- pull_race_age_health(c("Montgomery", "other", "19-64"), "pct_age")

pull_health_1964_other_md <- pull_race_age_health(c("Maryland", "other", "19-64"), "pct_age")


pull_health_1964_black <- pull_race_age_health(c("Takoma", "black", "19-64"), "pct_age")

pull_health_1964_black_tot <- pull_race_age_health(c("Takoma", "black", "19-64"), "estimate")

pull_health_1964_black_mont <- pull_race_age_health(c("Montgomery", "black", "19-64"), "pct_age")

pull_health_1964_black_md <- pull_race_age_health(c("Maryland", "black", "19-64"), "pct_age")

pull_health_19_black <- pull_race_age_health(c("Takoma", "black", "< 19"), "pct_age")

pull_health_19_black_tot <- pull_race_age_health(c("Takoma", "black", "< 19"), "estimate")




pull_health_1964_hisp <- pull_race_age_health(c("Takoma", "hisp", "19-64"), "pct_age")

pull_health_1964_hisp_tot <- pull_race_age_health(c("Takoma", "hisp", "19-64"), "estimate")

pull_health_19_hisp <- pull_race_age_health(c("Takoma", "hisp", "< 19"), "pct_age")

pull_health_19_hisp_mont <- pull_race_age_health(c("Montgomery", "hisp", "< 19"), "pct_age")

pull_health_19_hisp_md <- pull_race_age_health(c("Maryland", "hisp", "< 19"), "pct_age")



pull_health_1964_asian <- pull_race_age_health(c("Takoma", "asian", "19-64"), "pct_age")

pull_health_1964_asian_tot <- pull_race_age_health(c("Takoma", "asian", "19-64"), "estimate")


pull_health_1964_white <- pull_race_age_health(c("Takoma", "white", "19-64"), "pct_age")

pull_health_1964_white_tot <- pull_race_age_health(c("Takoma", "white", "19-64"), "estimate")


pull_health_19_white <- pull_race_age_health(c("Takoma", "white", "< 19"), "pct_age")


pull_health_1964_overall <- pull_race_age_health(c("Takoma", "overall", "19-64"), "pct_age")

pull_health_1964_overall_tot <- pull_race_age_health(c("Takoma", "overall", "19-64"), "estimate")


pull_health_19_overall <- pull_race_age_health(c("Takoma", "overall", "< 19"), "pct_age")

text_race_age_health_summary <- glue("**Disparities in health-insurance access appear between white residents and most other races in the 19-64 year old age-range, and between white and black residents under 19.** Between 19 and 64, only {pull_health_1964_white}% of white residents lack health insurance, compared to {pull_health_1964_other}% of residents with a race of 'other', {pull_health_1964_hisp}% of Hispanic residents, {pull_health_1964_black}% of Black residents, and {pull_health_1964_asian}% of Asian residents. Black residents and residents with a race of 'other' between 19 and 64 in Takoma Park also have less access to health insurance than residents of the same race in Montgomery County and Maryland.")

text_race_age_health <- glue("Low estimate-totals make assessing the statistical significance of disparities in health insurance access by age and race difficult. **Nonetheless, statistically significant disparities in access appear between white and people of color residents in the 19-64 year old age-range, and white and Black residents under 19-years old.**

- {pull_health_1964_other}% of residents with a race of 'other' between 19 and 64 ({pull_health_1964_other_tot} total) and {pull_health_1964_hisp}% of 19-64 year old Hispanic residents ({pull_health_1964_hisp_tot} total) do not have health insurance, compared to {pull_health_1964_overall}% of all city residents and {pull_health_1964_white}% of white residents. 

- Statistically significant disparities also exist in health insurance access between Black residents and white residents under 19, and between Black/Asian residents and white residents between 19 and 64. {pull_health_19_black}% of Black residents under 19 ({pull_health_19_black_tot} total) and {pull_health_1964_black}% of residents aged 19-64 ({pull_health_1964_black_tot} total) do not have health insurance, compared to {pull_health_19_white}% of white residents under 19 year-olds and {pull_health_1964_white}% of 19-64 year olds. Asian residents aged 19-64 also have lower rates of health insurance access than white residents in the same age group, with {pull_health_1964_asian}% of Asian residents in this age range lacking health insurance.")

text_race_age_health_compare <- glue("**Comparing locations by health insurance access, race, and age, residents with a race of 'other' and Black residents aged 19-64 in Takoma Park are less likely to have health insurance than in Montgomery County or Maryland.** For residents with a race of 'other' between 19 and 64, {pull_health_1964_other}% of Takoma Park residents lack health insurance compared to {pull_health_1964_other_mont}% in Montgomery County and {pull_health_1964_other_md}% in Maryland. For Black residents in the same age range, {pull_health_1964_black}% of Takoma Park residents lack health insurance compared to {pull_health_1964_black_mont}% in Montgomery County and {pull_health_1964_black_md}% in Maryland. Hispanic residents under 19 have slightly more access to health insurance than in Montgomery County or Maryland, with {pull_health_19_hisp}% of Hispanic Takoma Park residents lacking health insurance compared to {pull_health_19_hisp_mont}% of Montgomery County residents and {pull_health_19_hisp_md}% of Maryland residents.")


```


```{r plot health race age}

plot_health_insur_race_age <- function(locationval, showleg = F){
  plot_ly(health_insur_race_age_analysis_nohealth %>%
            filter(grepl(locationval, location)) %>%
            race_factor(),
          x = ~ age_new,
          hovertext = ~ glue("Estimate: {estimate}
        Margin of error: {pct_moe}%
                           Significant differences: {signif_check}"),
        color = ~ race,
        colors = pal_race,
        opacity = 0.8,
        y = ~ pct_age,
        name = ~ race,
        showlegend = showleg,
        legendgroup = ~ race,
        type = "bar") %>%
    layout(xaxis = list(title = ""),
           yaxis = list(title = "")) %>%
    subplot_title(locationval)
  
}

sub_health_insur_race_age <- plot_health_insur_race_age("Takoma Park", T)
sub_health_insur_race_age_mont <- plot_health_insur_race_age("Montgomery County", F)
sub_health_insur_race_age_md <- plot_health_insur_race_age("Maryland", F)

plot_race_age_health <- subplot(sub_health_insur_race_age,
                                sub_health_insur_race_age_mont,
                                sub_health_insur_race_age_md, nrows = 1, shareY = T) %>%
  layout(title = "Residents without health insurance by age and race",
         yaxis = list(title = "Percent"))


```




```{r tenure}
tenure_data <- data_binder("tenure_df") %>%
  name_num_formatter() %>%
  recode_tenure(tenure) %>%
  signif_mont_tp("tenure", pct_tenure) %>%
  signif_checker(list("MC" = "signif_mont", "MD" = "signif_maryland"))

pull_tenure <- pull_creator(tenure_data, c("name", "tenure"))

pull_tp_rent_pct <- pull_tenure(c("Takoma", "rent"), "pct_tenure")

```


```{r tenure age}

tenure_age_root <- data_binder("tenure_age") %>%
  mutate(age = gsub("Householder ", "", age)) %>%
  name_num_formatter() %>%
  age_recode(age_col = age)

tenure_age <- tenure_age_root %>%
  signif_mont_tp(join_col = c("tenure",
                              "age_new"), 
                 pct_age, 
                 pct_moe) %>%
  signif_overall(tenure_age_root, 
                 group_cols = c("name",
                                "age_new"), 
                 estimate, 
                 moe, 
                 bind_overall = "tenure") %>%
  est_moe_derive(c("name", "age_new"), name_col = "age_tot") %>%
  rename(pct_age_moe = pct_moe) %>%
  derive_pct_est_moe("pct_agegrp",
                     "age_tot_est",
                     "age_tot_moe") %>%
  num_formatter() %>%
  signif_checker() %>%
  rename(signif_check_compage = signif_check,
         pct_age_pop = pct_overall) %>%
  signif_mont_tp(join_col = c("tenure",
                              "age_new"), 
                 pct_agegrp,
                 pct_moe) %>%
  signif_overall(tenure_age_root, 
                 group_cols = c("name",
                                "tenure"),
                 estimate,
                 moe,
                 bind_overall = "age_new") %>%
  signif_checker() %>%
  rename(signif_check_comptenure = signif_check)

tp_tenure_age <- tenure_age %>%
  filter(grepl("Takoma", location))

plot_tenure_age_locationcomp <- plot_ly(tenure_age %>%
                                          filter(grepl("Owner", tenure, ignore.case = T)),
                                        x = ~ age_new,
                                        y = ~ pct_agegrp,
                                        color = ~ location,
                                        colors = "Set1",
                                        name = ~ location,
                                        hovertext = ~ glue("Total: {estimate}
                                                 Significant differences: {signif_check_comptenure}"),
                                        type = "scatter",
                                        mode = "line+marker") %>%
  layout(xaxis = list(title = "Age group"),
         yaxis = list(title = "Percent homeowners"),
         title = "Percent of age-group that are owners by place")

pct_tenure_pct_age <- plot_ly(tp_tenure_age,
                              x = ~ age_new,
                              y = ~ estimate,
                              text = ~ glue("{pct_agegrp %>% round(1)}%"),
                              textposition = "inside",
                              textfont = list(color = "black"),
                              hovertext = ~ glue("Total: {estimate %>% commafy}
                              Margin of error: {pct_moe}
                              Significant differences: {signif_check_comptenure}
                              Percent of all renters/owners: {pct_age}%"),
                              name = ~ tenure,
                              color = ~ tenure) %>%
  layout(barmode = "stack",
         xaxis = list(title = "Age range"),
         yaxis = list(title = "Total Households"),
         title = "Tenure by age group") 

write_tp_tenure_age <- tp_tenure_age %>%
  select(name, estimate, moe, tenure, age_new, pop_tot, tenure_tot, pct_age, pct_age_moe, pct_agegrp, pct_moe) %>%
  rename(pct_tenure = pct_age,
         pct_tenure_moe = pct_age_moe,
         pct_agegrp_moe = pct_moe)


# pull values for tenure and age
pull_tenure_age <- pull_creator(tenure_age, c("location", "tenure", "age_new"))

pull_own_1524 <- pull_tenure_age(c("Takoma", "own", "15-24"), "pct_agegrp")

pull_own_6064 <- pull_tenure_age(c("Takoma", "own", "60-64"), "pct_agegrp")

pull_own_6574 <- pull_tenure_age(c("Takoma", "own", "65-74"), "pct_agegrp")

pull_own_7584 <- pull_tenure_age(c("Takoma", "own", "75-84"), "pct_agegrp")


pull_own_6574_mont <- pull_tenure_age(c("Mont", "own", "65-74"), "pct_agegrp")

pull_own_7584_mont <- pull_tenure_age(c("Mont", "own", "75-84"), "pct_agegrp")


pull_own_6574_md <- pull_tenure_age(c("Maryland", "own", "65-74"), "pct_agegrp")

pull_own_7584_md <- pull_tenure_age(c("Maryland", "own", "75-84"), "pct_agegrp")


# generate tenure/age subplot
plots_tenure_age <- subplot(pct_tenure_pct_age %>%
                              subplot_title("Takoma Park\ntotal"),
                            plot_tenure_age_locationcomp %>%
                              subplot_title("Percent of age-group that are owners"),
                            nrows = 2,
                            shareX= T) %>%
  layout(title = "Households by tenure and age group",
         xaxis = list(title = "Tenure"),
         yaxis = list(title = ""))

write.csv(write_tp_tenure_age, "./data/output_data/write_tp_tenure_age.csv")



```

```{r race homewow}

tenure_race_overall <- data_binder("tenure_race") %>%
  filter(!grepl("white alone householder", race)) %>%
  name_formatter() %>%
  num_formatter()

tenure_race_overall_sub <- tenure_race_overall %>%
  rename(est_tenure_race = estimate) %>%
  select(name,race, tenure, tenure_overall, est_tenure_race, race_pct_tenure)

# load in race by tenure
race_tenure <- data_binder("race_tenure")  %>%
  filter(!grepl("white alone householder", race)) %>%
  name_formatter() %>%
  num_formatter() %>%
  left_join(tenure_race_overall_sub)%>%
  race_recode(race, new_race_col = "race")

tp_race_tenure <- race_tenure %>%
  filter(grepl("Takoma", location) & estimate > 30)


pull_race_tenure <- pull_creator(race_tenure, c("name", "tenure", "race"))

pull_tp_rent_white <- pull_race_tenure(c("Takoma", "rent", "white"), "race_pct")

pull_tp_rent_black <- pull_race_tenure(c("Takoma", "rent", "black"), "race_pct")

pull_tp_rent_hispanic <- pull_race_tenure(c("Takoma", "rent", "hispanic"), "race_pct")

pull_tp_rent_asian <- pull_race_tenure(c("Takoma", "rent", "asian"), "race_pct")

pull_tp_own_white <- pull_race_tenure(c("Takoma", "own", "white"), "race_pct")

pull_tp_own_black <- pull_race_tenure(c("Takoma", "own", "black"), "race_pct")

pull_tp_own_hispanic <- pull_race_tenure(c("Takoma", "own", "hispanic"), "race_pct")

pull_tp_own_asian <- pull_race_tenure(c("Takoma", "own", "asian"), "race_pct")

pull_tp_own_other <- pull_race_tenure(c("Takoma", "own", "other"), "race_pct")



pull_tp_ownpct_white <- pull_race_tenure(c("Takoma", "own", "white"), "race_pct_tenure")

pull_tp_ownpct_black <- pull_race_tenure(c("Takoma", "own", "black"), "race_pct_tenure")

pull_tp_rentpct_black <- pull_race_tenure(c("Takoma", "rent", "black"), "race_pct_tenure")


pull_tp_ownpct_hispanic <- pull_race_tenure(c("Takoma", "own", "hispanic"), "race_pct_tenure")

pull_tp_ownpct_asian <- pull_race_tenure(c("Takoma", "own", "asian"), "race_pct_tenure")


```


```{r cost burden overall, echo=FALSE}

renter_burden <- data_binder("burden_renters_processed") %>%
  filter(!grepl("Not computed", percent_income, ignore.case = TRUE)) %>%
  mutate(percent_income = factor(percent_income, levels = rev(unique(.[["percent_income"]])))) %>%
  name_num_formatter() %>%
  select(-c(geoid, variable, label, concept)) %>%
  rename(total_tenure = total_renters, 
         
         total_tenure_moe = total_renters_moe,
         pct_tenure = pct_renters) %>%
  arrange(percent_income) %>%
  group_by(location) %>%
  mutate(cumul_pct = cumsum(pct_tenure),
         tenure = "Renter")

owner_burden <- data_binder("burden_owners_overall") %>%
  filter(!grepl("Not computed", percent_household_income, ignore.case = TRUE)) %>%
  mutate(percent_household_income = factor(percent_household_income, levels = rev(unique(.[["percent_household_income"]])))) %>%
  name_num_formatter() %>%
  select(-c(geoid)) %>%
  rename(total_tenure = total_homeowners,
         percent_income = percent_household_income,
         estimate = name_percent_household_income_est,
         moe = name_percent_household_income_moe,
         total_tenure_moe = total_homeowners_moe,
         pct_tenure = pct_homeowners,
         cumul_pct = cumulpct) %>%
  arrange(percent_income) %>%
  group_by(location) %>%
  mutate(tenure = "Owner",
         cumul_pct = cumsum(pct_tenure))

burden_overall <- rbind(renter_burden, owner_burden)  %>%
  cost_burden_recode(percent_income)

burden_tp <- filter(burden_overall, grepl("Takoma", location))

pull_burden_rentown <- pull_creator(burden_overall, c("name", "tenure", "percent_income"))

pull_tp_rent_30more <- pull_burden_rentown(c("takoma","rent", "30-34.9"), "cumul_pct")

pull_tp_own_30more <- pull_burden_rentown(c("takoma","own", "30-34.9"), "cumul_pct")

pull_tp_rent_50more <- pull_burden_rentown(c("takoma","rent", "50%"), "cumul_pct")

pull_tp_own_50more <- pull_burden_rentown(c("takoma", "own", "50%"), "cumul_pct")


```


```{r tenure med income}

tenure_income_median <- data_binder("tenure_income_median") %>%
  name_formatter() %>%
  num_formatter() %>%
  recode_tenure(tenure) %>%
  arrange(desc(tenure))
# mutate(tenure = factor(tenure, levels = unique(.[["tenure"]])))

pull_tenure_medincome <- pull_creator(tenure_income_median, c("name", "tenure"))

pull_tp_rent_income <- pull_tenure_medincome(c("Takoma", "rent"), "estimate")

pull_tp_own_income <- pull_tenure_medincome(c("Takoma", "own"), "estimate")

pull_mont_rent_income <- pull_tenure_medincome(c("Montg", "rent"), "estimate")

pull_mont_own_income <- pull_tenure_medincome(c("Montg", "own"), "estimate")


pull_md_rent_income <- pull_tenure_medincome(c("^maryland$", "rent"), "estimate")

pull_md_own_income <- pull_tenure_medincome(c("^maryland$", "own"), "estimate")


```


```{r income cost burden, echo=FALSE}
renter_costs <- read_rds("./data/output_data/acs5_2019/tp_spec/household_income_rentercosts_processed_tp.rds")

owner_costs <- read_rds("./data/output_data/acs5_2019/tp_spec/household_income_ownercosts_processed_tp.rds")

owner_costs_processed <-  owner_costs %>%
  rename_all(tolower) %>%
  name_num_formatter() %>%
  mutate(across(where(is.character), ~ gsub(":", "", .x))) %>%
  income_recode(household_income, "household_income") %>%
  cost_burden_recode(housing_costs) %>%
  group_by(name, household_income) %>%
  arrange(housing_costs) %>%
  mutate(tenure = "Owner",
         cumul_pct = cumsum(pct_bracket)) %>%
  rename(pct_all = pct_bracket) %>%
  select(household_income, housing_costs, estimate, moe, tenure, pct_all, cumul_pct, pct_upper, pct_lower, pct_moe) %>%
  ungroup %>%
  group_by(name) %>%
  mutate(tot_tenure = sum(estimate),
         pct_tenure = pct_round(estimate, tot_tenure))

renter_costs_processed <- renter_costs %>%
  rename_all(tolower) %>%
  name_num_formatter() %>%
  mutate(across(where(is.character), ~ gsub(":", "", .x))) %>%
  income_recode(household_income, "household_income") %>%
  cost_burden_recode(housing_costs) %>%
  group_by(name, household_income) %>%
  arrange(housing_costs) %>%
  mutate(tenure = "Renter",
         cumul_pct = cumsum(pct_bracket)) %>%
  rename(pct_all = pct_bracket) %>%
  select(household_income, housing_costs, estimate, moe, tenure, pct_all, cumul_pct, pct_upper, pct_lower, pct_moe) %>%
  ungroup %>%
  mutate(tot_tenure = sum(estimate),
         pct_tenure = pct_round(estimate, tot_tenure))

renter_owner_costs <- rbind(renter_costs_processed, owner_costs_processed)

# num_formatter() %>%
# mutate(across(where(is.character), ~ gsub(":", "", .x)))

pull_tenure_income_cost <- pull_creator(renter_owner_costs, c("tenure", "household_income", "housing_costs"))

pull_rent_less20k_severeburden <- pull_tenure_income_cost(c("Renter", "10k", "50"), "pct_all")

income_vec <- renter_owner_costs$household_income %>% unique
costs_vec <-  renter_owner_costs$housing_costs %>% unique

renter_owner_costs_less35 <- renter_owner_costs %>%
  group_by(tenure) %>%
  mutate(tot_renters = sum(estimate)) %>%
  filter(household_income %in% income_vec[1:3]) %>%
  group_by(tenure) %>%
  mutate(tot_under35k = sum(estimate),
         pct_under35k = pct_round(estimate, tot_under35k)) %>%
  ungroup


rent_less35k_burden <- filter(renter_owner_costs_less35, tenure == "Renter") %>%
  filter(housing_costs %in% costs_vec[1:4]) %>%
  group_by() %>%
  mutate(tot_tenure_burden = sum(estimate),
         pct_all_tenure = pct_round(tot_tenure_burden, tot_renters))

rent_less35k_severeburden <- filter(renter_owner_costs_less35, tenure == "Renter") %>%
  filter(housing_costs %in% costs_vec[1]) %>%
  group_by() %>%
  mutate(tot_tenure_burden = sum(estimate),
         pct_all_tenure = pct_round(tot_tenure_burden, tot_renters))

pull_rent_less35k_burden_pctburden <- rent_less35k_burden %>%
  pull(pct_under35k) %>%
  sum()

pull_rent_less35k_burden_pctsevereburden <- rent_less35k_severeburden %>%
  pull(pct_under35k) %>%
  sum()

pull_rent_less35k_burden_pctall <- rent_less35k_burden[["pct_all_tenure"]][1]

pull_rent_less35k_burden_num <-  rent_less35k_burden[["tot_tenure_burden"]][1]

own_less35k_burden <- filter(renter_owner_costs_less35, tenure == "Owner") %>%
  filter(housing_costs %in% costs_vec[1:4]) %>%
  group_by() %>%
  mutate(tot_tenure_burden = sum(estimate),
         pct_all_tenure = pct_round(tot_tenure_burden, tot_renters))

own_less35k_severeburden <- filter(renter_owner_costs_less35, tenure == "Owner") %>%
  filter(housing_costs %in% costs_vec[1]) %>%
  group_by() %>%
  mutate(tot_tenure_burden = sum(estimate),
         pct_all_tenure = pct_round(tot_tenure_burden, tot_renters))

pull_own_less35k_burden_pctburden <- own_less35k_burden %>%
  pull(pct_under35k) %>%
  sum()

pull_own_less35k_burden_pctsevereburden <- own_less35k_severeburden %>%
  pull(pct_under35k) %>%
  sum()

pull_own_less35k_burden_pctall <- own_less35k_burden[["pct_all_tenure"]][1]

pull_own_less35k_burden_num <- own_less35k_burden[["tot_tenure_burden"]][1]

```


```{r renter_owner_income, echo=FALSE}

renter_income_num_all <- data_binder("renter_income_num")

owner_income_num_all <- data_binder("owner_income_num")

renter_income_num <- renter_income_num_all %>%
  filter(grepl("Takoma", name))

owner_income_num <- data_binder("owner_income_num") %>%
  filter(grepl("Takoma", name))


# add category
# owner_income_num_processed <- owner_income_num %>%
#         mutate(household_income150 = household_income,
#                 household_income = ifelse(grepl("(100,000)|(150,000)", household_income150),
#                                           "$100,000 or more:",
#                                           household_income150)) %>%
#         est_moe_derive("household_income") %>%
#         mutate(household_income_est = ifelse(grepl("150,000", household_income150), estimate, household_income_est),
#                household_income_moe = ifelse(grepl("150,000", household_income150), moe, household_income_moe),
#                tenure = "Owner",
#                household_income = ifelse(grepl("150,000", household_income150), household_income150, household_income)) %>%
#         derive_pct_est_moe("pct_all", 
#                            aggregate_est = "num_homeowners",
#                            aggregate_moe = "num_homeowners_moe",
#                            component_est = "household_income_est",
#                            "household_income_moe") %>%
#         select(household_income, tenure, pct_all, pct_upper, pct_lower, pct_moe)

owner_income_num_processed <- owner_income_num %>%
  income_recode(household_income, rent_own = T) %>%
  mutate(tenure = "Owner",
         cumul_pct = cumsum(pct_homeowners)) %>%
  rename(pct_all = pct_homeowners) %>%
  select(household_income, income_recode, tenure, pct_all, cumul_pct, pct_upper, pct_lower, pct_moe)

renter_income_num_processed <- renter_income_num %>%
  income_recode(household_income, rent_own = T) %>%
  mutate(tenure = "Renter",
         cumul_pct = cumsum(pct_renters)) %>%
  rename(pct_all = pct_renters) %>%
  select(household_income, income_recode, tenure,pct_all, cumul_pct, pct_upper, pct_lower, pct_moe)

rent_own_data <- rbind(owner_income_num_processed, renter_income_num_processed) %>%
  num_formatter() %>%
  mutate(across(where(is.character), ~ gsub(":", "", .x)))

pull_rent_own_income <- pull_creator(rent_own_data, c("income_recode", "tenure"))

pull_own_greater150 <- pull_rent_own_income(c("> \\$150k", "own"), "pct_all")

pull_rent_greater100 <- pull_rent_own_income(c("> \\$100k", "rent"), "pct_all")


income_vec <- unique(rent_own_data$income_recode)

rent_own_incomeless35 <- rent_own_data %>%
  filter(income_recode %in% income_vec[1:3])

pull_rent_below35k <- pull(rent_own_incomeless35 %>% filter(grepl("Rent", tenure)), pct_all) %>%
  sum


pull_own_below35k <- pull(rent_own_incomeless35 %>% filter(grepl("Own", tenure)), pct_all) %>%
  sum


```


```{r plot homeownership race}

sub_pct_race_tenure <- plot_ly(tp_race_tenure %>%
                                 race_factor(), 
                               x = ~ tenure,
                               y = ~ estimate,
                               color = ~ race,
                               colors = pal_race,
                               opacity = 0.8,
                               name = ~ race,
                               legendgroup = ~ race,
                               text = ~ paste0("Percent: ", race_pct_tenure, "%"),
                               type = "bar") %>%
  layout(yaxis = list(title = "Total")) %>%
  subplot_title("Total households")

sub_pct_tenure <- plot_ly(tp_race_tenure %>%
                            race_factor(), 
                          x = ~ race,
                          y = ~ race_pct,
                          legendgroup = ~ tenure,
                          name = ~ tenure,
                          type = "bar") %>%
  layout(yaxis  = list(title = "Percent")) %>%
  subplot_title("Percent of race")



subplots_racetenure <- subplot(sub_pct_race_tenure,
                               # layout(legend = list(title = list(text = "Race"))), 
                               sub_pct_tenure,                
                               # layout(legend = list(title = list(text = "Tenure"))), 
                               nrows = 2) %>%
  layout(title = "Takoma Park households by race and tenure")

```


```{r text race tenure}
text_racetenure <- glue("**There are significant racial disparities in homeownership in Takoma Park.** Despite representing {pull_white_tp_pct}% of the population, non-Hispanic white residents make up {pull_tp_ownpct_white}% of all homeowners, with a homeownership rate of {pull_tp_own_white}%; the only other households with a homeownership rate above 50% are Asian homeowners, with a rate of {pull_tp_own_asian}%. By contrast, Black residents make up {pull_tp_rentpct_black}% of the city's renters--despite representing {pull_black_tp_pct}% of the City's population--with a homeownership rate of {pull_tp_own_black}%. Households with a race of 'other' have a similarly low homeownership rate of {pull_tp_own_other}%, and Hispanic homeowners have a homeownership rate of {pull_tp_own_hispanic}%.")

```



```{r tenure cost burden}

text_tenure_costburden <- glue("**{pull_tp_rent_30more}% of Takoma Park renters are housing-cost burdened--meaning they spend at least 30% of their income on housing costs--compared to {pull_tp_own_30more}% of Takoma Park owners.** The share of severely cost burdened renters--meaning they spend more than half their income on housing--doubles the share of homeowners, at {pull_tp_rent_50more}% of renters compared to {pull_tp_own_50more}% of owners.")

```

```{r plot cost burden}

plot_tenure_costburden <- plot_ly(burden_tp, 
                                  type = "scatter",
                                  color = ~ tenure,
                                  x = ~ percent_income,
                                  y = ~ cumul_pct,
                                  text =~ glue(
                                  "Total: {estimate}
                                  Percent margin of error: {pct_moe}%"
                                  ),
                                  mode = "lines+markers") %>%
  layout(yaxis = list(title = "Cumulative percent"),
         xaxis = list(title = "Percent of income spent on housing"),
         title = "Cumulative percent of households by cost-burden and tenure")
```

```{r text summary housing}

text_homeowners_race <- glue("**About half of Takoma Park's population are homeowners ({100 - pull_tp_rent_pct}%), but there are substantial disparities in homeownership by race.** {pull_tp_ownpct_white}% of homeowners are white, and white residents have a homeownership rate of {pull_tp_own_white}% compared to {pull_tp_own_black}% for Black residents and {pull_tp_own_other}% for residents with a race of 'other.'")

text_homeowners_econdispar <- glue("**Given differences in homeownership by race, economic disparities between homeowners and renters are also racial disparities.** {pull_tp_rent_30more}% of renters are housing-cost burdened (meaning they spend more than 30% of their income on housing costs) and {pull_tp_rent_50more}% severely cost burdened (spending greater than half their income on housing), compared to {pull_tp_own_30more}% of cost-burdened homeowners and {pull_tp_own_50more}% of severely cost-burdened owners.")

text_tenure_income <- glue("**Homeowners also earn more than renters, and homeowner-renter income disparities in Takoma Park exceed Montgomery County and Maryland.** Renters in Takoma Park have a median income of ${pull_tp_rent_income %>% commafy}, and homeowners ${pull_tp_own_income %>% commafy}; {pull_rent_below35k}% of renters have a household income below $35,000, compared to {pull_own_below35k}% of homeowners. Additionally, {pull_rent_less35k_burden_pctburden}% of renters earning below $35,000 annually experience housing cost-burden (spending more than 30% of their income on rent), representing {pull_rent_less35k_burden_pctall}% of all renters.")

```


```{r race median income}

# read in data
race_income_data <- data_binder("race_income_med") %>%
  filter(!grepl("white alone household", race)) %>%
  name_num_formatter() %>%
  race_recode(race)


# filter if na
# race_exclude <- race_income_data %>%
#         filter(is.na(estimate)) %>%
#         pull(race)

race_income_data <- race_income_data %>%
  filter(!(race %in% tp_race_cats))  %>%
  mutate(race = factor(race, unique(.$race), unique(.$race))) %>%
  signif_mont_tp(c("race"), 
                 name_pct = estimate, 
                 moe_pct = moe) %>%
  signif_compare(race, "white", "name", estimate, moe) %>%
  mutate(signif_overall = signif_test(est1 = estimate, overall_median_income, moe, overall_median_income_moe)[[2]]) %>%
  signif_checker(list("Overall" = "signif_overall",
                      "white" = "signif_white",
                      "MC" = "signif_mont",
                      "MD" = "signif_maryland"))

pull_race_income <- pull_creator(race_income_data, c("name", "race"))

pull_tp_white_income <- pull_race_income(c("Takoma", "white"), "estimate")

pull_mont_white_income <- pull_race_income(c("Montgomery", "white"), "estimate")

pull_md_white_income <- pull_race_income(c("^Maryland$", "white"), "estimate")

pull_tp_black_income <- pull_race_income(c("Takoma", "black"), "estimate")

pull_mont_black_income <- pull_race_income(c("Montgomery", "black"), "estimate")

pull_md_black_income <- pull_race_income(c("^Maryland$", "black"), "estimate")

pull_tp_hispanic_income <- pull_race_income(c("Takoma", "hispanic"), "estimate")

pull_mont_hispanic_income <- pull_race_income(c("Montgomery", "hispanic"), "estimate")

pull_md_hispanic_income <- pull_race_income(c("^Maryland$", "hispanic"), "estimate")

pull_tp_other_income <- pull_race_income(c("Takoma", "other"), "estimate")



```



```{r text median income race}

text_medianinc_race <- glue("**Racial disparities in household income exist throughout Takoma Park, Montgomery County, and Maryland; however, disparities are heightened in Takoma Park compared to either Montgomery County or Maryland.** White households in Takoma Park earn a median income ${(pull_tp_white_income - pull_tp_black_income) %>% commafy} higher than Black residents, ${(pull_tp_white_income - pull_tp_hispanic_income) %>% commafy} higher than Hispanic residents, and ${(pull_tp_white_income - pull_tp_other_income) %>% commafy} higher than residents with a race of other. Income gaps between white and Black residents in Takoma Park almost double those in Montgomery County overall (${(pull_mont_white_income - pull_mont_black_income) %>% commafy}), and almost quadruple those in Maryland overall (${(pull_md_white_income - pull_md_black_income) %>% commafy}); income gaps between white and Hispanic residents follow the same pattern, being almost 1.5 times higher than Montgomery County's and almost four times as large as Maryland's.
                            
**These gaps exist both because people of color in Takoma Park earn less than Montgomery County and Maryland, and because white residents in Takoma Park earn more than in Montgomery County and Maryland.** The median Black household in Takoma Park earns ${pull_tp_black_income %>% commafy}, compared to ${pull_mont_black_income %>% commafy} in Montgomery County and ${pull_md_black_income %>% commafy} in Maryland; the median Hispanic household earns ${pull_tp_hispanic_income %>% commafy}, compared to ${pull_mont_hispanic_income %>% commafy} in Montgomery County and ${pull_md_hispanic_income %>% commafy} in Maryland. By contrast, the median white household earns ${pull_tp_white_income %>% commafy} in Takoma Park, compared to ${pull_mont_white_income %>% commafy} in Montgomery County and ${pull_md_white_income %>% commafy} in Maryland.")


```



```{r income last 12}
income_levels <- data_binder("income_last12") %>%
  name_formatter() %>%
  num_formatter() %>%
  mutate(location = factor(location, levels = .$location, labels = .$location)) %>%
  income_recode(income_col = income_range) %>%
  group_by(name) %>%
  arrange(income_recode) %>%
  mutate(pct_cumul = cumsum(pct_income_range),
         tot_cumul = cumsum(estimate))

pull_income_levels <- pull_creator(income_levels, c("name", "income_recode"))

pull_tp_incomeless35 <- pull_income_levels(c("Takoma", "34k"), "pct_cumul")

pull_tp_incomeless35_tot <- pull_income_levels(c("Takoma", "34k"), "tot_cumul")

pull_md_incomeless35 <- pull_income_levels(c("^Maryland$", "34k"), "pct_cumul")

pull_mont_incomeless35 <- pull_income_levels(c("Montgomery", "34k"), "pct_cumul")


pull_tp_income125149 <- pull_income_levels(c("Takoma", "125k"), "pct_cumul")

pull_tp_income_125149_tot <- pull_income_levels(c("Takoma", "125k"), "tot_cumul")

pull_md_income125149 <- pull_income_levels(c("^Maryland", "125k"), "pct_cumul")


pull_tp_income7599 <- pull_income_levels(c("Takoma", "75k"), "pct_cumul")

pull_tp_income_7599_tot <- pull_income_levels(c("Takoma", "75k"), "tot_cumul")

pull_mont_income7599 <- pull_income_levels(c("Montgomery", "75k"), "pct_cumul")


pull_tp_income150199 <- pull_income_levels(c("Takoma", "150k"), "pct_cumul")

pull_tp_income_150199_tot <- pull_income_levels(c("Takoma", "150k"), "tot_cumul")

pull_md_income150199 <- pull_income_levels(c("^Maryland", "150k"), "pct_cumul")


income_vec <- income_levels$income_recode %>% unique
income_vec_less35 <- income_vec[1:6]

income_less35 <- income_levels %>%
  filter(income_recode %in% income_vec_less35)

pull_tp_less35k <- pull(income_less35, )

```



```{r race income dist}

race_income_household_data <- data_binder("race_income_household") %>%
  filter(!grepl("white alone household", race)) %>%
  name_num_formatter() %>%
  race_recode(race) 

race_income_household_data_root <- data_binder("race_income_household") %>%
  filter(!grepl("hispanic", race)) %>%
  name_num_formatter() %>%
  race_recode(race) 


race_income_household_data <- race_income_household_data %>%
  income_recode(income_range)

# race_exclude <- race_income_household_data %>%
#         filter(grepl("Takoma", location) & race_households <= 100) %>%
#         pull(race) %>%
#   unique

race_income_household_data <- race_income_household_data %>%
  filter(!race %in% tp_race_cats) %>%
  group_by(location, race) %>%
  mutate(cumul_pct = cumsum(percent_race_households),
         cumul_tot = cumsum(estimate),
         income_range = factor(income_range, .$income_range, .$income_range),
         race = factor(race, .$race, .$race)) %>%
  ungroup %>%
  signif_mont_tp(c("income_range", "race"), name_pct = percent_race_households, moe_pct = pct_moe) %>%
  signif_overall(root_df = race_income_household_data_root, group_cols = c("location", "income_range"), percent_race_households, pct_moe, bind_overall = "race") %>%
  signif_compare(race, "white", join_col = c("location", "income_range"), est_col = percent_race_households, pct_moe) %>%
  signif_checker(list("Overall" = "signif_overall",
                      "MC" = "signif_mont",
                      "MD" = "signif_maryland",
                      "White" = "signif_white"))

tp_race_income_household_data <- filter(race_income_household_data, grepl("Takoma", location))

income_ranges <- tp_race_income_household_data$income_range %>%
  unique()

income_ranges_less35 <- income_ranges[1:6] %>%
  as.character()

income_ranges_more100 <- income_ranges[13:length(income_ranges)] %>%
  as.character()

income_ranges_more200 <- income_ranges[length(income_ranges)] %>%
  as.character()

pull_race_income_household_less35 <- pull_creator(tp_race_income_household_data %>%
                                                    filter(income_range %in% income_ranges_less35), c("race"))

pull_race_income_household_more100 <- pull_creator(tp_race_income_household_data %>%
                                                     filter(income_range %in% income_ranges_more100), c("race"))

pull_race_income_household_more200 <- pull_creator(tp_race_income_household_data %>%
                                                     filter(income_range %in% income_ranges_more200), c("race"))


pull_black_income_household_less35 <- pull_race_income_household_less35("Black", "percent_race_households") %>%
  sum

pull_white_income_household_less35 <- pull_race_income_household_less35("White", "percent_race_households") %>%
  sum

pull_hispanic_income_household_less35 <- pull_race_income_household_less35("hispanic", "percent_race_households") %>%
  sum

pull_black_income_household_more100 <- pull_race_income_household_more100("Black", "percent_race_households") %>%
  sum

pull_white_income_household_more100 <- pull_race_income_household_more100("White", "percent_race_households") %>%
  sum

pull_hispanic_income_household_more100 <- pull_race_income_household_more100("hispanic", "percent_race_households") %>%
  sum


pull_black_income_household_more200 <- pull_race_income_household_more200("Black", "percent_race_households") %>%
  sum

pull_white_income_household_more200 <- pull_race_income_household_more200("White", "percent_race_households") %>%
  sum

pull_hispanic_income_household_more200 <- pull_race_income_household_more200("hispanic", "percent_race_households") %>%
  sum

```

```{r text income dist race summary}

text_incomedist_race_summary <- glue("**Racial disparities in income persist at the bottom and top of the income distribution, both exceeding inequalities in Maryland and Montgomery County.** {pull_black_income_household_less35}% of Takoma Park's Black households and {pull_hispanic_income_household_less35}% of its Hispanic households earn less than $35,000 a year, compared to {pull_white_income_household_less35}% of its white households.")

```


```{r text income dist race}

text_incomedist_race <- glue("**Reviewing more granular household income data provides more insight into these disparities.** {pull_black_income_household_less35}% of Takoma Park's Black households and {pull_hispanic_income_household_less35}% of its Hispanic households earn less than $35,000 a year, compared to {pull_white_income_household_less35}% of its white households By contrast, {pull_white_income_household_more100}% of white households earned more than $100,000 a year, compared to {pull_black_income_household_more100}% of Black households and {pull_hispanic_income_household_more100}% of Hispanic households; and {pull_white_income_household_more200}% of its white households earn more than $200,000, compared to {pull_black_income_household_more200}% of Black and {pull_hispanic_income_household_more200}% of Hispanic households. Although the low number of residents with a race of 'other' should caution over-interpreting the data, these residents show similar levels of income disparities to Black residents.")

```


```{r plot race income dist}
plot_raceincome_dist <- plot_ly(tp_race_income_household_data %>%
                                  race_factor(),
                                x = ~ income_recode,
                                y = ~ cumul_pct,
                                color = ~ race,
                                colors = pal_race,
                                opacity = 0.8,
                                name = ~ race,
                                hovertext = ~ glue("Total: {estimate}
                                                   Income-group percent: {percent_race_households}%"),
                                type = "scatter",
                                mode = "lines+markers") %>%
  layout(xaxis = list(title = ""),
         yaxis = list(title = "Percent"),
         title = "Cumulative percent of race by household income")

```



```{r race income compare}

pull_place_race_incomeless35 <- pull_creator(race_income_household_data %>%
                                               filter(income_range %in% income_ranges_less35), c("name", "race"))

pull_md_black_incomeless35 <- pull_place_race_incomeless35(c("^Maryland$", "Black"), "percent_race_households") %>%
  sum

pull_mont_black_incomeless35 <- pull_place_race_incomeless35(c("Montgomery", "Black"), "percent_race_households") %>%
  sum

pull_ratio_tpmont_black_incomeless35 <- (pull_black_income_household_less35 / pull_mont_black_incomeless35) %>% round(2)

pull_ratio_tpmd_black_incomeless35 <- (pull_black_income_household_less35 / pull_md_black_incomeless35) %>% round(2)

pull_md_hispanic_incomeless35 <- pull_place_race_incomeless35(c("^Maryland$", "hispanic"), "percent_race_households") %>%
  sum

pull_mont_hispanic_incomeless35 <- pull_place_race_incomeless35(c("Montgomery", "hispanic"), "percent_race_households") %>%
  sum

pull_ratio_tpmont_hispanic_incomeless35 <- (pull_hispanic_income_household_less35 / pull_mont_hispanic_incomeless35) %>% round(2)

pull_ratio_tpmd_hispanic_incomeless35 <- (pull_hispanic_income_household_less35 / pull_md_hispanic_incomeless35) %>% round(2)


race_income_household_white <- race_income_household_data %>%
  filter(grepl("White", race))

race_income_household_black <- race_income_household_data %>%
  filter(grepl("Black", race))

race_income_household_hispanic <- race_income_household_data %>%
  filter(grepl("Hispanic", race))

race_income_household_other <- race_income_household_data %>%
  filter(grepl("Other", race))


```


```{r text race income compar}

text_race_income_compare <- glue("**Comparing Takoma Park to Maryland and Montgomery County, non-white households in Takoma Park tend to earn lower incomes across the income spectrum, while white households in Takoma Park tend to earn higher incomes than Maryland households and slightly higher incomes than Montgomery County.** The share of Black Takoma Park residents earning less than $35,000 is {pull_ratio_tpmont_black_incomeless35} times higher than the share in Maryland, and {pull_ratio_tpmd_black_incomeless35} times higher than Montgomery County. For Hispanic residents in Takoma Park, the share is {pull_ratio_tpmd_hispanic_incomeless35} times higher than Maryland, and {pull_ratio_tpmont_hispanic_incomeless35} times higher than Montgomery County.")

```



```{r plot race income compare}
plot_raceincomecompare <- subplot(race_breakout_gen(race_income_household_black, "Black", TRUE, x = "income_recode"), 
                                  race_breakout_gen(race_income_household_white, "White", x = "income_recode"),
                                  race_breakout_gen(race_income_household_hispanic, "Hispanic", x = "income_recode"),
                                  race_breakout_gen(race_income_household_other, "Other", x = "income_recode"), 
                                  shareX = TRUE, 
                                  shareY = TRUE,
                                  nrows = 2) %>%
  layout(title = "Cumulative percent of households by race, income, and place")
```



```{r text race income}

text_race_income <- glue("**Substantial racial inequalities in income exist in Takoma Park.** {pull_tp_incomeless35}% of Takoma Park households earn less than $35,000 annually, and {100 - pull_tp_income7599}% earn more than $100,000. White households in Takoma Park have a median income of ${pull_tp_white_income %>% commafy}, compared to a Black median income of ${pull_tp_black_income %>% commafy}, a Hispanic median income of ${pull_tp_hispanic_income %>% commafy}, and a median income of 'other' races of ${pull_tp_other_income %>% commafy}. Income gaps between white and Black residents in Takoma Park almost double those in Montgomery County, and almost quadruple Maryland; income gaps between white and Hispanic residents follow a similar pattern.")

```


<!-- ```{r poverty, echo=FALSE} -->

<!-- # poverty <- data_binder("poverty") %>% -->
<!-- #   filter(!is.na(income_rel_poverty)) %>% -->
<!-- #   filter(!grepl("150 percent", income_rel_poverty)) %>% -->
<!-- #   name_formatter() %>% -->
<!-- #   num_formatter() %>% -->
<!-- #   mutate(location = factor(location, levels = .$location, labels = .$location)) %>% -->
<!-- #   group_by(location) -->


<!-- ``` -->




```{r poverty detail}

poverty_detail <- data_binder("poverty_detail") %>%
  incpov_recode(incpov_ratio) %>%
  group_by(name) %>%
  arrange(incpov_new) %>%
  mutate(pct_cumul = cumsum(pct_incpov),
         tot_cumul = cumsum(estimate)) %>%
  ungroup %>%
  name_num_formatter() %>%
  signif_mont_tp(join_col = c("incpov_new"), name_pct = pct_incpov, pct_moe) %>%
  signif_checker(list("MC" = "signif_mont",
                      "MD" = "signif_maryland"))

poverty_detail_tp <- poverty_detail %>%
  filter(grepl("Takoma", name))

pull_poverty <- pull_creator(poverty_detail, c("name", "incpov_new"))

pull_tp_poverty <- pull_poverty(c("Takoma", "^.50 to"), "pct_cumul")

pull_mont_poverty <- pull_poverty(c("Montgomery", "^.50 to"), "pct_cumul")

pull_md_poverty <- pull_poverty(c("^Maryland$", "^.50 to"), "pct_cumul")

pull_tp_below150 <- pull_poverty(c("Takoma", "1.49"), "pct_cumul")

pull_mont_below150 <- pull_poverty(c("Mont", "1.49"), "pct_cumul")

pull_tp_below2 <- pull_poverty(c("Takoma", "1.99"), "pct_cumul")

pull_mont_below2 <- pull_poverty(c("Mont", "1.99"), "pct_cumul")

# totals
pull_tp_poverty_tot <- pull_poverty(c("Takoma", "^.50 to"), "tot_cumul")

pull_mont_poverty_tot <- pull_poverty(c("Montgomery", "^.50 to"), "tot_cumul")

pull_md_poverty_tot <- pull_poverty(c("^Maryland$", "^.50 to"), "tot_cumul")

pull_tp_below150_tot <- pull_poverty(c("Takoma", "1.49"), "tot_cumul")

pull_mont_below150_tot <- pull_poverty(c("Mont", "1.49"), "tot_cumul")

pull_tp_below2_tot <- pull_poverty(c("Takoma", "1.99"), "tot_cumul")

pull_mont_below2_tot <- pull_poverty(c("Mont", "1.99"), "tot_cumul")

```

```{r poverty sex}

poverty_sex <- data_binder("(poverty_sex_m)|(poverty_sex_M)|(poverty_sex_t)") %>%
  name_num_formatter() %>%
  filter(grepl("below", pov_status)) %>%
  signif_compare(filter_col = sex, filter_val = "^Male", join_col = location, est_col = pct_sex_pov, pct_moe_sex) %>%
  rename(signif_male = "signif_^male") %>%
  signif_mont_tp(join_col = "sex", name_pct = pct_sex_pov, pct_moe_sex) %>%
  signif_checker(signif_cols = c("Male" = "signif_male", "MC" = "signif_mont", "MD" = "signif_maryland"))

pull_pov_sex <- pull_creator(poverty_sex, c("sex", "location"))

pull_pov_female_tp <- pull_pov_sex(c("Female", "Takoma"), "pct_sex_pov")

pull_pov_male_tp <- pull_pov_sex(c("^Male", "Takoma"), "pct_sex_pov")


pull_pov_female_md <- pull_pov_sex(c("Female", "^Maryland"), "pct_sex_pov")

pull_pov_male_md <- pull_pov_sex(c("^Male", "^Maryland"), "pct_sex_pov")

plot_pov_sex <- plot_ly(poverty_sex,
                        x = ~ location,
                        y = ~ pct_sex_pov,
                        name = ~ sex,
                        text = ~ glue(
                          "Total: {pov_sex_tot %>% commafy}
                          Margin of error: {pct_moe_sex}%
                          Significant differences: {signif_check}"),
                        color = ~ sex) %>%
  layout(title = "Poverty by sex",
         xaxis = list(title = "Location"),
         yaxis = list(title = "Percent of sex in poverty"))

```

```{r houstype poverty}

recode_house_famtypepov_age <- function(df, famtype = famtype, householder = householder, age = age){
  
  fam_recode <- function(string){
    string %>%
      gsub(":", "", .)
  }
  
  householder_recode <- function(string){
    str <- string %>%
      gsub(":", "", .) %>%
      gsub(" householder", "", .)
    
    case_when(
      grepl("no spouse present", str) ~ paste0(
        "Single ",
        gsub(", no spouse present", "", tolower(str)),
        " family"),
      !grepl("family", str) ~ paste0(str, " nonfamily"),
      T ~ str
    )   
  }
  
  age_code <- function(string){
    string %>%
      gsub(" years", "", .) %>%
      gsub("Householder ", "", .) %>%
      gsub("under ", "< ", .) %>%
      gsub(" and over", "+", .) %>%
      gsub(" to ", " - ", .)
  }
  
  df %>%
    mutate(
      {{ famtype }} := fam_recode({{ famtype }}),
      {{ householder }} := householder_recode({{ householder }}),
      {{ age }} := age_code({{ age }})
    )
  
}


hous_famtype_pov_age <- data_binder("hous_famtype_pov_age") %>%
  name_num_formatter() %>%
    recode_house_famtypepov_age()


hous_famtype_pov <- hous_famtype_pov_age %>%
  est_moe_derive(group_cols = c("location", "householder"), name_col = "houstot") %>%
  select(-c(age, name, variable, label, estimate, moe)) %>%
  distinct() %>%
  derive_pct_est_moe(proportion_col = "pct_houspov", aggregate_est = "houstot_est", aggregate_moe = "houstot_moe", component_est = "povfamhous", component_moe = "povfamhous_moe") %>%
  signif_mont_tp(c("povlev", "householder"), name_pct = pct_houspov) %>%
  signif_overall(root_df = hous_famtype_pov_age, c("location", "povlev"), est_col = pct_houspov, moe_col = pct_moe) %>%
  signif_checker()

pull_house_pov <- (hous_famtype_pov %>%
  filter(grepl("below", povlev) & grepl("Takoma", location)) %>%
  pull(pct_overall))[1] %>%
  round(., 2)
  

plot_houstype_pov_tp <- plot_ly(hous_famtype_pov %>%
          filter(grepl("below", povlev) & grepl("Takoma", location)),
        x = ~ householder,
        y = ~ povfamhous,
        showlegend = F,
        color = ~ famtype,
        colors = "Accent",
        name = ~ famtype,
        hovertext = ~ glue(
          "Poverty rate: {pct_houspov}%"
          ),
        type = "bar",
        legendgroup = ~ location) %>%
  layout(xaxis = list(title = "Householder"),
         yaxis = list(title = "Households in poverty"),
         title = "Takoma Park households in poverty") %>%
  subplot_title("Takoma Park
                households in poverty")


plot_houstype_pov <- plot_ly(hous_famtype_pov %>%
          filter(grepl("below", povlev)),
        x = ~ householder,
        y = ~ pct_houspov,
        color = ~ location,
        name = ~ location,
        hovertext = ~ glue(
          "Significant differences: {signif_check}"
          ),
        type = "bar",
        legendgroup = ~ location) %>%
  dotted_line(df = hous_famtype_pov, 
              x_col = "householder", 
              line_val = pull_house_pov, 
              gluetext = "Household poverty
                    rate:
                    {pull_house_pov %>% round(1)}%") %>%
  layout(xaxis = list(title = "Householder"),
         yaxis = list(title = "Poverty rate"),
         title = "Poverty rate by household type") %>%
  subplot_title("Poverty-rate
                by location")
```

```{r pull housetype pov vals}

pull_houstyp_pov <- pull_creator(hous_famtype_pov %>%
                                   filter(grepl("below", povlev)), 
                                 c("location",
                                   "householder"),
                                 "pct_houspov")

pull_fem_pov_tp <- pull_houstyp_pov(c("Takoma", "Female nonfamily"), "povfamhous")
pull_mal_pov_tp <-  pull_houstyp_pov(c("Takoma", "^Male nonfamily"), "povfamhous")
pull_femfam_pov_tp <- pull_houstyp_pov(c("Takoma", "Single female"), "povfamhous")
pull_fem_pov_tp_pct <- pull_houstyp_pov(c("Takoma", "Female nonfamily"))
pull_marr_pov_tp_pct <- pull_houstyp_pov(c("Takoma", "Married"))
pull_femfam_pov_tp_pct <- pull_houstyp_pov(c("Takoma", "Single female"))

```

```{r houstype poverty age}

hous_famtype_pov_age_process <- hous_famtype_pov_age %>%
  est_moe_derive(c("location", "famtype", "householder", "age"), name_col = "famhousage_tot") %>%
  derive_pct_est_moe("pct_age", "famhousage_tot_est", "famhousage_tot_moe") %>%
  signif_mont_tp(c("povlev", "famtype", "householder", "age"), name_pct = pct_age, moe_pct = pct_moe) %>%
  signif_overall(hous_famtype_pov_age, group_cols = c("location", "povlev"), est_col = pct_age, moe_col = pct_moe) %>%
  signif_checker()

plot_hous_type_age_pov <- plot_ly(hous_famtype_pov_age_process %>%
          filter(grepl("below", povlev) & grepl("Takoma", location)) %>%
            mutate(householder = factor(householder, c("Female nonfamily", "Single female family", "Male nonfamily", "Single male family", "Married-couple family"), c("Female nonfamily", "Single female family", "Male nonfamily", "Single male family", "Married-couple family"))),
        x = ~ age,
        y = ~ estimate,
        color = ~ householder,
        hovertext = ~ glue(
          "Margin of error: {moe}
          Percent poverty: {pct_age}%
          Age/family total: {famhousage_tot_est}"
          ),
        name = ~ householder,
        text = ~ glue("{estimate}"),
        textposition = "inside",
        textfont = list(color = "black"),
        colors = "Paired",
        type = "bar") %>%
  layout(xaxis = list(title = "Age"),
         barmode = "stack",
         yaxis = list(title = "Households"),
         title = "Takoma Park households by type, age, and poverty")

pull_houstyp_pov_age <- pull_creator(hous_famtype_pov_age_process %>%
                                       filter(grepl("Takoma", location) & grepl("below", povlev)), 
                                     c("householder", "age"), "estimate")

pull_fem_nf_pov_65 <- pull_houstyp_pov_age(c("Female non", "65"))
pull_fem_fam_pov_2544 <- pull_houstyp_pov_age(c("Single female", "25 - 44"))
pull_mal_nf_pov_4564 <- pull_houstyp_pov_age(c("^Male non", "45 - 64"))

```


```{r family poverty}

recode_fam_occupants <- function(df, col_name = fam_occupants){
  recode_string <- function(string){
    dplyr::case_when(grepl("With related ", string) ~ "With children",
                     grepl("No related", string) ~ "No children")
  }
  
  df %>%
    dplyr::mutate({{col_name}} := recode_string({{col_name}}))
  
}

recode_child_age <- function(df, col_name = occupants_age){
  factor <- c("< 5", "5-17", "< 5 and 5-17", "No children")
  
  recode_string <- function(string){
    dplyr::case_when(grepl("years and ", string) ~ factor[3],
                     grepl("Under 5", string) ~ factor[1],
                     grepl("5 to 17", string) ~ factor[2],
                     grepl("No children", string) ~ factor[4])
  }
  
  df %>%
    dplyr::mutate({{col_name}} := recode_string({{col_name}}))
}

family_poverty <- data_binder("family_poverty_(M|m|t)") %>%
  name_num_formatter() %>%
  recode_houstype(fam_type) %>%
  recode_fam_occupants() %>%
  recode_child_age() %>%
  mutate(typ_child = glue("{fam_type}: {tolower(fam_occupants)}"))

# family_pov_age <- family_poverty %>%
#   process_df_tp(
#     group_cols = c("location", "typ_child","occupants_age", "pov_status"),
#     overall_cols = c("location", "typ_child","occupants_age"), 
#     name_col = "occ"
#   ) %>%
#     filter(grepl("below poverty level", pov_status))


family_pov <- family_poverty %>%
  process_df_tp(
    group_cols = c("location", "typ_child", "pov_status"),
    overall_cols = c("location", "typ_child"),
    name_col = "pov_fam"
  ) %>%
  filter(grepl("below poverty level", pov_status))


plot_family_pov_loc <- plot_ly(family_pov,
                               x = ~ location,
                               y = ~ pct_pov_fam,
                               type = "bar",
                               text = ~ glue("Total:{pov_fam_est %>% commafy}
        Margin of error: {pct_moe}%
        Significant differences: {signif_check}"),
        color = ~ typ_child,
        colors = "Paired",
        legendgroup = ~ typ_child,
        name = ~ typ_child) %>%
  dotted_line(df = family_pov, 
              x_col = "location", 
              line_val = pull_tp_poverty, 
              gluetext = "Household poverty
                    rate:
                    {pull_house_pov}%") %>%
  layout(title = "",
         xaxis = list(title = ""),
         yaxis = list(title = "Percent in poverty")) %>%
  subplot_title("Poverty rate")


plot_family_pov_tp <- plot_ly(family_pov %>%
                                filter(grepl("Takoma Park", location)),
                              x = ~ typ_child,
                              y = ~ pov_fam_est,
                              type = "bar",
                              text = ~ glue("Percent poverty:{pct_pov_fam}%
        Margin of error: {pov_fam_moe}
        Significant differences: {signif_check}"),
        color = ~ typ_child,
        legendgroup = ~ typ_child,
        colors = "Paired",
        showlegend = F,
        name = ~ typ_child) %>%
  layout(title = "",
         xaxis = list(title = ""),
         yaxis = list(title = "Total in poverty")) %>%
  subplot_title("Takoma Park households in poverty")

# plot_family_pov_age_tp <- plot_ly(family_pov_age %>%
#                                     filter(grepl("Takoma", location)),
#                                   x = ~ occupants_age,
#                                   name = ~ typ_child,
#                                   y = ~ pct_occ,
#                                   color = ~ typ_child)


pull_family_pov <- pull_creator(family_pov, c("location", "typ_child"), "pct_pov_fam")

pull_fem_child_pov <- pull_family_pov(c("Takoma", "Female: with "))
pull_mal_child_pov <- pull_family_pov(c("Takoma", "^Male: with "))
pull_marr_child_pov <- pull_family_pov(c("Takoma", "Married: with "))
pull_marr_nochild_pov <- pull_family_pov(c("Takoma", "Married: no chi"))
pull_fem_child_pov_tot <- pull_family_pov(c("Takoma", "Female: with "), "pov_fam_est")
pull_marr_nochild_pov_tot <- pull_family_pov(c("Takoma", "Married: with "), "pov_fam_est")
pull_mal_child_pov_tot <- pull_family_pov(c("Takoma", "^Male: with "), "pov_fam_est")
pull_fem_child_pov_md <- pull_family_pov(c("Maryland", "Female: with "))


```

```{r family poverty age}

# family_pov_age <- family_poverty %>%
#   derive_pct_est_moe("age_pct_pov", aggregate_est = "pov_type_occ_tot", aggregate_moe = "pov_type_occ_tot_moe")

```


```{r family poverty race}

fam_pov_race <- data_binder("family_poverty_race") %>%
  filter(!grepl("white alone householder", race)) %>%
  mutate(race = gsub(pattern = " householder", "", race)) %>%
  race_recode(race_col = race) %>%
  name_num_formatter() %>%
  recode_houstype(fam_type) %>%
  recode_fam_occupants() %>%
  recode_child_age() %>%
  mutate(typ_child = glue("{fam_type}: {tolower(fam_occupants)}"))
# 
# fam_pov_race_process <- fam_pov_race %>%
#   process_df_tp(
#     group_cols = c("location", "race", "typ_child", "pov_status"),
#     overall_cols = c("location", "race", "typ_child"),
#     name_col = "pov_race"
#   ) %>%
#   filter(!race %in% tp_race_cats,
#          grepl("below ", pov_status),
#   )
# 
# # plot_fam_pov_race_tp_pct <- plot_ly(
# #   filter(fam_pov_race_process, grepl("Takoma", location)),
# #   x = ~ race,
# #   y = ~ pct_pov_race,
# #   color = ~ typ_child,
# #   name = ~ typ_child,
# #   legendgroup = ~ typ_child,
# #   text = ~ glue("Total: {pov_race_est}
# #                 Margin of error: {pct_moe}%
# #                 Significant differences: {signif_check}")
# # )
# 
# plot_fam_pov_race_tp_tot <- plot_ly(
#   filter(fam_pov_race_process, grepl("Takoma", location)),
#   x = ~ race,
#   y = ~ pov_race_est,
#   color = ~ typ_child,
#   name = ~ typ_child,
#   legendgroup = ~ typ_child,
#   textposition = "inside",
#   textfont = list(color = "black",
#                   opacity = 0.8),
#   # text = ~ glue("{pct_pov_race}%\npoverty"),
#   hovertext = ~ glue("Percent poverty: {pct_pov_race}%
#   Race/family type total: {tot_est %>% commafy}
#   Margin of error: {pov_race_moe}
#   Significant differences: {signif_check}")) %>%
#   layout(
#     # barmode = "stack",
#          title = "Takoma Park families in poverty by race",
#          xaxis = list(title = ""),
#          yaxis = list(title = "Families in poverty"))
# 
# gen_plot_fam_pov_race_loc <- function(race_val, showleg){
#   df <- fam_pov_race_process %>%
#     filter(grepl(race_val, race)) %>%
#     mutate(typ_child = gsub(": ", "\n", typ_child))
# 
#   plot_ly(df,
#           x = ~ location,
#           y = ~ pct_pov_race,
#           name = ~ typ_child,
#           hovertext = ~ glue("Total: {pov_race_est %>% commafy}
#                              Margin of error: {pov_race_moe}%
#                              Race/family-type total: {tot_est}
#                              Significant differences: {signif_check}"),
#           color = ~ typ_child,
#           type = "bar",
#           showlegend= showleg,
#           legendgroup = ~ typ_child) %>%
#     layout(xaxis = list(title = ""),
#            yaxis = list(title = "Poverty rate",
#                         range = c(0, 40)),
#            title = "") %>%
#     subplot_title(race_val)
# 
# }



```


<!-- ```{r plot family poverty race} -->

<!-- # omitting because too small samples -->
<!-- plots_fam_pov_race_loc <- subplot( -->
<!--   map(c("White", "Black", "Hispanic"), ~ gen_plot_fam_pov_race_loc(.x, ifelse(.x == "White", T, F))), shareY = T -->
<!-- ) %>% -->
<!--   layout(xaxis = list(title = ""), -->
<!--          yaxis = list(title = "Poverty-rate"), -->
<!--          title = "Family poverty rates by race and location") -->

<!-- subplot(plots_fam_pov_race_loc, plot_fam_pov_race_tp_tot, nrows = 2) -->

<!-- ``` -->



```{r poverty sex race}

poverty_sex_race_root <- data_binder("poverty_sex_race") %>%
  filter(!grepl("hispanic", race)) %>%
  name_num_formatter() %>%
  race_recode(race) %>%
  rename(estimate = pov_race_sex_tot,
         moe = pov_race_sex_tot_moe)

poverty_sex_race <- data_binder("poverty_sex_race") %>%
  filter(!grepl("white alone$", race)) %>%
  name_num_formatter() %>%
  race_recode(race) %>%
  filter(!race %in% c("NHPI", "AIAN")) %>%
  signif_compare(sex, "^Male", c(race, pov_status, location), pct_race_sex_pov, pct_moe_race_sex_pov) %>%
  rename(signif_male = 'signif_^male') %>%
  signif_compare(race, "White", c(sex, pov_status, location), pct_race_sex_pov, pct_moe_race_sex_pov) %>%
  signif_mont_tp(c("race", "pov_status", "sex"), pct_race_sex_pov, pct_moe_race_sex_pov) %>%
  signif_overall(poverty_sex_race_root, c("location", "pov_status"), est_col = pct_race_sex_pov, pct_moe_race_sex_pov, "race") %>%
  signif_checker(list("Overall" = "signif_overall",
                      "MC" = "signif_mont",
                      "MD" = "signif_maryland",
                      "white" = "signif_white",
                      "male" = "signif_male")) %>%
  filter(grepl("below", pov_status))

plot_pov_race_sex <- function(sex_val, showlegend = F, pov_text = F){
  
  df <- poverty_sex_race %>%
    filter(grepl(paste0("^", sex_val), sex))
  
  plot <- plot_ly(df,
                  x = ~ race,
                  y = ~ pct_race_sex_pov,
                  showlegend = showlegend,
                  color = ~ location,
                  hovertext = ~ glue(
                    "Total: {pov_race_sex_tot}
            Significant differences: {signif_check}
            Margin of error: {pct_moe_race_sex_pov}%"),
            legendgroup = ~ location,
            name = ~ location,
            type = "bar") %>%
    subplot_title(sex_val) 
  
  if (pov_text) {
    plot <- plot %>%
      dotted_line(df = df, 
                  "race", 
                  line_val = pull_tp_poverty, 
                  gluetext = "City poverty rate:
                  {pull_tp_poverty}%")
  }
  else{
    plot <- plot %>%
      dotted_line(df = df,
                  "race",
                  pull_tp_poverty,
                  gluetext = "",
                  .showarrow = F)
  }
  
  plot
  
}



plots_pov_race_sex <- subplot(
  plot_pov_race_sex("Male", T, T),
  plot_pov_race_sex("Female"),
  shareY = T
) %>%
  layout(yaxis = list(title = "Poverty rate"),
         xaxis = list(title = ""),
         title = "Poverty rate by sex and race")



```



<!-- ```{r family race} -->

<!-- fam_race <- fam_pov_race %>% -->
<!--   process_df_tp( -->
<!--     group_cols = c("location", "race", "typ_child"), -->
<!--     overall_cols = c("location", "race"),  -->
<!--     name_col = "typ" -->
<!--   ) %>% -->
<!--   filter(!race %in% tp_race_cats) -->

<!-- plot_tp_fam_race <- plot_ly( -->
<!--   fam_race %>%  -->
<!--     filter(grepl("Takoma", location)), -->
<!--   x = ~ race, -->
<!--   y = ~ typ_est, -->
<!--   name = ~ typ_child, -->
<!--   color = ~ typ_child, -->
<!--   text = ~ glue("{pct_typ %>% round(1)}%"), -->
<!--   hovertext = ~ glue("Percent: {pct_typ}% -->
<!--   Margin of error: {pct_moe}% -->
<!--   Race total: {tot_est} -->
<!--   Significant differences: {signif_check}"), -->
<!--   textposition = "inside", -->
<!--   textfont = list( -->
<!--     color = "black" -->
<!--   ), -->
<!--   legendgroup = ~ typ_child, -->
<!--   type = "bar") %>% -->
<!--   layout(barmode = "stack", -->
<!--          title = "Takoma Park families by type and children", -->
<!--          xaxis = list(title = ""), -->
<!--          yaxis = list(title = "Families")) -->



<!-- # gen_plot_fam_race <- function(race_val, showleg = F){ -->
<!-- #    -->
<!-- #   ytitle <- case_when(showleg ~ "Percent households", -->
<!-- #                       T ~ "") -->
<!-- #    -->
<!-- #   plot_ly(fam_race %>% -->
<!-- #             filter(grepl(race_val, race)), -->
<!-- #           x = ~ location, -->
<!-- #           y = ~ pct_typ, -->
<!-- #           name = ~ typ_child, -->
<!-- #           showlegend = showleg, -->
<!-- #           color = ~ typ_child, -->
<!-- #           text = ~ glue("{pct_typ}%"), -->
<!-- #           textposition = "inside", -->
<!-- #           # legendgroup = ~ typ_child, -->
<!-- #           textfont = list(color = "black"), -->
<!-- #           legendgroup = ~ typ_child, -->
<!-- #           hovertext = ~ glue("Total: {typ_est} -->
<!-- #                              Margin of error: {pct_moe}% -->
<!-- #                              Significant differences: {signif_check}"), -->
<!-- #           type = "bar") %>% -->
<!-- #     layout(barmode = "stack", -->
<!-- #            xaxis = list(title = ""), -->
<!-- #            title = "Race by family type", -->
<!-- #            yaxis = list(title = ytitle)) %>% -->
<!-- #     subplot_title(race_val, .y = 1.1) -->
<!-- #    -->
<!-- # }  -->
<!-- #  -->
<!-- # plots_fam_race <- subplot(map(levels(fam_race$race)[-c(7:8)], ~ gen_plot_fam_race(.x, ifelse(.x == "Hispanic", T, F))), shareY = T, nrows = 3, shareX = T) %>%  -->
<!-- #   layout(title = "Percent households by race and location", -->
<!-- #          xaxis = list(title = "")) -->

<!-- # plots_fam_race -->

<!-- # text_ -->



<!-- plot_tp_fam_race -->

<!-- text_fam_race <- glue("") -->

<!-- ``` -->


```{r pull pov sex race vals}
pull_pov_sex_race <- pull_creator(poverty_sex_race, c("location", "sex", "race"))

pull_pov_tp_female_black <- pull_pov_sex_race(c("Takoma", "Female", "Black"), 
                                              "pct_race_sex_pov")

pull_pov_tp_male_black <- pull_pov_sex_race(c("Takoma", "^Male", "Black"), 
                                            "pct_race_sex_pov")


pull_pov_tp_female_white <- pull_pov_sex_race(c("Takoma", "Female", "white"), 
                                              "pct_race_sex_pov")

pull_pov_tp_male_white <- pull_pov_sex_race(c("Takoma", "^Male", "white"), 
                                            "pct_race_sex_pov")

pull_pov_tp_male_multiracial <- pull_pov_sex_race(c("Takoma", "^Male", "multi"), 
                                                  "pct_race_sex_pov")

pull_pov_md_female_white <- pull_pov_sex_race(c("Maryland", "Female", "white"), 
                                              "pct_race_sex_pov")

pull_pov_md_male_white <- pull_pov_sex_race(c("Maryland", "^Male", "white"), 
                                            "pct_race_sex_pov")

pull_pov_md_male_black <- pull_pov_sex_race(c("Maryland", "^Male", "black"), 
                                            "pct_race_sex_pov")

pull_pov_md_male_multiracial <- pull_pov_sex_race(c("Maryland", "^Male", "multi"), 
                                                  "pct_race_sex_pov")


pull_pov_tp_female_hispanic <- pull_pov_sex_race(c("Takoma", "Female", "hispanic"), 
                                                 "pct_race_sex_pov")

pull_pov_tp_female_other <- pull_pov_sex_race(c("Takoma", "Female", "other"), 
                                              "pct_race_sex_pov")


pull_pov_tp_male_hispanic <- pull_pov_sex_race(c("Takoma", "^Male", "hispanic"), 
                                               "pct_race_sex_pov")



text_pov_race_sex_p1 <- glue("**Estimates of poverty rates for women exceed men, although the magnitude of the difference varies by race.** The only difference between poverty rates by sex that appears as statistically-significant in Takoma Park is between Black women's poverty rate of {pull_pov_tp_female_black}% and Black men's rate of {pull_pov_tp_male_black}%. However, it is reasonable to assume that poverty rates for women are actually-higher for other races even if we're not sure how much because they're higher in Maryland and Montgomery County. In Maryland, poverty rates for women are higher than men at a statistically-significant level for all races except Asian; in Montgomery County, for all but multiracial residents.

**There are not statistically-significant differences in poverty rates by race between Takoma Park and Marlyand or Montgomery County, with a few exceptions.** The {pull_pov_tp_male_white}% poverty rate for white men in Takoma Park and the {pull_pov_tp_female_white}% poverty rate for white women fall below the {pull_pov_md_male_white}% rate for white men and {pull_pov_md_female_white}% rate for white women in Maryland; the {pull_pov_tp_male_black}% poverty rate for Black men in Takoma Park falls below the {pull_pov_md_male_black}% rate in Maryland; and the {pull_pov_tp_male_multiracial}% poverty rate for multiracial men in Takoma Park falls below the {pull_pov_md_male_multiracial}% poverty rate in Maryland.")

text_pov_race_sex_p2 <- glue("**Compared to white residents of the same sex in Takoma Park, female Black, Hispanic (with a poverty rate of {pull_pov_tp_female_hispanic}%), and 'other' ({pull_pov_tp_female_other}%) residents have a higher poverty rate than female white residents; and Black male residents have a higher poverty rate than white male residents.** Compared to the city's overall poverty rate of {pull_tp_poverty}%, white male, white female, and multiracial male residents have a lower poverty rate; and Black female residents have a higher poverty rate. It is likely that poverty rates in the same-sex for other races are higher than white-residents even if they do not show as statistically significant in Takoma Park. In the larger sample of Maryland and Montgomery County, there are statistically-significant differences between white male residents and male residents of all other races, and between white female residents and female residents of all other races (except in Maryland, for Asian women).")

```


```{r poverty sex age}

poverty_sex_age <- data_binder("poverty_age_sex") %>%
  name_num_formatter() %>%
  age_recode(age_col = age, regroup = "sex_age") %>% 
  est_moe_derive(c("name", "pov_status", "sex", "age_group"), name_col = "new_age") %>%
  est_moe_derive(c("name", "sex", "age_group"), name_col = "sex_age_pop") %>%
  filter(grepl("below", pov_status)) %>%
  select(location, name,  pov_status, sex, age_group,  pop, pop_moe, pov_tot_est, pov_tot_moe, pov_sex_tot, pov_sex_tot_moe, sex_pop_est, sex_pop_moe, sex_age_pop_est, sex_age_pop_moe, new_age_est, new_age_moe) %>%
  rename(estimate = new_age_est, moe = new_age_moe) %>%
  distinct %>%
  derive_pct_est_moe("pct_sex_pov", 
                     "pov_sex_tot",
                     "pov_sex_tot_moe"
  ) %>%
  rename(pct_moe_sex_pov = pct_moe) %>%
  derive_pct_est_moe("pct_pop", 
                     "pop",
                     "pop_moe",
  ) %>% 
  rename(pct_moe_pop = pct_moe) %>%
  derive_pct_est_moe("pct_sex_pop", 
                     "sex_pop_est",
                     "sex_pop_moe") %>%
  rename(pct_moe_sex_pop = pct_moe) %>%
  derive_pct_est_moe("pct_pop_pov", 
                     "pov_tot_est",
                     "pov_tot_moe") %>%
  rename(pct_moe_pop_pov= pct_moe) %>%
  derive_pct_est_moe("pct_sex_age",
                     "sex_age_pop_est",
                     "sex_age_pop_moe") %>%
  signif_compare(sex, "^Male", join_col = c(location, age_group), pct_sex_age, pct_moe) %>%
  rename_with(.fn = ~ gsub("\\^", "", .x), .cols = contains("male")) %>%
  signif_mont_tp(c("location", "age_group", "sex"), name_pct = pct_sex_age, pct_moe) %>%
  signif_checker(list("MC"= "signif_mont", "MD" = "signif_maryland", "Male" = "signif_male"))

plot_pov_sex_age <- function(sex_val, showleg){
  plot_ly(poverty_sex_age %>%
            filter(sex == sex_val),
          x = ~ age_group,
          y = ~ pct_sex_age,
          color = ~ location,
          name = ~ location,
          legendgroup = ~ location,
          showlegend = showleg,
          hovertext = ~ glue(
            "Total: {estimate %>% commafy}
          Sex/age-group population: {sex_age_pop_est  %>% commafy}
          Significant differences: {signif_check}
          Margin of error: {pct_moe}%"),
          type = "scatter",
          mode = "line+marker") %>%
    layout(xaxis = list(title = "Age"),
           yaxis = list(title = "Percent sex/age group"),
           title = "Poverty by age and sex") %>%
    subplot_title(sex_val)
}

plot_pov_sex_age_tot <-  plot_ly(poverty_sex_age %>%
                                   filter(location == "Takoma Park"),
                                 x = ~ age_group,
                                 y = ~ estimate,
                                 color = ~ sex,
                                 name = ~ sex,
                                 legendgroup = ~ sex,
                                 showlegend = T,
                                 colors = "Dark2",
                                 hovertext = ~ glue(
                                   "Percent sex-age-group: {pct_sex_age}%
          Sex/age-group population: {sex_age_pop_est  %>% commafy}
          Significant differences: {signif_check}
          Margin of error: {pct_moe}%"),
          type = "bar") %>%
  layout(xaxis = list(title = ""),
         yaxis = list(title = "Total residents in poverty"),
         title = "Poverty by age and sex") %>%
  subplot_title("Total")

plots_pov_sex_age <- subplot(
  plot_pov_sex_age("Male:", T),
  plot_pov_sex_age("Female:", F),
  plot_pov_sex_age_tot,
  nrows = 2,
  shareY = T,
  shareX = T
)

```


```{r unemployment overall, echo=FALSE}

unemploy_gender_age <- data_binder(file_root = "employment_age_gender")

unemploy_gender_age_root <- unemploy_gender_age %>%
  filter(employment_status != "In Armed Forces") %>%
  rename(estimate = workers_est, moe = workers_moe) %>%
  name_num_formatter()

unemploy_overall_processed <- process_df_tp(unemploy_gender_age_root, 
                                            group_cols = c("location", "employment_status"),
                                            overall_cols = "location", 
                                            name_col = "workers",
                                            signif_cols = list("MC" = "signif_mont",
                                                               "MD" = "signif_maryland"))

# unemploy_overall <- unemploy_gender_age %>%
#   filter(employment_status != "In Armed Forces") %>%
#   est_moe_derive(group_cols = "name", "workers_est", "workers_moe", name_col = "total_labor_force") %>%
#   name_num_formatter() %>%
#   est_moe_derive(c("name", "location", "employment_status", "total_labor_force_est"), "workers_est", moe_col = "workers_moe", name_col = "workers")  %>%
#   select(name, location, employment_status, total_labor_force_est, total_labor_force_moe, workers_est, workers_moe) %>%
#   distinct() %>%
#   derive_pct_est_moe(proportion_col = "pct_labor", aggregate_est = "total_labor_force_est", aggregate_moe = "total_labor_force_moe", component_est = "workers_est", "workers_moe")

pull_unemploy_overall <- pull_creator(unemploy_overall_processed, filter_col = c("location", "employment_status"))

pull_tp_unemploy <- pull_unemploy_overall(c("Takoma", "unemp"), "pct_workers") %>% round(., 1)

pull_tp_unemploy_num <- pull_unemploy_overall(c("Takoma", "unemp"), "workers_est") %>% round(., 1)


pull_md_unemploy <- pull_unemploy_overall(c("^Maryland$", "unemp"), "pct_workers") %>% round(., 1)

pull_mont_unemploy <- pull_unemploy_overall(c("Mont", "unemp"), "pct_workers") %>% round(., 1)


```


```{r race unemployment}
# load in race/employment data
race_employment_u65 <- data_binder("race_employment_u65") %>%
  # filter(!grepl("white alone$", race)) %>%
  # race_recode(race) %>%
  name_num_formatter()

# pre-process data - exclude hispanic to calculate population totals
race_employment_u65_root <- race_employment_u65 %>%
  filter(!grepl("hispanic", race,
                ignore.case = T)) %>%
  rename(estimate = workers_est,
         moe = workers_moe)

# 
race_employment_u65 <- race_employment_u65 %>%
  rename(estimate = workers_est,
         moe = workers_moe) %>%
  name_num_formatter() %>%
  signif_overall(race_employment_u65_root, 
                 group_cols = c("location", "employment_status"),
                 est_col = pct_race,
                 moe_col = pct_moe,
                 "race") %>%
  signif_mont_tp(c("employment_status", "race"), name_pct = pct_race) %>%
  filter(!grepl("white alone$", race)) %>%
  signif_compare(race, 
                 "white", 
                 c("location", "employment_status"), 
                 est_col = pct_race,
                 moe_col = pct_moe)


race_unemploy <- race_employment_u65 %>%
  filter(grepl("unemployed", employment_status, ignore.case = TRUE) & (estimate > 0 | race == "Overall")) %>%
  num_formatter() %>%
  race_recode(race) %>%
  # name_num_formatter() %>%
  signif_checker(list("Overall" = "signif_overall",
                      "MC" = "signif_mont",
                      "MD" = "signif_maryland",
                      "White" = "signif_white"))

tp_race_unemploy <- race_unemploy %>%
  filter(grepl("Takoma", name))

# tp_race_cats <- race_unemploy %>%
#   filter((estimate <= 30 | race != "Overall") & grepl("Takoma", location)) %>%
#   pull(race)

pull_tp_race_unemploy <- pull_creator(tp_race_unemploy, "race")

pull_tp_black_unemploy <- pull_tp_race_unemploy("Black", "pct_race")

pull_tp_black_unemploy_tot <- pull_tp_race_unemploy("Black", "estimate")


pull_tp_hispanic_unemploy <- pull_tp_race_unemploy("hispanic", "pct_race")

pull_tp_hispanic_unemploy_moe <- pull_tp_race_unemploy("hispanic", "pct_moe")


pull_tp_white_unemploy <- pull_tp_race_unemploy("white", "pct_race")

pull_tp_white_unemploy_tot <- pull_tp_race_unemploy("white", "estimate")


# pull_tp_overall_unemploy <- pull_tp_race_unemploy("Overall", "pct_race")


pull_race_unemploy <- pull_creator(race_unemploy, c("name", "race"))

pull_mont_black_unemploy <- pull_race_unemploy(c("Montgomery", "Black"), "pct_race")

pull_mont_hispanic_unemploy <- pull_race_unemploy(c("Montgomery", "hispanic"), "pct_race")

pull_mont_white_unemploy <- pull_race_unemploy(c("Montgomery","white"), "pct_race")

pull_md_black_unemploy <- pull_race_unemploy(c("^Maryland$", "Black"), "pct_race")

pull_md_hispanic_unemploy <- pull_race_unemploy(c("^Maryland$","hispanic"), "pct_race")

pull_md_white_unemploy <- pull_race_unemploy(c("^Maryland$","white"), "pct_race")


```


```{r unploy age}
# create root dataset
unemploy_root <- unemploy_gender_age %>% 
  filter(employment_status != "In Armed Forces") %>%
  rename(estimate = workers_est,
         moe = workers_moe) %>%
  name_num_formatter() %>%
  age_recode(age_range)

# process data
unemploy_age_processed <- process_df_tp(unemploy_root, 
                                        group_cols = c("location", "age_new", "employment_status"), 
                                        overall_cols = c("location", "employment_status"), 
                                        name_col = "labor", 
                                        bind_overall = NULL) %>%
  age_recode(age_col = age_new)


# pull ages
pull_unemployed_age <- pull_creator(unemploy_age_processed %>% filter(employment_status == "Unemployed"), c("location", "age_new"))

pull_tp_unemploy_2021 <- pull_unemployed_age(c("Takoma", "20-21"), "pct_labor")


pull_tp_unemploy_4554 <- pull_unemployed_age(c("Takoma", "45-54"), "pct_labor")

pull_mont_unemploy_4554 <- pull_unemployed_age(c("Mont", "45-54"), "pct_labor")

pull_md_unemploy_4554 <- pull_unemployed_age(c("Maryland", "45-54"), "pct_labor")


```


```{r plot race income}
plot_raceincome <- plot_ly(race_income_data %>%
                             race_factor(),
                           type = "bar",
                           hovertext = ~ glue("Margin of error: ${moe %>% commafy}"),
                           y = ~ location,
                           text = ~ glue("{race}: ${estimate %>% commafy}"),
                           name = ~ race,
                           textposition = "inside",
                           textfont = list(color = "black"),
                           # opacity = 0.8,
                           color = ~ race,
                           colors = pal_race,
                           opacity = 0.8,
                           x = ~ estimate, 
                           # error_x = list(array = ~ moe),
                           orientation = "h") %>%
  layout(legend = list(orientation = "h"),
         xaxis = list(title = ""),
         yaxis = list(title = ""),
         title = "Median household income by race") 

```



```{r poverty race}

poverty_race_age <- data_binder("poverty_race_age") %>%
  name_num_formatter() %>%
  mutate(race_place = paste0(location, "_", race))

# calculate overall poverty rate/moe and bind/merge to data for stat significance testing
poverty_overall <- poverty_race_age %>%
  filter(!grepl("hispanic", race)) %>%
  est_moe_derive("name", name_col = "pop_tot") %>%
  est_moe_derive(c("name", "poverty"), name_col = "incpov_tot") %>%
  select(name, location, poverty, pop_tot_est, pop_tot_moe, incpov_tot_est, incpov_tot_moe) %>%
  distinct %>%
  derive_pct_est_moe("pct_incpov_overall",
                     "pop_tot_est",
                     "pop_tot_moe",
                     "incpov_tot_est",
                     "incpov_tot_moe") %>%
  mutate(race = "Overall")

poverty_overall_join <- poverty_overall %>%
  select(name, location, poverty, incpov_tot_est, incpov_tot_moe, pct_incpov_overall, pct_moe) %>%
  rename(pct_overall_moe = pct_moe)

poverty_overall_bind <- poverty_overall %>%
  rename(race_tot = pop_tot_est,
         race_tot_moe = pop_tot_moe,
         pct_poverty = pct_incpov_overall,
         poverty_tot = incpov_tot_est,
         poverty_tot_moe = incpov_tot_moe)


poverty_race_age_nohisp <- poverty_race_age %>%
  filter(race != "white alone") %>%
  race_recode(race)

poverty_race <- poverty_race_age_nohisp %>%
  select(location, name, race_place, race, poverty, race_tot, race_tot_moe, poverty_tot, poverty_tot_moe) %>%
  distinct %>%
  derive_pct_est_moe("pct_poverty",
                     "race_tot",
                     "race_tot_moe",
                     "poverty_tot",
                     "poverty_tot_moe") %>%
  name_num_formatter() %>%
  dplyr::bind_rows(poverty_overall_bind) %>%
  left_join(poverty_overall_join) %>%
  name_num_formatter() %>%
  filter(!race %in% tp_race_cats & !grepl("above", poverty)) %>%
  mutate(crit_value = signif_test(est1 = pct_poverty,
                                  est2 = pct_incpov_overall, 
                                  moe1 = pct_moe,
                                  moe2 = pct_overall_moe)[[1]],
         signif = signif_test(est1 = pct_poverty,
                              est2 = pct_incpov_overall, 
                              moe1 = pct_moe,
                              moe2 = pct_overall_moe)[[2]])


# compare poverty mont county
poverty_race_mont <- poverty_race %>%
  filter(grepl("Montgomery", location)) %>%
  select(race, pct_poverty, pct_moe) %>%
  rename(mont_poverty = pct_poverty,
         mont_moe = pct_moe)

poverty_race_md <- poverty_race %>%
  filter(grepl("Maryland", location)) %>%
  select(race, pct_poverty, pct_moe) %>%
  rename(md_poverty = pct_poverty,
         md_moe = pct_moe)

poverty_race_white <- poverty_race %>%
  filter(grepl("White", race)) %>%
  select(name, pct_poverty, pct_moe) %>%
  rename(white_poverty = pct_poverty,
         white_moe = pct_moe)

# calculate significance of differences
poverty_race <- poverty_race %>%
  left_join(poverty_race_mont) %>%
  left_join(poverty_race_md) %>%
  left_join(poverty_race_white) %>%
  mutate(mont_diff_sig = signif_test(pct_poverty, mont_poverty, pct_moe, mont_moe)[[2]],
         md_diff_sig = signif_test(pct_poverty, md_poverty, pct_moe, md_moe)[[2]],
         white_diff_sig = signif_test(pct_poverty, white_poverty, pct_moe, white_moe)[[2]],
         pct_all = pct_round(poverty_tot, incpov_tot_est)) %>%
  signif_checker(list("Overall" = "signif",
                      "MC" = "mont_diff_sig",
                      "MD" = "md_diff_sig",
                      "White" = "white_diff_sig"))

poverty_race_tp <- poverty_race %>%
  filter(grepl("Takoma", location))

pull_poverty_race <- pull_creator(poverty_race, c("location", "race"))

pull_tp_poverty_white <- pull_poverty_race(c("Takoma", "White"), "pct_poverty")

pull_tp_poverty_hispanic <- pull_poverty_race(c("Takoma", "hispanic"), "pct_poverty")


pull_tp_poverty_black <- pull_poverty_race(c("Takoma", "black"), "pct_poverty")

pull_tp_poverty_overall <- pull_poverty_race(c("Takoma", "overall"), "pct_poverty")

pull_tp_poverty_asian <- pull_poverty_race(c("Takoma", "asian"), "pct_poverty")

pull_tp_poverty_other <- pull_poverty_race(c("Takoma", "other"), "pct_poverty")

pull_tp_poverty_other_moe <- pull_poverty_race(c("Takoma", "other"), "pct_moe")



pull_tp_poverty_black_pctall <- pull_poverty_race(c("Takoma", "black"), "pct_all")

pull_tp_poverty_white_pctall <- pull_poverty_race(c("Takoma", "white"), "pct_all")

pull_tp_poverty_hispanic_pctall <- pull_poverty_race(c("Takoma", "hispanic"), "pct_all")



pull_tp_poverty_black_tot <- pull_poverty_race(c("Takoma", "black"), "poverty_tot")

pull_tp_poverty_white_tot <- pull_poverty_race(c("Takoma", "white"), "poverty_tot")

pull_tp_poverty_hispanic_tot <- pull_poverty_race(c("Takoma", "hispanic"), "poverty_tot")


pull_md_poverty_white <- pull_poverty_race(c("^Maryland", "White"), "pct_poverty")

pull_mont_poverty_white <- pull_poverty_race(c("Montgomery", "White"), "pct_poverty")

#
text_poverty_race <- glue("**There are significant racial disparities in poverty rates.** The most residents in poverty by race are Black (representing {pull_tp_poverty_black_tot} total residents), followed by Hispanic ({pull_tp_poverty_hispanic_tot}) and white ({pull_tp_poverty_white_tot}) residents. As discussed previously, the official poverty line undercounts the number of residents actually experiencing poverty, but the Census does not make race-disaggregated data available on residents' income relative to the poverty line. The counts of residents in poverty discussed here undercount the number of residents actually experiencing poverty, even if we cannot know the exact count.

**Shares of persons in poverty differ from population shares.** Black residents represent {pull_black_tp_pct}% of the city's population but {pull_tp_poverty_black_pctall}% of residents in poverty, and their poverty rate of {pull_tp_poverty_black}% has a statistically significant difference from the city's rate of {pull_tp_poverty_overall}%. White residents make up {pull_white_tp_pct}% of the city's population but just {pull_tp_poverty_white_pctall}% of those in poverty, with a statistically-lower poverty rate of {pull_tp_poverty_white}%.

**Residents of multiple races have a statistically-higher poverty rate than white residents at a 90% level of confidence,** including Black residents, Hispanic residents ({pull_tp_poverty_hispanic}%), and Asian residents ({pull_tp_poverty_asian}%). Residents with a race of 'other' in the data have the highest estimate of their poverty rate at {pull_tp_poverty_other}%, but the high margin of error of {pull_tp_poverty_other_moe}% means our estimate of these residents' actual poverty rate at a 90% confidence level falls between {pull_tp_poverty_other - pull_tp_poverty_other_moe}% and {pull_tp_poverty_other + pull_tp_poverty_other_moe}%.

There is not a statistically significant difference between poverty rates of different races in Takoma Park vs Maryland or Montgomery County, except that white residents have a lower poverty rate of {pull_tp_poverty_white}% than Maryland ({pull_md_poverty_white}%).")

text_poverty_race_summary <- glue("**There are significant racial disparities in poverty by race.** 
Black residents represent {pull_black_tp_pct}% of the city's population but {pull_tp_poverty_black_pctall}% of residents in poverty, and their poverty rate of {pull_tp_poverty_black}% has a statistically significant difference from the city's rate. White residents make up {pull_white_tp_pct}% of the city's population but just {pull_tp_poverty_white_pctall}% of those in poverty, with a statistically-lower poverty rate of {pull_tp_poverty_white}%. Poverty rates for Hispanic residents ({pull_tp_poverty_hispanic}%), and Asian residents ({pull_tp_poverty_asian}%) also exceed white residents by a statistically significant degree.")

```


```{r plot poverty race}

sub_poverty_race <- plot_ly(poverty_race %>%
                              race_factor(),
                            x = ~ location,
                            y = ~ pct_poverty,
                            hovertext = ~ glue("Total: {poverty_tot %>% commafy}
                           Margin of error: {pct_moe}%
                           Significant differences: {signif_check}}"),
                           name = ~ race,
                           legendgroup = ~ race,
                           color = ~ race,
                           colors = pal_race,
                           opacity = 0.8) %>%
  layout(title = "Poverty by race",
         xaxis = list(title = ""),
         yaxis = list(title = "Percent poverty")) %>%
  subplot_title("Percent in poverty") %>%
  dotted_line("location",df = poverty_race, pull_tp_poverty, gluetext = "City poverty
              rate: {pull_tp_poverty}%")

sub_poverty_race_tot <- plot_ly(poverty_race_tp %>%
                                  filter(!grepl("Overall", race)) %>%
                                  race_factor(),
                                x = ~ race,
                                y = ~ poverty_tot,
                                name = ~ race,
                                legendgroup = ~ race,
                                hovertext = ~ glue("Percent all: {pct_all}%
                                                   Poverty rate: {pct_poverty}%"),
                                showlegend = F,
                                color = ~ race,
                                colors = pal_race,
                                opacity = 0.8,
                                type = "bar") %>%
  layout(xaxis = list(title = ""),
         yaxis = list(title = "Total residents"),
         title = "") %>%
  subplot_title("Takoma Park residents in poverty")


plot_race_poverty <- subplot(sub_poverty_race, sub_poverty_race_tot, nrows = 2) %>%
  layout(title = "Poverty by race")

```


```{r poverty age}

poverty_age_root <- poverty_race_age %>%
  old_recode(age) %>%
  age_recode(age, F) %>%
  filter(!grepl("hispanic", race, ignore.case = T))

poverty_age_processed <- process_df_tp(poverty_age_root, 
                                       group_cols = c("location", "age_new", "poverty"),
                                       overall_cols = c("location", "poverty"),
                                       name_col = "agepov", 
                                       bind_overall = "age_new") %>%
  filter(grepl("below", poverty)) %>%
  age_recode(age_new) %>%
  signif_checker()


pull_poverty_age <- pull_creator(poverty_age_processed, c("location", "age_new"))

pull_tp_poverty_overall <- pull_poverty_age(c("Takoma", "Overall"), "pct_agepov")
pull_tp_poverty_75 <- pull_poverty_age(c("Takoma", "75+"), "pct_agepov")
pull_tp_poverty_75_moe <- pull_poverty_age(c("Takoma", "75+"), "pct_moe")

pull_tp_poverty_6 <- pull_poverty_age(c("Takoma", "< 6"), "pct_agepov")

pull_mont_poverty_6 <- pull_poverty_age(c("Mont", "< 6"), "pct_agepov")

pull_md_poverty_6 <- pull_poverty_age(c("^Maryland", "< 6"), "pct_agepov")


pull_tp_poverty_6074 <- pull_poverty_age(c("Takoma", "60-74"), "pct_agepov")

pull_mont_poverty_6074 <- pull_poverty_age(c("Mont", "60-74"), "pct_agepov")

pull_tp_poverty_1859 <- pull_poverty_age(c("Takoma", "18-59"), "pct_agepov")

pull_mont_poverty_1859 <- pull_poverty_age(c("Mont", "18-59"), "pct_agepov")

pull_tp_poverty_1217 <- pull_poverty_age(c("Takoma", "12-17"), "pct_agepov")

pull_mont_poverty_1217 <- pull_poverty_age(c("Mont", "12-17"), "pct_agepov")

pull_md_poverty_1217 <- pull_poverty_age(c("^Maryland", "12-17"), "pct_agepov")



# # generate poverty/age data
# poverty_age <- poverty_age_root %>%
#   est_moe_derive(c("name"), name_col = "pop_tot") %>%
#   est_moe_derive(c("name", "age_new"), name_col = "age_tot") %>%
#   est_moe_derive(c("name", "age_new", "poverty"), name_col = "age_pov") %>%
#   select(name, location, age, age_new, poverty, pop_tot_est, pop_tot_moe, age_tot_est, age_tot_moe, age_pov_est, age_pov_moe) %>%
#   distinct %>%
#     derive_pct_est_moe("pct_age",
#                      "pop_tot_est",
#                      "pop_tot_moe",
#                      "age_tot_est",
#                      "age_tot_moe") %>%
#   rename(pct_moe_age = pct_moe) %>%
#   derive_pct_est_moe("pct_age_pov",
#                      "age_tot_est",
#                      "age_tot_moe",
#                      "age_pov_est",
#                      "age_pov_moe")
# 
# poverty_age_overall <- poverty_race_age %>%
#   filter(!grepl("hispanic", race, ignore.case = T)) %>%
#   est_moe_derive(c("name"), name_col = "pop_tot") %>%
#   est_moe_derive(c("name", "poverty"), name_col = "pov") %>%
#   select(name, location, poverty, pop_tot_est, pop_tot_moe, pov_est, pov_moe) %>%
#   distinct %>%
#   derive_pct_est_moe("pct_pov",
#                       "pop_tot_est",
#                       "pop_tot_moe",
#                       "pov_est",
#                       "pov_moe") %>%
#   filter(grepl("below poverty", poverty))
# 
# poverty_age_overall_join <- poverty_age_overall %>%
#   select(name, pov_est, pov_moe, pct_pov, pct_moe) %>%
#   rename(pct_pov_overall = pct_pov,
#          pct_moe_overall = pct_moe)

# poverty_age_join <- poverty_age %>%
#   left_join(poverty_age_overall_join) %>%
#   mutate(signif_overall = signif_test(pct_age_pov, pct_pov_overall, pct_moe, pct_moe_overall)[[2]]) %>%
#   name_num_formatter()

```



```{r text unemployment}

text_raceunemploy <- glue("**By race, there are statistically-significant differences in unemployment rates between Black residents and white residents, and between white residents and the city's overall unemployment rate of {pull_tp_unemploy}%.** Black residents under age 65 experience the highest unemployment levels at {pull_tp_black_unemploy}% (representing {pull_tp_black_unemploy_tot} total residents) compared to {pull_tp_white_unemploy}% for white residents (representing {pull_tp_white_unemploy_tot} residents).

                          For other races, the low sample-sizes result in a high margin of error, meaning it is hard to tell whether differences in unemployment estimates actually exist or appear because of the particular group of residents the Census surveyed. However, in the larger sample of Montgomery County and Marlyand, there are significant differences in unemployment rates between Hispanic residents and white residents, residents with a race of 'other' and white residents, and multiracial residents and white residents. Because estimates of unemployment rates for these groups in Takoma Park are similar to or higher than in Montgomery County or Maryland, it is reasonable to think unemployment rates for these groups are actually-higher than white residents in Takoma Park even if the differences do not show up as statistically significant.")

```


```{r race unemployment plot, echo=FALSE}

sub_race_unemploy <- plot_ly(data = filter(race_unemploy, !race %in% tp_race_cats & race != "Overall") %>% race_factor(), 
                             type = "bar",
                             x = ~ race,
                             y = ~ pct_race,
                             # orientation = "h",
                             color = ~ location,
                             hovertext = ~ glue("Total: {estimate}
                         Margin of error: {pct_moe}%
                         Significant differences: {signif_check}"),
                         # text = ~ 
                         name = ~ location) %>%
  layout(showlegend = TRUE,
         xaxis = list(title = ""),
         yaxis = list(title = "Percent")) %>%
  subplot_title("Percent")
# range = c(0, max(unemploy[["pct_race"]]))))



sub_race_unemploy_tot <- plot_ly(data = filter(race_unemploy, !race %in% tp_race_cats & race != "Overall" & location == "Takoma Park") %>% race_factor(), 
                                 type = "bar",
                                 x = ~ race,
                                 y = ~ estimate,
                                 # orientation = "h",
                                 color = ~ race,
                                 colors = pal_race,
                                 opacity = 0.8,
                                 hovertext = ~ glue("Percent: {pct_race}%
                         Margin of error: {moe}"),
                         # text = ~ 
                         name = ~ race,
                         showlegend = F) %>%
  layout(title = "Unemployment by race (under 65)",
         xaxis = list(title = ""),
         yaxis = list(title = "Percent")) %>%
  subplot_title("Total")
# range = c(0, max(unemploy[["pct_race"]]))))

plot_race_unemploy <- subplot(sub_race_unemploy, sub_race_unemploy_tot, nrows = 2, shareX = T) %>%
  layout(title = "Unemployment by race (under 65)")

```

```{r text race unemployment summarized}

text_raceunemploy_summary <- glue("**Black residents under age 65 experience the highest unemployment levels by race at {pull_tp_black_unemploy}% (representing {pull_tp_black_unemploy_tot} total residents) compared to {pull_tp_white_unemploy}% for white residents under 65 (representing {pull_tp_white_unemploy_tot} residents).**")

```


```{r check poverty race age}

poverty_race_age_processor <- poverty_race_age %>%
  mutate(age = case_when(age == "75 to 84 years" ~ "75 years and over",
                         age == "85 years and over" ~ "75 years and over",
                         T ~ age)) %>%
  est_moe_derive(group_cols = c("location", "age", "race", "poverty"), name_col = "pov") %>%
  est_moe_derive(group_cols = c("location", "age", "race"), name_col = "age_race") %>%
  select(location, age, race, poverty, age_race_est, age_race_moe, pov_est, pov_moe) %>%
  derive_pct_est_moe("pct_age",
                     "age_race_est",
                     "age_race_moe",
                     "pov_est",
                     "pov_moe") %>%
  rename(estimate = pov_est,
         moe = pov_moe) %>%
  distinct

poverty_race_age_processor_nohisp <- poverty_race_age_processor %>%
  filter(!grepl("Hispanic", race, ignore.case = T)) %>%
  race_recode(race)

poverty_race_age_process <- poverty_race_age_processor %>%
  filter(!grepl("white alone$", race)) %>%
  signif_mont_tp(join_col = c("age", "race", "poverty"), name_pct = pct_age, moe_pct = pct_moe) %>%
  signif_overall(poverty_race_age_processor_nohisp, group_cols = c("location", "age", "poverty"), est_col = pct_age, pct_moe, "race") %>%
  signif_compare(race, "White", join_col = c("location", "age", "poverty"), pct_age, pct_moe) %>%
  signif_checker(list("Overall" = "signif_overall",
                      "MC" = "signif_mont",
                      "MD" = "signif_maryland",
                      "White" = "signif_white")) %>%
  race_recode(race) %>%
  filter(!race %in% tp_race_cats) %>%
  num_formatter() %>%
  age_recode(age)

poverty_race_age_process_povonly <- poverty_race_age_process %>%
  filter(grepl("below", poverty))

poverty_race_age_process_tp <- poverty_race_age_process %>%
  filter(grepl("Takoma", location))

poverty_race_age_process_tp_signif <- poverty_race_age_process_tp %>%
  filter(signif_check != "None")

pull_race_age_poverty <- pull_creator(poverty_race_age_process_povonly, filter_col = c("location", "age_new", "race"))

pull_white_611_poverty <- pull_race_age_poverty(c("Takoma", "6-11", "white"), "pct_age")

pull_white_1859_poverty <- pull_race_age_poverty(c("Takoma", "18-59", "white"), "pct_age")

pull_white_6074_poverty <- pull_race_age_poverty(c("Takoma", "60-74", "white"), "pct_age")

pull_white_75_poverty <- pull_race_age_poverty(c("Takoma", "75+", "white"), "pct_age")


pull_black_611_poverty <- pull_race_age_poverty(c("Takoma", "6-11", "Black"), "pct_age")

pull_black_1859_poverty <- pull_race_age_poverty(c("Takoma", "18-59", "Black"), "pct_age")

pull_black_6074_poverty <- pull_race_age_poverty(c("Takoma", "60-74", "Black"), "pct_age")

pull_overall_6074_poverty <- pull_race_age_poverty(c("Takoma", "60-74", "overall"), "pct_age")


pull_black_611_poverty_tot <- pull_race_age_poverty(c("Takoma", "6-11", "Black"), "estimate")

pull_black_1859_poverty_tot <- pull_race_age_poverty(c("Takoma", "18-59", "Black"), "estimate")

pull_black_6074_poverty_tot <- pull_race_age_poverty(c("Takoma", "60-74", "Black"), "estimate")



pull_hispanic_611_poverty <- pull_race_age_poverty(c("Takoma", "6-11", "hispanic"), "pct_age")

pull_hispanic_611_poverty_tot <- pull_race_age_poverty(c("Takoma", "6-11", "hispanic"), "estimate")


pull_asian_75_poverty <- pull_race_age_poverty(c("Takoma", "75+", "asian"), "pct_age")

pull_asian_75_poverty_tot <- pull_race_age_poverty(c("Takoma", "75+", "asian"), "estimate")

pull_asian_75_poverty_mont <- pull_race_age_poverty(c("Mont", "75+", "asian"), "pct_age")

pull_asian_75_poverty_md <- pull_race_age_poverty(c("Maryland", "75+", "asian"), "pct_age")

pull_overall_75_poverty <- pull_race_age_poverty(c("Takoma", "75+", "overall"), "pct_age")


pull_other_6_poverty <- pull_race_age_poverty(c("Takoma", "< 6", "other"), "pct_age")

pull_other_6_poverty_moe <- pull_race_age_poverty(c("Takoma", "< 6", "other"), "pct_moe")

```


```{r text age race poverty }

text_poverty_race_age <- glue("The large margin of error with smaller-samples makes it difficult to compare estimates by age and race. For instance, the poverty rate estimate for residents with a race of 'other' less than 6 is {pull_other_6_poverty}% but the margin of error is {pull_other_6_poverty_moe}%, meaning that the actual value could be between 0% and {pull_other_6_poverty +pull_other_6_poverty_moe}%. **Still, some statistically-significant racial disparities emerge for specific age groups:**
                              
- Through age 74, white residents have a statistically significant, lower rate of poverty than the city's overall rate at the same age. 
                              
- Estimates of poverty for Black residents exceed white residents throughought the age spectrum, with statistically significant differences emerging at age 6 to 11 ({pull_black_611_poverty}% and {pull_black_611_poverty} total Black residents in this age group compared to {pull_white_611_poverty}% for white residents), 18-59 ({pull_black_1859_poverty}% and {pull_black_1859_poverty_tot} total compared to {pull_white_1859_poverty}%), and 60-74 ({pull_black_6074_poverty}% and {pull_black_6074_poverty_tot} total compared to {pull_white_6074_poverty}%). Black residents aged 60-74 also have a statistically-significant higher poverty rate than the city's overall poverty rate at that age ({pull_overall_6074_poverty}%). 
                              
- Poverty rates for Hispanic residents aged 6-11 also exceed poverty rates for white residents in that age range, at {pull_hispanic_611_poverty}% (representing {pull_hispanic_611_poverty_tot} residents). 
                              
- Poverty rates for Asian residents over 75 jump to {pull_asian_75_poverty}% (representing {pull_asian_75_poverty_tot} residents), a higher rate than the overall rate for that age range ({pull_overall_75_poverty}%), white residents' ({pull_white_75_poverty}), Asian residents in Montgomery County ({pull_asian_75_poverty_mont}%) and Maryland ({pull_asian_75_poverty_md}%).")
```



```{r plot poverty race age}

sub_pov_race_age_tp_pct <- plot_ly(poverty_race_age_process_povonly %>%
                                     filter(grepl("Takoma", location)) %>%
                                     race_factor(),
                                   x = ~ age_new,
                                   y = ~ pct_age,
                                   color = ~ race,
                                   colors = pal_race,
                                   opacity = 0.8,
                                   legendgroup = ~ race,
                                   showlegend = T,
                                   hovertext = ~ glue("Total: {estimate}
                           Margin of error: {pct_moe}
                           Significant differences: {signif_check}"),
                           name = ~ race,
                           type = "scatter",
                           mode = "lines+markers") %>%
  subplot_title("Percent")

sub_pov_race_age_tp_tot <- plot_ly(poverty_race_age_process_povonly %>%
                                     filter(grepl("Takoma", location)) %>%
                                     race_factor(),
                                   x = ~ age_new,
                                   showlegend = F,
                                   y = ~ estimate,
                                   legendgroup = ~ race,
                                   color = ~ race,
                                   colors = pal_race,
                                   opacity = 0.8,
                                   hovertext = ~ glue("Total: {estimate}
                           Margin of error: {moe}
                           Percent: {pct_age}"),
                           name = ~ race,
                           type = "bar") %>%
  subplot_title("Total")

plot_race_age_poverty <- subplot(sub_pov_race_age_tp_pct,sub_pov_race_age_tp_tot, nrows = 2, shareX = T) %>%
  layout(title = "Poverty by race and age", xaxis = list(title = "Age-range"))

text_race_summary <- glue("**Takoma Park is a diverse city with a population of {pull_pop_tp %>% commafy}.** By race, {pull_white_tp_pct}% of residents are white (non-Hispanic), {pull_black_tp_pct}% Black, {pull_hisp_tp_pct}% Hispanic (of any race), and {pull_asian_tp_pct}% Asian.")

text_ancestry_summary <- glue("**The largest reported non-European country of ancestry for residents is Ethiopia**, representing {pull_ethiopian_pct}% of the {pull_ssa %>% commafy} residents the Census reports as having sub-Saharan African ancestry. **The three largest country of ancestry of people with a reported race of Asian are Indian, Chinese, and Vietnamese** (representing {pull_indian}, {pull_chinese}, and {pull_vietnamese} residents respectively).")

```

## Overall

### Summary

**Takoma Park is a diverse city with a population of `r pull_pop_tp %>% commafy`.** Of Takoma Park's `r pull_tot_households %>% commafy` households, `r pull_hous_family %>% commafy` are family households--meaning they are rented or owned by a householder who lives with at least one family member--and `r pull_hous_nonfamily %>% commafy` are nonfamily. The City's three largest racial/ethnic groups are non-Hispanic white (`r pull_white_tp_pct`%), Black (`r pull_black_tp_pct`%), and Hispanic (`r pull_hisp_tp_pct`%). Almost a third of residents were born in another country; of those born in another country, `r pull_tp_africa`% were born in Africa and `r pull_tp_latin`% in Latin America. A little more than a third of residents speak another language at home, the most common being Spanish at `r pull_tp_spanish`% of all residents.

**A little more than half of the city's residents are homeowners, but there are substantial economic and racial disparities tied to homeownership.** `r pull_tp_own_white`% of white residents own a home, compared to just `r pull_tp_own_black`% of Black residents. Renters earn much less than homeowners and are more-likely than owners to experience housing cost-burden (meaning they spend at least 30% of their income on housing). Renters' median income is \$`r pull_tp_rent_income %>% commafy` compared to \$`r pull_tp_own_income %>% commafy` for owners, and `r pull_tp_rent_30more`% of renters experience housing cost burden compared to `r pull_tp_own_30more`% of owners.

**Economic opportunity in Takoma Park is also stratified by race.** `r pull_tp_incomeless35`% of Takoma Park households earn less than \$35,000 annually, and `r {100 - pull_tp_income7599}`% earn more than \$100,000. White households in Takoma Park have a median income of \$`r pull_tp_white_income %>% commafy`, compared to a Black median income of \$`r pull_tp_black_income %>% commafy`, a Hispanic median income of \$`r pull_tp_hispanic_income %>% commafy`, and a median income of households with a race of other of $`r pull_tp_other_income %>% commafy`. Income gaps between white and Black residents in Takoma Park almost double those in Montgomery County, and almost quadruple Maryland; income gaps between white and Hispanic residents follow a similar pattern. Poverty rates for Black, Hispanic, and Asian residents range from `r pull_tp_poverty_black`% to `r pull_tp_poverty_hispanic`%, and are between 3 and 4 times as high as white residents' rate of `r pull_tp_poverty_white`%. Black residents under age 65 experience the highest unemployment levels at `r pull_tp_black_unemploy`%, compared to `r pull_tp_white_unemploy`% of white residents.

**Access to education, broadband internet, and health insurance varies by race and age:** 

- *Education*: A higher share of the city's residents have a graduate degree than Montgomery County or Maryland (`r pull_tp_graduate`%) and a higher share have a graduate or bachelor's degree than Maryland (`r pull_tp_bachelor + pull_tp_graduate`%), but a higher share did not complete high school (`r pull_tp_lesshs`%) than Montgomery County or Maryland. There are substantial racial disparities in educational attainment; `r pull_tp_hisp_lesshs`% of the city's Hispanic residents do not have a high school diploma compared to `r pull_tp_white_lesshs`% of the city's white residents, and `r pull_tp_black_lesshs + pull_tp_black_hs`% of the city's Black population have a high school degree or did not complete high school compared to `r pull_tp_white_hs + pull_tp_white_lesshs`% of the city's white residents. 

- *Internet*: `r pull_tp_broadband`% of residents have access to broadband internet, but rates are lower for residents with a race of 'other' (`r pull_tp_other_broad`%), Hispanic residents (`r pull_tp_hispanic_broad`%), and Black residents (`r pull_tp_black_broad`%). Residents 65 and older have lower rates of internet access than other age groups, with `r pull_broadband_65`% having access to broadband internet.

- *Health insurance*: Across age-groups, more Takoma Park residents either don't have insurance or have income-based insurance than Montgomery County or Maryland. Residents below 35 are especially likely to not have health insurance or use income-based insurance; `r pull_none_1934_pct`% of 19-34 year old residents do not have health insurance and `r pull_means_under18_pct`% of under 19 residents use income-based insurance, compared to city rates of `r pull_tp_noinsur`% and `r pull_tp_medicaid`% respectively. Racial disparities exist in health insurance access; only `r pull_white_nohealth`% of white residents do not have insurance, compared to `r pull_other_nohealth`% of residents with a race of 'other', `r pull_hisp_nohealth`% of Hispanic residents, and `r pull_black_nohealth`% of Black residents.

## Demographics {- .tabset .tabset-pills}

### Summary

`r text_race_summary`

**By age range, the largest share of the population are people between 40 and 49** (representing `r pull_tp_4049`% of the population), 30 and 39 (`r pull_tp_3039`%), and 0 and 9 (`r pull_tp_09`%). 

**`r pull_tp_foreign`% of residents were born outside the US (a higher share than Maryland overall).** `r pull_tp_africa`% of foreign-born residents were born in Africa--more than double Maryland and Montgomery County's shares--followed by `r pull_tp_latin`% from Latin America. A majority of the population other than white (non-Hispanic) and multiracial-residents are foreign-born. 

**Of Takoma Park's `r pull_tot_households %>% commafy` households, `r pull_hous_family %>% commafy` are family households--meaning they are rented or owned by a householder who lives with at least one family member--and `r pull_hous_nonfamily %>% commafy` are nonfamily.** Compared to Montgomery County, Takoma Park has a larger share of single-female family households, and a smaller share of married-couple households.

**`r pull_tp_english`% of residents' primary language spoken at home is English, `r pull_tp_spanish`% Spanish, and `r pull_tp_other`% other languages.**

`r text_ancestry_summary`

**`r pull_disability_tp_pct`% of residents have a disability, a lower share than Montgomery County and Maryland.** Rates of disability increase with age, from `r pull_disab_tp_less5`% of residents younger than 5 to `r pull_disab_tp_75`% of residents 75 and older.

<!-- ### Summary {-} -->

### Race

#### Table of contents

1) [Overall race]

2) [Age race]

3) [Sex race]

#### Overall race

`r text_raceoverall`


```{r print plot race ethnicity}

fig_race_ethn

```


```{r text tenure cost burden income}

text_tenure_costburdenincome <- glue("Breaking down cost burden by income reveals that while low-income homeowners are most likely to experience severe cost-burdens (spending more than 50% of their income on rent), **renters overall are much more likely to experience cost burden because renters generally earn much less than homeowners.**

Up to income levels of $35,000, {pull_rent_less35k_burden_pctburden}% of renters at least experience cost-burden (spending more than 30% of their income on rent), representing {pull_rent_less35k_burden_pctall}% of all renters. Additionally, {pull_rent_less35k_burden_pctsevereburden}% of renters with income-levels below $35,000 experience severe cost-burdens. {pull_rent_less20k_severeburden[1]}% of renters with incomes below $10,000 are severely burdened, and {pull_rent_less20k_severeburden[2]}% of renters with incomes between $10,000 and $20,000 are severely burdened. 

A similar {pull_own_less35k_burden_pctburden}% of homeowners with incomes below $35,000 experience housing cost burden, and a higher {pull_own_less35k_burden_pctsevereburden}% experience severe cost burden. However, cost-burdened homeowners with incomes below $35,000 represent {pull_own_less35k_burden_num} households--{pull_own_less35k_burden_pctall}% of all homeowners--compared to the {pull_rent_less35k_burden_num} cost-burdened renter-households.")

```


```{r cost burden - pct income renters, echo=FALSE}


# function to build charts for cost data
costs_plotly <- function(df, 
                         x_val = "household_income",
                         y_val = "pct_all",
                         # moe_col = "pct_moe",
                         color_var = "housing_costs",
                         y_ax = "Percent households",
                         xax_title = "Household income range",
                         showlegend = F,
                         chart_type = "bar"){
  
  
  # browser()
  x_quo <- sym(x_val) 
  y_quo <- sym(y_val)
  # moe_quo <- sym(moe_col)
  color_quo <- sym(color_var)
  
  sub_title <- case_when(grepl("Percent", y_ax) ~ "percent",
                         grepl("Total", y_ax) ~ "total")
  
  x_quo <- quo_set_env(enquo(x_quo), env = global_env())
  
  tenure_type <- df[["tenure"]][1]
  
  y_quo <- quo_set_env(enquo(y_quo), env = global_env())
  
  # moe_quo <- quo_set_env(enquo(moe_quo), env = global_env())
  
  color_quo <- quo_set_env(enquo(color_quo), env = global_env())
  # error_quo <- list(array = sym(moe_col),
  #                                 color = '#ADADAD',
  #                                 opacity = 0.5)
  
  # df <- df %>% group_by(housing_costs)
  
  plot <- plot_ly(data = df, 
                  x = x_quo, 
                  y = y_quo,
                  type = chart_type,
                  mode = "lines+markers",
                  color = color_quo,
                  legendgroup = color_quo,
                  colors = "RdYlBu",
                  text = ~ paste0("Percent all ", tolower(tenure_type), "s: ", pct_tenure),
                  # hoverinfo = "text",
                  showlegend = showlegend,
                  name = color_quo
                  # error_x = list(array = moe_quo,
                  #                 color = '#ADADAD',
                  #                 opacity = 0.5)
  ) %>%
    layout(yaxis = list(title = y_ax),
           xaxis = list(title = xax_title),
           barmode = 'stack') %>%
    add_annotations(text = paste0("<i><b>", tenure_type, ": ", sub_title, "<b><i>"),
                    x = 0.1, y = 1.05, yref = "paper", xref = "paper", xanchor = "left", yanchor = "top", showarrow = F, font = list(size = 12))
  
  return(plot)
}

sub_tot_renter <- costs_plotly(renter_costs_processed, 
                               x_val = "household_income",
                               y_val = "estimate",
                               color = "housing_costs", 
                               y_ax = "Total households",
                               showlegend = T)

sub_tot_owner <- costs_plotly(owner_costs_processed, 
                              x_val = "household_income",
                              y_val = "estimate",
                              y_ax = "Total households",
                              color = "housing_costs", showlegend = F)

sub_pct_renter <- costs_plotly(renter_costs_processed, 
                               x_val = "household_income",
                               y_val = "pct_all",
                               y_ax = "Percent households",
                               color = "housing_costs", showlegend = F)

sub_pct_owner <- costs_plotly(owner_costs_processed, 
                              x_val = "household_income",
                              y_val = "pct_all",
                              y_ax = "Percent households",
                              
                              color = "housing_costs", showlegend = F)


sublots_tenure_costburden_income <- subplot(sub_tot_renter, sub_tot_owner, sub_pct_renter,sub_pct_owner, shareY = T, shareX = T, nrows = 2) %>%
  layout(title = "Housing cost burden by household income")

```



#### Age race

```{r race age processing}

race_age_gender <- data_binder("race_age_gender") %>%
  name_num_formatter()

race_age_gender_exclude <- race_age_gender %>%
  filter(!grepl("white alone$", race)) %>%
  race_recode(race) %>%
  age_recode(age, 
             regroup = "race_age") 

race_age <- race_age_gender_exclude %>%
  est_moe_derive(c("name", "race", "age_group"), name_col = "age_tot") %>%
  select(name, location, race, race_tot, race_tot_moe, age_group, age_tot_est, age_tot_moe) %>%
  distinct %>%
  derive_pct_est_moe("pct_age",
                     aggregate_est = "race_tot",
                     "race_tot_moe",
                     "age_tot_est",
                     "age_tot_moe") %>%
  group_by(name, race) %>%
  arrange(age_group) %>%
  mutate(cumul_pct = cumsum(pct_age),
         cumul_tot = cumsum(age_tot_est)) %>%
  mutate(across(where(is.numeric),
                .fns = ~ round(.x, 1)))

race_age_tp <- race_age %>%
  filter(grepl("Takoma", name))

race_age_overall <- race_age_gender %>%
  filter(!grepl("hispanic", race, ignore.case = T)) %>%
  race_recode(race) %>%
  age_recode(age, regroup = "race_age") %>%
  mutate(race = "Overall") %>%
  est_moe_derive(c("name", "race"), name_col = "race_tot") %>%
  est_moe_derive(c("name", "race", "age_group"), name_col = "age_tot") %>%
  select(name, location, race, race_tot_est, race_tot_moe, age_group, age_tot_est, age_tot_moe) %>%
  distinct %>%
  derive_pct_est_moe("pct_age",
                     aggregate_est = "race_tot_est",
                     "race_tot_moe",
                     "age_tot_est",
                     "age_tot_moe") %>%
  group_by(name, race) %>%
  arrange(age_group) %>%
  mutate(cumul_pct = cumsum(pct_age),
         cumul_tot = cumsum(age_tot_est)) %>%
  mutate(across(where(is.numeric),
                .fns = ~ round(.x, 1)))

race_age_overall_tp <- race_age_overall %>%
  filter(grepl("Takoma", name))

pull_raceageoverall <- pull_creator(race_age_overall_tp, c("age_group"))

pull_overall_3544_pct <- pull_raceageoverall("35-44", "pct_age")

age_vector <- race_age_tp$age_group %>%
  unique

race_vector <- race_age_tp$race %>%
  unique() %>%
  tolower

pull_race_age_tp <- pull_creator(race_age_tp, c("race", "age_group"))

walk(as.character(age_vector), function(age) {
  
  age <- as.character(age)
  
  walk(as.character(race_vector), function(race) {
    # print(race)
    # print(age)
    
    pull_pct <- pull_race_age_tp(c(race, 
                                   age), 
                                 "pct_age")
    
    pull_tot <- pull_race_age_tp(c(race, 
                                   age), 
                                 "age_tot_est")
    
    age <- gsub("(-)|(\\+)", "", age) 
    
    name <- glue("pull_{race}_{age}_")
    
    assign(x = paste0(name, "pct"), value = round(pull_pct, 1), pos = global_env())
    
    assign(x = paste0(name, "tot"), value = pull_tot, pos = global_env())
  })
  
})

race_age_tp_plot <- race_age_tp %>%
  filter(!race %in% tp_race_cats) %>%
  rbind(race_age_overall_tp)  %>%
  left_join(race_age_overall_tp %>%
              ungroup %>%
              select(age_group, pct_age, pct_moe) %>%
              rename(overall_age = pct_age,
                     overall_moe = pct_moe)) %>%
  mutate(z_score = signif_test(pct_age, overall_age, pct_moe, overall_moe)[[1]],
         crit_value = signif_test(pct_age, overall_age, pct_moe, overall_moe)[[2]])


text_raceage <- glue("**Different races have different age-distributions compared to the city overall:**

                     - White residents tend to be older compared to the rest of the city. There are a lower share of white residents aged 25-34 ({pull_white_2534_pct}%), and a higher share of residents aged 45-54 ({pull_white_4554_pct}%), 55-64 ({pull_white_5564_pct}%), and 65-74 ({pull_white_6574_pct}%).
                     - For Black residents, there are a lower share of residents aged 10-17 ({pull_black_1017_pct}%), 50-59 ({pull_black_5564_pct}%), and 65-74 ({pull_black_6574_pct}%), and a higher share of residents aged 25-34 ({pull_black_2534_pct}%). The highest share of Black residents are aged 35-44 at {pull_black_3544_pct}%, but there is not a statistically-significant difference from the city's overall percent of aged 35-44 year old residents ({pull_overall_3544_pct}%). 
                     - For Hispanic residents, there are a higher share of residents aged 18-24 ({pull_hispanic_1824_pct}%), and a lower share of residents aged 55-64 ({pull_hispanic_5564_pct}%). 
                     - Asian residents and residents with a race of 'other' mostly follow the City's demographics, but there are a lower share of 0-9 Asian residents at {pull_asian_09_pct}%. For, residents with a race of 'other,' there are a lower share of residents between 55 and 64 year-old ({pull_other_5564_pct}%) and 25 and 34 ({pull_other_2534_pct}%), and a higher share between 18 and 24 ({pull_other_1824_pct}%).
                     - Multiracial residents are mostly under 18--representing {pull_multiracial_09_pct + pull_multiracial_1017_pct}% of multiracial residents--with a lower share of residents 45-74 ({pull_multiracial_4554_pct + pull_multiracial_5564_pct + pull_multiracial_6574_pct}%) than the city's overall demographics.")

```

`r text_raceage`

```{r plot race age }
# plot_race_age_stack <- plot_ly(race_age_tp_plot ,
#         x = ~ race,
#         y = ~ round(pct_age, 1),
#         text = ~ glue("{age_group}:
#                       {round(pct_age, 1)}%"),
#         textposition = "inside",
#         hovertext = ~ glue("Age-group total: {age_tot_est}
#                            Margin of error: {pct_moe}%
#                            Cumulative percent: {cumul_pct}%"),
#         textfont = list(color = "black"),
#         colors = "Spectral",
#         color = ~ age_group,
#         name = ~ age_group) %>%
#   layout(barmode = "stack",
#          yaxis = list(title = "Percent race"),
#          xaxis = list(title = ""),
#          title = "Age by race")

plot_race_age_barcomp <- plot_ly(race_age_tp_plot %>%
                                   race_factor(),
                                 x = ~ age_group,
                                 y = ~ round(pct_age, 1),
                                 # text = ~ glue("{age_group}:
                                 #               {round(pct_age, 1)}%"),
                                 # textposition = "inside",
                                 hovertext = ~ glue("Age-group total: {age_tot_est}
                           Margin of error: {pct_moe}%
                           Statistical-significance of difference: {crit_value}
                           Cumulative percent: {cumul_pct}%"),
                           # textfont = list(color = "black"),
                           # colors = "Spectral",
                           # type = "scatter",
                           # mode = "line+marker",
                           color = ~ race,
                           colors = pal_race,
                           opacity = 0.8,
                           name = ~ race) %>%
  layout(yaxis = list(title = "Percent race"),
         xaxis = list(title = ""),
         title = "Age by race")



plot_race_age_scatter <- plot_ly(race_age_tp_plot %>%
                                   race_factor(),
                                 x = ~ age_group,
                                 y = ~ round(cumul_pct, 1),
                                 # text = ~ glue("{round(pct_age, 1)}%"),
                                 # textposition = "inside",
                                 # textfont = list(color = "black"),
                                 # colors = "Spectral",
                                 type = "scatter",
                                 text = ~ glue("Cumulative total: {cumul_tot %>% commafy}
                    Age-group percent: {round(pct_age, 1)}
                    Age-group total: {age_tot_est}"),
                    color = ~ race,
                    colors = pal_race,
                    opacity = 0.8,
                    name = ~ race,
                    mode = "line+marker") %>%
  layout(barmode = "stack",
         yaxis = list(title = "Percent race"),
         xaxis = list(title = "Age-range"))

plot_race_age_barcomp

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*


#### Sex race


```{r Race sex}

race_gender <- race_age_gender %>%
  filter(!grepl("white alone$", race)) %>%
  race_recode(race) %>%
  select(name, location, race, race_tot, race_tot_moe, gender, gender_tot, gender_tot_moe) %>%
  distinct() %>%
  derive_pct_est_moe("pct_sex",
                     "race_tot",
                     "race_tot_moe",
                     "gender_tot",
                     "gender_tot_moe") %>%
  filter(!race %in% tp_race_cats)

race_gender_overall <- race_age_gender %>%
  filter(!grepl("hispanic", race, ignore.case = T)) %>%
  select(name, location, gender, gender_tot, gender_tot_moe) %>%
  distinct() %>%
  est_moe_derive(c("name"), est_col = "gender_tot", moe_col = "gender_tot_moe", name_col = "pop_tot") %>%
  est_moe_derive(c("name", "gender"), est_col = "gender_tot", moe_col = "gender_tot_moe", name_col = "gender_tot") %>%
  select(name, location, pop_tot_est, pop_tot_moe, gender, gender_tot_est, gender_tot_moe) %>%
  distinct %>%
  mutate(race = "Overall") %>%
  distinct %>%
  derive_pct_est_moe(proportion_col = "pct_sex_pop",
                     "pop_tot_est",
                     "pop_tot_moe",
                     "gender_tot_est",
                     "gender_tot_moe")

race_gender_overall_bind <- race_gender_overall %>%
  rename(gender_tot = gender_tot_est,
         pct_sex = pct_sex_pop,
         race_tot = pop_tot_est) %>%
  select(name, location, race, race_tot, gender, gender_tot, gender_tot_moe, pct_sex, pct_moe)

race_gender_overall_merge <- race_gender_overall %>%
  rename(pct_sex_pop_moe = pct_moe) %>%
  select(name, gender, pct_sex_pop, pct_sex_pop_moe)

race_gender_bound <- race_gender %>%
  dplyr::bind_rows(race_gender_overall_bind) %>%
  left_join(race_gender_overall_merge) %>%
  mutate(crit_var = signif_test(pct_sex, pct_sex_pop, pct_moe, pct_sex_pop_moe)[[1]],
         significance = signif_test(pct_sex, pct_sex_pop, pct_moe, pct_sex_pop_moe)[[2]])

race_gender_bound_tp <- race_gender_bound %>%
  filter(grepl("Takoma", location))


pull_race_sex <- pull_creator(race_gender_bound_tp, filter_col = c("race", "gender"))

pull_multiracial_female <- pull_race_sex(c("Multiracial", "Female"), "pct_sex") %>%
  round(1)

pull_multiracial_male <- pull_race_sex(c("Other", "^Male"), "pct_sex") %>%
  round(1)


text_racegender <- glue("**There are not significant differences by race and sex from the overall population with two exceptions.** There are more female multiracial residents than male, at {pull_multiracial_female}% of multi-racial residents, and more male residents with a racial category of 'other' than female at {pull_multiracial_male}% of residents with a racial cateogrization of 'other.'")

```

`r text_racegender`

```{r plot race sex}
plot_race_sex <- plot_ly(race_gender_bound_tp %>%
                           filter(!grepl("Overall", race)) %>%
                           race_factor(),
                         x = ~ race, 
                         y = ~ gender_tot %>% round(1),
                         color = ~ gender,
                         name = ~ gender,
                         text = ~ glue("Percent: 
                                       {pct_sex %>% round(1)}%"),
                         textfont = list(color = "black"),
                         textposition = "inside",
                         hovertext = ~ glue("
                         Percent: {pct_sex %>% round(1)}%
                         Percent margin of error: {pct_moe %>% round(1)}%
                         Statistical significance of
                         difference from overall: {significance}")) %>%
  layout(title = "Race by sex",
         barmode = "stack",
         xaxis = list(title = "Sex"),
         yaxis = list(title = "Residents"))

plot_race_sex

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*


### Age, sex, and families

#### Table of contents

1) [Sex]

2) [Age]

3) [Household-type]

4) [Household living arrangements]

4) [Age by sex]

#### Sex

`r pull_woman_pct`% of Takoma Park's population are female, and `r 100 - pull_woman_pct`% are male.

```{r plot sex}

plot_ly(sex %>%
          filter(grepl("Takoma", location)),
        values = ~ tot_gender,
        labels = ~ sex,
        # text =  ~ paste0(sex, "\n", tot_gender %>% commafy),
        textposition = 'inside',
        textinfo = 'label+percent',
        hole = 0.4,
        type = "pie") %>%
  layout(title = "Takoma Park population by sex"
  )

```


#### Age

Compared to Montgomery County and Maryland, Takoma Park has a slightly higher share of people aged 40-49 at `r pull_tp_4049`% compared to `r pull_mont_4049`% in Montgomery County and `r pull_md_4049`% in Maryland, and a slightly higher share of people aged 0-9 at `r pull_tp_09`% compared to `r pull_mont_09`% and `r pull_md_09`% in Montgomery County and Maryland. The city has a slightly lower share of people over 70--representing `r pull_tp_70more`% of residents compared to `r pull_mont_70more`% in Montgomery County and `r pull_md_70more`% in Maryland--and a slightly lower share of people aged 20-29 than Maryland, representing `r pull_tp_2029`% of residents compared to `r pull_md_2029`% in Maryland.

```{r plot age}

plot_ly(age_grped,
        x = ~ location,
        y = ~ pct_age,
        name = ~ age_group,
        color = ~ age_group,
        textposition = 'inside',
        hovertext = ~ paste0("Total: ", age_grp_est %>% commafy,
                             "\nPercent margin of error: ", pct_moe, "%"),
        # textinfo = 'label+percent',
        colors = "Spectral",
        opacity = 0.8,
        text = ~ paste0(age_group, ": ", pct_age, "%"),
        textfont = list(color = "black"),
        type = "bar") %>%
  layout(title = "Age by location",
         yaxis = list(title = "Percent"),
         xaxis = list(title = ""),
         barmode = "stack")

```

#### Household-type

[The Census defines](https://www.census.gov/programs-surveys/cps/technical-documentation/subject-definitions.html#familyhousehold) a household as all people in a housing unit. A housing unit is a separate living quarters, meaning occupants have a dedicated space or structure for them. A single-family house is a housing unit, one apartment in an apartment building is a housing unit, and one room in a grouphouse is a housing unit. A householder is the person renting or owning a housing unit (in the case of a couple, it could be either of the two).

**Of Takoma Park's `r pull_tot_households %>% commafy` households, `r pull_hous_family %>% commafy` are family households--meaning they are rented or owned by a householder who lives with at least one family member--and `r pull_hous_nonfamily %>% commafy` are nonfamily. The largest share of households are married-couple householders (representing `r pull_housfam_married %>% commafy` households), followed by `r pull_housfam_alone %>% commafy` householders living alone and `r pull_housfam_singfem %>% commafy` single-female family households.


```{r plot plots famtype}

plots_hous_famtype <- subplot(plot_hous_famtype_tp %>% subplot_title("Takoma Park total", .y = 1.05),
                              plot_hous_famtype_loc %>% subplot_title("Percent all households", .y = 1.05),
                              nrows = 2)

plots_hous_famtype

```

Compared to Montgomery County, Takoma Park has a larger share of single-female family households at `r pull_housfam_singfem_pct`% compared to `r pull_housfam_singfem_pct_mont`%, and a smaller share of married-couple households at `r pull_housfam_married_pct`% compared to `r pull_housfam_married_pct_mont`%.

#### Household living arrangements

`r pull_tp_married_child_pct`% of married couples in Takoma Park have children, as well as `r pull_tp_cohab_child_pct`% of cohabitating couples. Similar to Maryland and Montgomery County, a higher-share of single-female households have children than single-male households (`r pull_tp_female_child_pct`% compared to `r pull_tp_male_child_pct`%), while a greater share of single-male households live with roommates (`r pull_tp_male_roommate_pct`% compared to `r pull_tp_female_roommate_pct`%).

```{r plot family type loc}

tp_family_byocc_tot <- plot_ly(family_hous_ppl_processed %>%
                                filter(grepl("Takoma", location)),
                              x = ~ hous_type,
                              y = ~ hous_ppl_est,
                              text =~ glue("{hous_ppl_est %>% commafy}"),
                              textposition = "inside",
                              textfont= list(color = "black"),
                              showlegend = F,
                              color = ~ hous_people,
                              name = ~ hous_people,
                              type = "bar",
                              legendgroup = ~ hous_people) %>%
  layout(barmode = "stack")

plots_family_byocc_loc <- map(c("Cohabiting couple", "Married", "Male", "Female"), ~ {
  showleg <- ifelse(grepl("^Male", .x), T, F)
  plot_loc_family_hous_ppl(.x, showleg = showleg, 1.15)
})

# plots_family_byocc_loc[[5]] <- tp_family_byocc_tot

subplot(tp_family_byocc_tot %>% subplot_title("Takoma Park family total"), subplot(plots_family_byocc_loc, nrows = 4, shareY = T, shareX = T) %>% layout(yaxis = list(title = "Percent")), nrows = 1, shareX = F, shareY = F) %>%
  layout(title = "Households by relationship and co-occupants",
         yaxis = list(title = "Households"), 
         xaxis = list(title = ""))


```

A higher share of married Takoma Park households have children (`r pull_tp_married_child_pct`%) than Montgomery County (`r pull_mc_married_child_pct`%) or Maryland (`r pull_md_married_child_pct`%). A smaller share of single-man households live alone in Takoma Park, at `r pull_tp_male_alone_pct`% compared to `r pull_mc_male_alone_pct`% in Montgomery County and `r pull_md_male_alone_pct`% in Maryland.

#### Age by sex

The largest share of female residents in the City are aged 30-39 (representing `r pull_female_3039_pct`% of the female-residents and `r pull_female_3039_pctpop`% of the City's population), followed by people aged 40-49 at `r pull_female_4049_pct`% of female-residents and `r pull_female_4049_pctpop`% of the population. The largest share of male residents are aged 40-49--at `r pull_male_4049_pct`% of males and `r pull_male_4049_pctpop`% of the population--and 0-9, representing `r pull_male_09_pct`% of males and `r pull_male_09_pctpop`% of the population.

The biggest between-sexes differences by age are in people aged 30-39 and 0-9. There are `r pull_diff_09_tot` more male-residents between 0 and 9 than female (representing `r pull_male_09_pct`% of male residents compared to `r pull_female_09_pct`% of female residents), and `r pull_diff_3039_tot` more female-residents between 30 and 39 than male (representing `r pull_female_3039_pct`% of female residents compared to `r pull_male_3039_pct`% of male residents). 

```{r plot age sex}

plot_ly(age_sex_processed,
        x = ~ sex,
        y = ~ age_grp_est,
        name = ~ age_group,
        color = ~ age_group,
        textposition = 'inside',
        hovertext = ~ paste0("Percent sex: ",  pct_age, "%",
                             "\nPercent population: ", pct_age_pop, "%", 
                             "\nMargin of error: ", round(age_grp_moe, 0) %>% commafy),
        # textinfo = 'label+percent',
        colors = "Spectral",
        opacity = 0.8,
        text = ~ paste0(age_group, ": ", age_grp_est %>% commafy),
        textfont = list(color = "black"),
        type = "bar") %>%
  layout(title = "Takoma Park age by sex",
         yaxis = list(title = "Residents"),
         xaxis = list(title = ""),
         barmode = "stack")

```


### Foreign-born residency, birthplace, and English proficiency

#### Table of contents

1) [Birthplace]

2) [Foreign-born residents by birthplace]

3) [Race by birthplace]

4) [Ancestry]

5) [Languages spoken at home]

6) [Languages spoken at home by age]

#### Birthplace {-}

`r pull_tp_foreign`% of Takoma Park's residents were born in another country, about the same as Montgomery County but almost double Maryland's `r pull_md_foreign`%.

```{r plot foreign born}

plot_ly() %>%
  add_pie(data = filter(foreign, grepl("Takoma", location)), 
          values = ~estimate, 
          labels = ~birthplace,
          hole = 0.5,
          text = ~ birthplace,
          # color = ~ birthplace,
          domain = list(x = c(0, 0.45), y = c(0, 1)),
          name = "Takoma Park",
          title = list(text = "<b>Takoma Park</b>")) %>%
  add_pie(data = filter(foreign, grepl("Maryland", location)), 
          values = ~estimate, 
          labels = ~birthplace,
          hole = 0.5,
          # color = ~ birthplace,
          domain = list(x = c(0.55, 1), y = c(0, 1)),
          name = "Maryland",
          text = ~ birthplace,
          title = list(text = "<b>Maryland</b>",
                       size = "20")) %>%
  layout(showlegend = F,
         title = "Birthplace by place"
  )


```


#### Foreign-born residents by birthplace {-}

**Although Takoma Park and Montgomery County have similar shares of foreign-born residents, the birthplaces of residents differ.** `r pull_tp_africa`% of Takoma Park's foreign-born residents were born in Africa compared to only `r pull_mont_africa`% of Montgomery County's, while `r pull_mont_asia`% of Montgomery County's foreign-born residents were born in Asia compared to `r pull_tp_asia`% of Takoma Park's. Both places have similar shares of Latin-American born residents, representing around 36% of foreign-born residents.


```{r foreign birth plot}

plot_ly(foreign_birth,
        type = "bar",
        x = ~ continent,
        y = ~ continent_pct,
        color = ~ location,
        text = ~ paste0("Total: ", estimate %>% commafy),
        name = ~ location) %>%
  layout(title = "Foreign born residents by birthplace",
         yaxis = list(title = "Percent"),
         xaxis = list(title = "Continent of birth"))

```

#### Race by birthplace {-}

```{r text race birthplace}

text_race_birthplace <- glue("**In Takoma Park, a majority of residents of all racial/ethnic backgrounds other than white (non-Hispanic) and multiracial were born in another country.** {pull_black_foreignborn}% of the city's Black residents are foreign born, {pull_hispanic_foreignborn}% of the city's Hispanic residents, {pull_asian_foreignborn}% of the city's Asian residents, and {pull_other_foreignborn}% of residents with a race of 'other.' Most white and multi-racial residents of Takoma Park were born in another state, with out-of-state birthplaces representing {pull_white_otherstate}% of white residents and {pull_multi_otherstate}% of multi-racial residents.")

```

`r text_race_birthplace`

```{r plot foreign born race}

plot_race_birthplace <- plot_ly(race_foreign_born %>%
                                  race_factor(),
                                x = ~ race,
                                type = "bar",
                                y = ~ pct_race,
                                text = ~ glue("{pct_race}%"),
                                textfont = list(color = "black"),
                                textposition = "inside",
                                opacity = 0.8,
                                hovertext = ~ paste0("Total: ", estimate %>% commafy,
                                                     "\nMargin of error: ", pct_moe, "%"),
                                color = ~ birth_new,
                                name = ~ birth_new)  %>%
  layout(title = "Takoma Park race by birthplace",
         xaxis = list(title = "Race"),
         barmode = "stack",
         yaxis = list(title = "Percent-race"))


plot_race_birthplace

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*


#### Ancestry

```{r text ancestry}

text_ancestry <- glue("**The Census reports {pull_num_ancestrygrps} ancestry groups in Takoma Park with at least 50 people, and no ancestry group represents more than {pull_ssa_pct}% of the population.** The largest reported group in Takoma Park by the Census's ancestry-categories are sub-Saharan African at { pull_ssa %>% commafy} (representing {pull_ssa_pct}% of residents), followed by English at {pull_english %>% commafy} residents, German at {pull_german %>% commafy} residents, and West Indian at {pull_westindian %>% commafy} residents. Due to the small numbers involved and high margin of error, caution should be taken in reading too much into exact estimates.")

```

`r text_ancestry`

```{r plot ancestry overall}
plot_ancestry_overall

```

*Note: The above chart is limited to ancestry-groups with at least 50 residents in Takoma Park.*

```{r text ancestry disag}

text_ancestry_disag <- glue("While the Census groups countries of ancestry for Arab, sub-Saharan African, and West Indian residents, the Census does make available disaggregated data by country of ancestry for these residents. A majority of residents of sub-Saharan African ancestry are Ethiopian (representing {pull_ethiopian %>% commafy} residents and {pull_ethiopian_pct}% of residents of sub-Saharan African ancestry); the only other individual country of ancestry with more than 50 residents was Nigeria at {pull_nigeria %>% commafy} residents. Most residents of West Indian ancestry are either Haitian (representing {pull_haiti} residents and {pull_haiti_pct}% of West Indian residents) or Jamaican (representing {pull_jamaica} residents and {pull_jamaica_pct}% of West Indian residents). No country of ancestry for Arab residents has at least 50 resident; the most Arab residents are of Jordanian ancestry at {pull_jordan_tot} residents.")

```

`r text_ancestry_disag`

```{r plot ancestry subgroups}
plot_ancestry_sub

```

*Note: The above chart is limited to ancestry-groups with at least 50 residents in Takoma Park.*

```{r text asian disag}
text_asian_ancestry <- glue("Separately, the Census reports ethnicity results for residents with a race of Asian. The largest share of Asian residents are ethnically Indian at {pull_indian} residents and {pull_indian_pct}% of Asian residents, followed by Chinese (non-Taiwanese) residents at {pull_chinese} residents, and Vietnamese residents at {pull_vietnamese} residents.")
```


`r text_asian_ancestry`

```{r print plot asian disag}

plot_asian_disag

```


#### Languages spoken at home {-}

**`r pull_tp_other + pull_tp_spanish`% of Takoma Park residents speak a language other than English at home,** with `r pull_tp_spanish`% of residents speaking Spanish and the remaining `r pull_tp_other`% speaking another language. While lower than Montgomery County, both exceed Maryland's rates of `r pull_md_spanish`% Spanish and `r pull_md_other`% another language respectively.

```{r language at home plot, echo=FALSE}
# plot_ly(type = "bar",
#         data = language,
#         y = ~ pct_language,
#         x = ~ language,
#         color = ~ location,
#         name = ~ location)

plot_ly() %>%
  add_pie(data = language %>%
            filter(grepl("Montgomery", location)),
          type = "pie",
          labels = ~ language,
          hole = 0.5,
          values = ~ estimate,
          # text = ~ language,
          title = "<b>Montgomery \nCounty</b>",
          name = "Montgomery County",
          domain = list(x = c(0, 0.4), y = c(0.4, 1))) %>%
  add_pie(data = language %>%
            filter(grepl("Maryland", location)),
          type = "pie",
          labels = ~ language,
          hole = 0.5,
          values = ~ estimate,
          # text = ~ language,
          name = "Maryland",
          title = "<b>Maryland</b>",
          domain = list(x = c(0.6, 1), y = c(0.4, 1))) %>%
  add_pie(data = language %>%
            filter(grepl("Takoma", location)),
          type = "pie",
          labels = ~ language,
          hole = 0.5,
          values = ~ estimate,
          # text = ~ language,
          name = "Takoma Park",
          title = "<b>Takoma Park</b>",
          domain = list(x = c(0.25, 0.75), y = c(0, 0.6))) %>%
  layout(showlegend = T) %>%
  layout(title = "Language proficiency by place")


```

#### Languages spoken at home by age

```{r pull lang home age}

pull_agelangtp <- pull_creator(age_lang_tp %>%
                                 mutate(across(is.numeric, ~ round(.x, 1))), c("age", "homelang"))

pull_eng_1864 <- pull_agelangtp(c("18", "English"), "pct_age")

pull_eng_517 <- pull_agelangtp(c("17", "English"), "pct_age")
pull_eng_65 <- pull_agelangtp(c("65", "English"), "pct_age")

pull_other_1864 <- pull_agelangtp(c("18", "Other lang"), "pct_age")

pull_other_517 <- pull_agelangtp(c("17", "Other lang"), "pct_age")
pull_other_65 <- pull_agelangtp(c("65", "Other lang"), "pct_age")


```

**By age, people aged 18-64 are less likely to speak English at home (at rates of `r pull_eng_1864`%) than people under 18 or over 64 (`r pull_eng_517`% and `r pull_eng_65`% respectively).** People aged 18-64 are relatively more likely to speak another non-Indo European or Asian/Pacific Island language; `r pull_other_1864`% of people aged 18-64 spoke one of these languages at home, compared to `r pull_other_517`% of people under 18 and `r pull_other_65`% of people over 64.

```{r plot lang home age}

plot_age_lang_tp <- plot_ly(age_lang_tp %>%
                              mutate(across(is.numeric, ~ round(.x, 1))),
                            x = ~ age_new,
                            y = ~ pct_age,
                            color = ~ homelang,
                            text = ~ glue("{pct_age %>% commafy}%"),
                            hovertext = ~ glue("Total: {estimate %>% commafy}"),
                            textposition = "inside",
                            textfont = list(color = "black"),
                            name = ~ homelang) %>%
  layout(title = "Language spoken at home by age",
         xaxis = list(title = "Age"),
         barmode = "stack",
         yaxis = list(title = "Percent age group"))

plot_age_lang_tp

```

### Disability

#### Table of contents

1) [Disability]

2) [Disability by age]

3) [Disability by race]

4) [Disability by type]

5) [Disability by type and age]

#### Disability

The American Community Survey covers [six types of disability](https://www.census.gov/topics/health/disability/guidance/data-collection-acs.html): hearing, vision, cognitive, ambulatory, self-care, and independent living.

**`r pull_disability_tp_tot` persons in Takoma Park have a disability.** This represents `r pull_disability_tp_pct`% of Takoma Park's population, a lower share than Maryland's `r pull_disability_md_pct`% and Montgomery County's `r pull_disability_mont_pct`%.

```{r plot disability}
plot_ly(disability_processed, 
        x = ~ location,
        y = ~ pct_disability,
        name = ~ location,
        color = ~ location,
        text= ~ paste0("Total: ", disability_est %>% commafy,
                       "\nMargin of error: ", pct_moe, "%")) %>%
  layout(xaxis = list(title = ""),
         yaxis = list(title = "Percent population"),
         title = "Persons with a disability by location")

```

#### Disability by age

Consistent with expectations, **the percent of people in an age group in Takoma Park with a disability increases with age, from `r pull_disab_tp_less5`% of residents less than 5 to `r pull_disab_tp_75`% of people older than 75.** A higher percentage of Takoma Park residents older than 75 have a disability than Montgomery County (`r pull_disab_mont_75`%) or Maryland (`r pull_disab_md_75`%), and a lower share of residents aged 5-17 (`r pull_disab_tp_517`%) and 35-64 (`r pull_disab_tp_3564`%) have a disability than Maryland (`r pull_disab_md_517`% of 5-17 year-olds and `r pull_disab_md_3564`% of 35-64 year-olds).

```{r plot disability age}

sub_tp_disability_age_tot <- plot_ly(disability_age %>%
                                       filter(grepl("Takoma", location)),
                                     x = ~ age_new,
                                     y = ~ disability_est,
                                     name = ~ age_new,
                                     legendgroup = ~ age_new,
                                     colors = "Spectral",
                                     showlegend = F,
                                     text = ~ paste0("Percent age group: ", pct_disability, "%",
                                                     "\nMargin of error: ", disability_moe,
                                                     "\nPercent population: ", pct_disability_pop, "%"),
                                     color = ~ age_new,
                                     type = "bar") %>%
  layout(title = "",
         
         xaxis = list(title = ""),
         yaxis = list(title = "Percent age-group")) %>%
  subplot_title("Takoma Park total")

sub_tp_disability_age_pctpop <- plot_ly(disability_age,
                                        x = ~ location,
                                        y = ~ pct_disability_pop,
                                        name = ~ age_new,
                                        legendgroup = ~ age_new,
                                        showlegend = T,
                                        text = ~ paste0(pct_disability_pop %>% round(1), "%"),
                                        hovertext = ~ paste0("Percent age group: ", pct_disability, "%",
                                                             "\nTotal: ", disability_est %>% commafy,
                                                             "\nMargin of error: ", pct_moe, "%"),
                                        color = ~ age_new,
                                        colors = "Spectral",
                                        textposition = "inside",
                                        textfont = list(color = "black"),
                                        opacity = 0.8,
                                        type = "bar") %>%
  add_annotations(text = paste0("<i><b>Percent of population<b><i>"),
                  x = 0.1, y = 1.05, yref = "paper", xref = "paper", xanchor = "left", yanchor = "top", showarrow = F, font = list(size = 12)) %>%
  layout(title = "",
         barmode = "stack",
         xaxis = list(title = ""),
         yaxis = list(title = "Percent age-group"))
# subplot_title("Percent of population")


# sub_tp_disability_age_pct <- plot_ly(disability_age,
#         x = ~ location,
#         y = ~ pct_disability,
#         showlegend = T,
#         legendgroup = ~ age_new,
#         name = ~ age_new,
#         text = ~ paste0("Total: ", disability_est,
#                         "\nMargin of error: ", pct_moe_disab, "%",
#                         "\nPercent population: ", pct_disability_pop),
#         color = ~ age_new,
#         type = "bar") %>%
#   layout(title = "",
#          xaxis = list(title = ""),
#          yaxis = list(title = "Percent age-group")) %>%
#   subplot_title("Percent of age-group")

sub_tp_disability_age_pct <- plot_ly(disability_age,
                                     x = ~ age_new,
                                     y = ~ pct_disability,
                                     showlegend = T,
                                     legendgroup = ~ location,
                                     name = ~ location,
                                     text = ~ paste0("Total: ", disability_est,
                                                     "\nMargin of error: ", pct_moe_disab, "%",
                                                     "\nPercent population: ", pct_disability_pop),
                                     color = ~ location,
                                     mode = "line+marker",
                                     type = "scatter") %>%
  layout(title = "",
         xaxis = list(title = ""),
         yaxis = list(title = "Percent age-group")) %>%
  subplot_title("Percent of age-group")


subplot(sub_tp_disability_age_tot, sub_tp_disability_age_pctpop, sub_tp_disability_age_pct, nrows = 2, shareX = T) %>%
  layout(title = "Persons with a disability by age")

```

#### Disability by race

```{r race disability}
race_ability <- data_binder("race_disability") %>%
  location_col() %>%
  name_num_formatter() %>%
  filter(!grepl("white alone$", race)) %>%
  race_recode(race) %>%
  rename(estimate = name_race_disability_est, moe = name_race_disability_moe) 

race_ability <- race_ability %>%
  signif_mont_tp(c("race", "disability"), pct_race_disability, pct_moe) %>%
  signif_overall(race_ability, group_cols = c("location", "disability"), est_col = pct_race_disability, pct_moe) %>%
  signif_checker()

race_disability <- filter(race_ability, grepl("With a disability", disability) & !(race %in% tp_race_cats))

pull_race_disability <- pull_creator(race_disability, c("name", "race"))

pull_black_pctdisability_tp <- pull_race_disability(c("Takoma", "Black"), "pct_race_disability")

pull_white_pctdisability_tp <- pull_race_disability(c("Takoma", "White"), "pct_race_disability")

pull_black_pctdisability_mont <- pull_race_disability(c("Montgomery", "Black"), "pct_race_disability")

pull_white_pctdisability_mont <- pull_race_disability(c("Montgomery", "White"), "pct_race_disability")

pull_black_pctdisability_md <- pull_race_disability(c("^Maryland", "Black"), "pct_race_disability")

pull_white_pctdisability_md <- pull_race_disability(c("^Maryland", "White"), "pct_race_disability")


text_disab_race <- glue("**There appear to be some differences in disability-rates by race, but they are not different at a statistically significant level from the City's overall rate (meaning we cannot conclude there is an actual difference at a level of 90% confidence).** Despite this, we can assume there are differences in rates of disability by race compared to the City's overall rate because differences in the larger sample of Maryland are statistically-significant.
                        
                        There are some differences in rates of disability by race compared to Maryland and Montgomery County. A lower share of white Takoma Park residents have a disability ({pull_white_pctdisability_tp}%) compared to Maryland ({pull_white_pctdisability_md}%) and Montgomery County ({pull_white_pctdisability_mont}%), and a lower share of Black residents have a disability ({pull_black_pctdisability_tp}%) compared to Maryland ({pull_black_pctdisability_md}%).")

```

`r text_disab_race`

```{r plot race disability}

plot_race_disability <- plot_ly(race_disability %>%
                                  race_factor(),
                                x = ~ location,
                                name = ~ race,
                                color = ~ race,
                                colors = pal_race,
                                opacity = 0.8,
                                type = "bar",
                                y = ~ pct_race_disability,
                                text = ~ paste0("Margin of error: ", pct_moe, "%",
                                                "\nTotal: ", estimate %>% commafy,
                                                "\nSignificant differences: ", signif_check)) %>%
  layout(xaxis = list(title = ""),
         yaxis = list(title = "Percent of race"),
         title = "Persons with a disability by race")

plot_race_disability

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*

#### Disability by type

**The most common disabilities by type are ambulatory and independent-living disabilities.** Respectively, `r pull_disab_type_ambulatory`% and `r pull_disab_type_ind_pct`% of Takoma Park residents have these disabilities.

```{r display disab type}

plots_disabtype_sub

```

At a statistically-significant level, Takoma Park residents overall are less likely than Maryland residents to have any type of disability other than vision disabilities. Compared to Montgomery County residents, Takoma Park residents are less likely to have cognitive disabilities--representing `r pull_disab_type_cognitive_pct`% of Takoma Park residents compared to `r pull_disab_type_cognitive_pct_mont`% of Montgomery County residents--and hearing disabilities, representing `r pull_disab_type_hearing_pct`% of Takoma Park residents compared to `r pull_disab_type_hearing_pct_mont`% of County residents.

#### Disability by type and age

**Rates of most specific disabilities increase with age, although at different rates** (for definitions of disability types, see the methodology or [Census webpage](https://www.census.gov/topics/health/disability/guidance/data-collection-acs.html)). For instance, persons with ambulatory disabilities represent `r pull_disab_ambulatory_517_pct`% of 5-17 year olds compared to `r pull_disab_ambulatory_75_pct`% of people 75 and older, while persons with self-care disabilities represent `r pull_disab_selfcare_517_pct`% of 5-17 year olds and `r pull_disab_selfcare_75_pct`% of people 75 and older.

```{r plot disab type display}
plots_disab_type_age_subs

```

*Note: Percentages in the 'percent of persons with disability in age-group' graph exceed 100 because people can have multiple disabilities.*

Younger people with a disability are more likely to have cognitive disabilities, while older people with a disability are more likely to have ambulatory or other disabilities. `r pull_disab_cognitive_1834_disab`% of 18-34 year olds with a disability have a cognitive disability, compared to `r pull_disab_cognitive_6574_disab`% of 65-74 year olds with a disability and `r pull_disab_cognitive_75_disab`% of people 75+ with a disability. 

People 75 and over in general are still more likely to have a cognitive disability than other groups because rates of all disabilities are higher among people 75 and over. `r pull_disab_cognitive_75_pct`% of people 75 and over have a cognitive disability, compared to `r pull_disab_cognitive_1834_pct`% of people 18-34.



## Race and Ethnicity {.tabset .tabset-pills}

### Summary

#### *Racial demographics*

`r text_race_summary`

#### *Housing*

`r text_homeowners_race`

`r text_homeowners_econdispar`

#### *Poverty, employment, and income*

`r text_race_income`

`r text_incomedist_race_summary`

`r text_poverty_race_summary`

`r text_raceunemploy_summary`

#### *Education, health insurance, and internet-access*

`r text_race_educ_summary`

`r text_computer_race_summary`

`r text_health_race_noinsur_summary`

`r text_race_age_health_summary`

### Racial demographics

#### Table of contents

1) [Race overall]

2) [Race age]

3) [Race sex]

4) [Race birthplace]

5) [Race ancestry]

6) [Race disability]

<!-- 7) [Race map] -->

#### Race overall

`r text_raceoverall`

```{r plot racial demog overall}

fig_race_ethn

```

#### Race age

`r text_raceage`

```{r plot race age two}

plot_race_age_barcomp
```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*


#### Race sex

`r text_racegender`

```{r plot Race sex two}

plot_race_sex

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*


#### Race birthplace

`r text_race_birthplace`

```{r plot race birthplace two}

plot_race_birthplace

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*



#### Race ancestry

`r text_ancestry`

```{r plot ancestry two}
plot_ancestry_overall
```

*Note: The above chart is limited to ancestry-groups with at least 50 residents in Takoma Park.*

`r text_ancestry_disag`

```{r plot ancestry disag race}
plot_ancestry_sub

```

*Note: The above chart is limited to ancestry-groups with at least 50 residents in Takoma Park.*

`r text_asian_ancestry`

```{r plot asian ancestry disag}
plot_asian_disag

```

#### Race disability

`r text_disab_race`

```{r plot race disab two}
plot_race_disability

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*


### Housing

#### Table of contents

1) [Race home ownership]

2) [Housing cost burden by home-ownership]

3) [Housing cost burden by home-ownership and income]

#### Race home ownership

`r text_racetenure`

```{r print plot race tenure}

subplots_racetenure

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*

#### Housing cost burden by home-ownership

`r text_tenure_costburden`

```{r print plots cost burden tenure}

plot_tenure_costburden

```

#### Housing cost burden by home-ownership and income

`r text_tenure_costburdenincome`

```{r print plots cost burden income}

sublots_tenure_costburden_income

```

### Poverty, employment, and income

#### Table of contents

1) [Median income race]

2) [Income distribution race]

3) [Poverty race]

4) [Poverty by sex/race]

5) [Poverty by age/race]

6) [Unemployment race]

#### Median income race

`r text_medianinc_race`

```{r print race median income plot}

plot_raceincome
```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*

#### Income distribution race

`r text_incomedist_race`

```{r plot print income distribution race}

plot_raceincome_dist

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*


#### Poverty race

`r text_poverty_race`

```{r print race poverty plot}

plot_race_poverty

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*

#### Poverty by sex/race

`r text_pov_race_sex_p1`

```{display plots pov_race_sex}
plots_pov_race_sex

```

`r text_pov_race_sex_p2`

#### Poverty by sex/race

`r text_pov_race_sex_p1`

```{r display pov race sex}
plots_pov_race_sex

```

`r text_pov_race_sex_p2`


#### Poverty by age/race

`r text_poverty_race_age`

```{r plot_race_age_poverty print race section}

plot_race_age_poverty

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*

#### Unemployment race

`r text_raceunemploy`

```{r print plot text race unemploy}
plot_race_unemploy

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*

### Education, health, and internet-access

#### Table of contents

1) [Education]

2) [Internet access]

3) [Health insurance]

4) [Health insurance by age]


#### Education

`r text_race_educ`

```{r print plot_race_educ race section}

plot_race_educ

```

*Note: To avoid misrepresenting percentage data, the above graph is limited to racial/ethnic groups with more than 30 residents in Takoma Park, omitting American Indians and Alaska Natives (30 residents, with a margin of error of 29 residents), and Native Hawaiian and Other Pacific Islanders (0 residents).*

`r text_race_educ_compare`

```{r print race educ comparison plot}

sub_race_compare_educ

```


#### Internet access

`r text_computers_race`

```{r print plot race compint}

plot_computer_race

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*


`r text_computer_compare_race`

```{r print plot race compare computers}

plot_int_access_race_comp

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*


#### Health insurance

`r text_health_race_noinsur`

```{r print health race plot}

plot_health_race_noinsur

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*


`r text_health_race_noinsur_compare`

#### Health insurance by age

`r text_race_age_health`

```{r print plot race health age}
plot_race_age_health

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*

`r text_race_age_health_compare`

## Housing {- .tabset .tabset-pills}

### Summary

`r text_homeowners_race`

**Homeownership rates in Takoma Park increase with age through age 64 (from a low of `r pull_own_1524`% for 15-24 year olds to a high of `r pull_own_6064`% for 60-64 year olds) before declining.** Homeownership rates for all age groups fall below Maryland and Montgomery County, especially for people aged 65 and older.

`r text_homeowners_econdispar`

`r text_tenure_income`

### Housing

#### Table of contents

1) [Home-ownership]

2) [Homeownership by race]

3) [Homeownership by age]

4) [Housing cost burden by tenure]

5) [Tenure by income]

6) [Income distribution by tenure]

7) [Cost-burden by tenure and income]

#### Home-ownership {-}

Approximately `r pull_tp_rent_pct`% of Takoma Park's population are renters.

```{r  plot tenure, echo=FALSE}
# 
# plot_ly() %>%
#         add_pie(data = tenure_data %>%
#                 filter(grepl("Takoma", location)),
#         type = "pie",
#         labels = ~ tenure,
#         values = ~ pct_tenure,
#         name = "Takoma Park",
#         domain = list(x = c(0, 0.4), y = c(0.4, 1))) %>%
#         add_pie(data = tenure_data %>%
#                 filter(grepl("Montgomery", location)),
#         type = "pie",
#         labels = ~ tenure,
#         values = ~ pct_tenure,
#         name = "Montgomery County",
#         domain = list(x = c(0.6, 1), y = c(0.4, 1))) %>%
#         add_pie(data = tenure_data %>%
#                 filter(grepl("Maryland", location)),
#         type = "pie",
#         labels = ~ tenure,
#         values = ~ pct_tenure,
#         name = "Maryland",
#         domain = list(x = c(0.25, 0.75), y = c(0, 0.6)))


plot_ly(data = tenure_data,
        type = "bar",
        x = ~ tenure,
        y = ~ pct_tenure,
        hovertext = ~ glue("Total: {estimate}
        Significant differences: {signif_check}
        Margin of error: {pct_moe}%"),
        # text = ~ glue("{gsub('-occupied', '', tenure)}: {pct_tenure}%"),
        # textposition = "inside",
        # textfont = list(color = "black"),
        name = ~ location,
        color = ~ location) %>%
  layout(title = "Households by home-ownership",
         xaxis = list(title = "Tenure"),
         yaxis = list(title = "Percent of households"))
# barmode = "stack")


```


#### Homeownership by race {-}

`r text_racetenure`

```{r print subplots race tenure}
subplots_racetenure

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*


#### Homeownership by age

**As in Montgomery County and Maryland, homeownership rates in Takoma Park generally increase with age before declining at older ages, from a low of `r pull_own_1524`% of 15-24 year-olds to a high of `r pull_own_6064`% of 60-64 year-olds.** However, across age-groups, homeownership rates in Takoma Park are below rates in Montgomery County and Maryland. In particular, homeownership rates decline for residents aged-65 and above in Takoma Park; `r pull_own_6574`% of 65-74 year-old households in Takoma Park own homes compared to `r pull_own_6574_mont`% in Montgomery County and `r pull_own_6574_md`% in Maryland, and `r pull_own_7584`% of 75-84 year olds in Takoma Park own homes compared to `r pull_own_7584_mont`% and `r pull_own_7584_md`% in Montgomery County and Maryland respectively.

```{r plot tenure age print}

plots_tenure_age

```

#### Housing cost burden by tenure {-}


`r text_tenure_costburden`

```{r print plot tenure cost burden}
plot_tenure_costburden

# plot_ly(burden_tp, 
#         type = "bar",
#         color = ~ tenure,
#         x = ~ percent_income,
#         y = ~ estimate,
#         mode = "lines+markers") %>%
#         layout(yaxis = list(title = "Cumulative percent"),
#                xaxis = list(title = "Percent of income"))


```

#### Tenure by income {-}

**Takoma Park has a substantial gap in income between renter and homeowner households.** The median homeowner households earns \$`r (pull_tp_own_income - pull_tp_rent_income) %>% commafy` more than the median renter household annually, a wider disparity than in both Montgomery County (\$`r (pull_mont_own_income - pull_mont_rent_income) %>% commafy`) and the state of Maryland (\$`r (pull_md_own_income - pull_md_rent_income) %>% commafy`). This is because the median renter in Takoma Park earns less than in Montgomery County (\$`r (pull_mont_rent_income - pull_tp_rent_income) %>% commafy` less) and Maryland ($`r (pull_md_rent_income - pull_tp_rent_income) %>% commafy` less), and the median homeowner in Takoma Park earns more than in Montgomery County (\$`r (pull_tp_own_income - pull_mont_own_income) %>% commafy` more) and Maryland (\$`r (pull_tp_own_income - pull_md_own_income) %>% commafy` more).

```{r plot med income}
plot_ly(tenure_income_median, 
        type = "bar",
        orientation = "h",
        x = ~ estimate,
        y = ~ location,
        sort = FALSE,
        color = ~ tenure) %>%
  layout(yaxis = list(title = ""), 
         xaxis = list(title = "Median Income"),
         legend = list(traceorder = "normal"))

```


#### Income distribution by tenure {-}

**Housing data reveal differences in challenges experienced by renters and homeowners. `r pull_own_greater150`% of homeowners in Takoma Park have a household income above \$150,000, while only `r pull_rent_greater100`% of renters have a household income above \$100,000.** Conversely, `r pull_rent_below35k`% of renters have a household income below \$35,000, compared to `r pull_own_below35k`% of homeowners.

```{r renter_owner_income plot }

x_ax_rentown <- list(title = "Income",
                     categoryorder = "array",
                     categoryarray = ~ household_income)

y_ax_rentown <- list(title = "Cumulative Percent")

# graph
rent_own_num_income_fig <- plot_ly(group_by(rent_own_data, tenure), 
                                   x = ~income_recode, 
                                   y = ~ cumul_pct,
                                   type = "scatter",
                                   color = ~tenure,
                                   mode = "lines+markers") %>%
  layout(xaxis = x_ax_rentown, yaxis = y_ax_rentown, title = "Cumulative percent of owners/renters by household income")

rent_own_num_income_fig

# add data labels to - for % by category - maybe reverse categories
```


#### Cost-burden by tenure and income {-}

`r text_tenure_costburdenincome`

```{r print subplots tenure cost burden}

sublots_tenure_costburden_income

```


## Poverty, employment, and income {- .tabset .tabset-pills}

### Summary

#### *Income*

`r text_race_income`

`r text_incomedist_race_summary`

#### *Poverty*

**`r pull_tp_poverty`% of Takoma Park's population is below the poverty line (`r pull_tp_poverty_tot %>% commafy` residents)**, an additional `r pull_tp_below150-pull_tp_poverty`% (`r (pull_tp_below150_tot - pull_tp_poverty_tot) %>% commafy` residents) earn between 100% and 149% of the line, and an additional `r pull_tp_below2-pull_tp_below150`% (`r (pull_tp_below2_tot - pull_tp_below150_tot) %>% commafy` residents) earn between 150% and 199% of the line.

`r text_poverty_race_summary`


**By sex, poverty rates for female residents exceed men `r pull_pov_female_tp`% to `r pull_pov_male_tp`%.** Female nonfamily households had the highest poverty rates by household type at `r pull_fem_pov_tp_pct`%, and married-couple families the lowest at `r pull_marr_pov_tp_pct`%. Poverty rates for female Black (`r pull_pov_tp_female_black`%), Hispanic (`r pull_pov_tp_female_hispanic`%), and residents with a race of 'other' (`r pull_pov_tp_female_other`%) exceed poverty rates for white female residents (`r pull_pov_tp_female_white`%), and poverty rates for Black men (`r pull_pov_tp_male_black`%) exceed poverty rates for white men (`r pull_pov_tp_male_white`%).

**By age, poverty rates for Takoma Park residents aged 18-59 and 60-74 exceeded poverty rates for Montgomery County** (at `r pull_tp_poverty_1859`% and `r pull_tp_poverty_6074`% compared to `r pull_mont_poverty_1859`% and `r pull_mont_poverty_6074`%), **while poverty rates for residents under 6 and between 12-17 fell below Montgomery County's** (`r pull_tp_poverty_6`% for under 6 in Takoma Park compared to `r pull_mont_poverty_6`% in Montgomery County, and `r pull_tp_poverty_1217`% for 12-17 residents compared to `r pull_mont_poverty_1217`%).

#### *Unemployment*

**Takoma Park has `r pull_tp_unemploy_num` unemployed residents over 65,** for an unemployment rate of `r pull_tp_unemploy`%. 

`r text_raceunemploy_summary`

**Unemployment rates decline with age from a high of `r pull_tp_unemploy_2021`% at 20-21 to a low of 0 percent for people aged 60 to 69.** People aged 45 to 54 have a statistically-significant, higher unemployment rate in Takoma Park than Montgomery County or Maryland at `r pull_tp_unemploy_4554`% compared to `r pull_mont_unemploy_4554`% in Montgomery County and `r pull_md_unemploy_4554`% in Maryland.

### Income

#### Table of contents

1) [Income distribution]

2) [Median income by race]

3) [Income distribution by race]

#### Income distribution {-}

**Takoma Park has a higher proportion of low-income households than Maryland or Montgomery County; a lower-proportion of high-income households than Montgomery County; and a higher proportion of very-high-income households than Maryland.** `r pull_tp_incomeless35`% of Takoma Park households earn less than \$35,000 annually (`r pull_tp_incomeless35_tot %>% commafy` total), compared to `r pull_md_incomeless35`% of Maryland households and `r pull_mont_incomeless35`% of Montgomery County households. `r 100 - pull_tp_income7599`% of Takoma Park households earn at least \$100,000, compared to `r 100 - pull_mont_income7599`% of Montgomery County households. And `r 100 - pull_tp_income150199`% of Takoma Park households earn more than \$200,000, compared to `r 100 - pull_md_income150199`% of Maryland households.

```{r income last 12 plot, echo=FALSE}

plot_ly(income_levels, 
        type = "scatter",
        y = ~ pct_cumul,
        color = ~ location,
        name = ~location,
        x = ~income_recode,
        hovertext = ~ glue("Cumulative total: {tot_cumul %>% commafy}
                           Income-group total: {estimate %>% commafy}
                           Income-group percent: {pct_income_range}%"),
        mode = "markers+lines") %>%
  layout(yaxis = list(title = "Cumulative percent"),
         xaxis = list(title = "Income range"), 
         title = "Cumulative percent of households by income")

```

#### Median income by race {-}


`r text_medianinc_race`

```{r print plot race income}

plot_raceincome


```

*Note: American Indians/Alaska Natives as well as Native Hawaiians and other Pacific Islanders are excluded from the above chart because of the low number of these residents in Takoma Park.*

#### Income distribution by race {-}

`r text_incomedist_race`


```{r print plot race income distr}

plot_raceincome_dist
```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*


`r text_race_income_compare`

```{r print plot race income compare}

plot_raceincomecompare

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*



### Poverty

#### Table of contents

1) [Poverty]

2) [Poverty by race]

3) [Poverty by sex]

4) [Poverty by age]

5) [Poverty by household-type]

6) [Poverty by family-type]

7) [Poverty by race and sex]

8) [Poverty by race and age]

9) [Poverty by sex and age]

<!-- 10) [Poverty by household-type and age] -->

#### Poverty {-}

The ACS makes detailed data available on residents' income relative to the poverty threshold. The official US poverty line for a family of four in 2021 is \$[26,500](https://aspe.hhs.gov/2021-poverty-guidelines). The line underestimates actual poverty; it is [outdated](https://www.americanprogress.org/issues/poverty/news/2020/03/05/481314/poverty-line-matters-isnt-capturing-everyone/) and does not account for costs other than food (e.g., housing, transportation, medical costs). A number of federal programs base eligibility on the poverty line; for example, households cannot earn more than 130% of the federal poverty line to qualify for the Supplemental Nutrition Assistance Program (SNAP).

**Takoma Park has a similar poverty rate to Montgomery County and Maryland.** `r pull_tp_poverty`% of Takoma Park's population is below the poverty line (`r pull_tp_poverty_tot %>% commafy` residents), compared to `r pull_mont_poverty`% of Montgomery County. An additional `r pull_tp_below150-pull_tp_poverty`% (`r (pull_tp_below150_tot - pull_tp_poverty_tot) %>% commafy` residents) of Takoma Park's population earn between 100% and 149% of the poverty level (compared to `r pull_mont_below150-pull_mont_poverty`% for Montgomery County), and an additional `r pull_tp_below2-pull_tp_below150`% (`r (pull_tp_below2_tot - pull_tp_below150_tot) %>% commafy` residents) earn between 150% and 199% of the poverty line (compared to `r pull_mont_below2-pull_mont_below150` in Montgomery County). Given [inaccuracies](https://www.businessinsider.com/us-poverty-measure-misleading-outdated-leaves-out-millions-american-families-2020-7) in US poverty measures, many of these residents are economically vulnerable.

```{r plot income pov detail}

plot_ly(poverty_detail %>%
          ungroup,
        x = ~ incpov_new,
        y = ~ pct_cumul,
        name = ~ location,
        color = ~ location,
        type = "scatter",
        mode = "lines+markers",
        hovertext = ~ glue("Cumulative total: {tot_cumul %>% commafy}
        Group total: {estimate %>% commafy}
        Group percent: {pct_incpov}%
        Group margin of error: {moe %>% commafy}
        Group significant-differences: {signif_check}")) %>%
  layout(xaxis = list(title = "Income to poverty ratio"),
         yaxis = list(title = "Cumulative percent residents"),
         title = "Cumulative percent of residents by income-to-poverty ratio")


```

#### Poverty by race

`r text_poverty_race`


```{r print plot race poverty}
plot_race_poverty

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*


#### Poverty by sex

**The estimated poverty rate for women in Takoma Park exceeds men `r pull_pov_female_tp`% to `r pull_pov_male_tp`%.** There is not a statistically significant difference between Takoma Park's poverty rate and Maryland or Montgomery County's, although Takoma Park's estimates are closer to Maryland's female poverty rate of `r pull_pov_female_md`% and male of `r pull_pov_male_md`%. There are statistically-significant differences between female and male poverty rates in Maryland and Montgomery County; although the difference in Takoma Park is not statistically-significant, it is reasonable to assume that there is an actual difference in poverty rates between the sexes based on them holding-up in the larger sample of Maryland and Montgomery County.

```{r display plot pov sex}

plot_pov_sex

```


#### Poverty by age

**Due to the small samples involved and large margin of error, no age group had a statistically significant difference from the city's overall poverty rate** of `r pull_tp_poverty_overall`% (meaning we cannot conclude with at least 90% confidence that any age group's poverty rate is actually higher or lower than the overall rate, even if the estimate is higher or lower). For instance, the highest estimated poverty rate by age group was for people aged 75 and older at `r pull_tp_poverty_75`% but the margin of error was `r pull_tp_poverty_75_moe`%, meaning our estimate of the actual-rate at 90% confidence falls between `r pull_tp_poverty_75 - pull_tp_poverty_75_moe`% and `r pull_tp_poverty_75 + pull_tp_poverty_75_moe`%. The only age group with a statistically-significant difference from the city's overall poverty rate were children under 6, with a poverty rate of `r pull_tp_poverty_6`%.

**Some age groups did have a statistically significant difference in poverty-rates compared to Montgomery County and Maryland.** Takoma Park residents aged 60 to 74 and 18 to 59 had higher poverty rates than Montgomery County, at `r pull_tp_poverty_6074`% compared to `r pull_mont_poverty_6074`% for people aged 60 to 74 and `r pull_tp_poverty_1859`% compared to `r pull_mont_poverty_1859`% for people 18 to 59. Residents aged 12-17 had a statistically lower poverty rate than Maryland at `r pull_tp_poverty_1217`% compared to `r pull_md_poverty_1217`%, and residents under 6 had a lower poverty rate than Montgomery County or Maryland at `r pull_tp_poverty_6`% compared to `r pull_mont_poverty_6`% and `r pull_md_poverty_6`% respectively.

```{r plot poverty age}
plot_age_pov_pct <- plot_ly(poverty_age_processed,
                            x = ~ location,
                            y = ~ pct_agepov,
                            color = ~ age_new,
                            name = ~ age_new,
                            showlegend = T,
                            legendgroup = ~ age_new,
                            type = "bar",
                            hovertext = ~ glue("Total: {agepov_est}
                           Margin of error: {pct_moe}%
                           Significant differences: {signif_check}")) %>%
  layout(xaxis = list(title = ""),
         yaxis = list(title = "Percent poverty"),
         title = "Poverty by age") %>%
  subplot_title("Percent")

plot_age_pov_tot <- plot_ly(poverty_age_processed %>% filter(grepl("Takoma", location)),
                            x = ~ age_new,
                            y = ~ agepov_est,
                            color = ~ age_new,
                            name = ~ age_new,
                            legendgroup = ~ age_new,
                            showlegend = F,
                            type = "bar",
                            hovertext = ~ glue("Percent: {pct_agepov}
                           Margin of error: {agepov_moe}")) %>%
  layout(xaxis = list(title = ""),
         yaxis = list(title = "Percent poverty"),
         title = "Poverty by age") %>%
  subplot_title("Total")

subplot(plot_age_pov_pct, plot_age_pov_tot, shareX = F, nrows = 2)

```

#### Poverty by household-type

The largest number of householders in poverty in Takoma Park are female, nonfamily households (`r pull_fem_pov_tp %>% commafy` households), followed by male nonfamily households (`r pull_mal_pov_tp %>% commafy`) and single-female family households (`r pull_femfam_pov_tp %>% commafy`). 

```{r plot housetype poverty}

plots_hous_typ_poverty <- subplot(plot_houstype_pov_tp, plot_houstype_pov, nrows = 2, shareX = T) %>%
  layout(title = "Poverty by household type")

plots_hous_typ_poverty

```

*Note: the City poverty rate of `r pull_tp_poverty`% differs from the household rate of `r pull_house_pov`% because the city rate applies to people, and the household rate to households.*

Compared to the City's household poverty rate of `r pull_house_pov`%, poverty rates for female nonfamily households (`r pull_fem_pov_tp_pct`%) are higher at a statistically significant level, and poverty rates for married couples are lower (`r pull_marr_pov_tp_pct`%). In Takoma Park poverty rates for single-female families are higher than the overall rate at `r pull_femfam_pov_tp_pct`%, but not at a statistically-significant level; however, rates in the larger sample of Montgomery County and Maryland are higher, suggesting that poverty-rates for single-female families may actually be higher in Takoma Park than the overall level but not show up due to the sample size.

#### Poverty by family-type

Family poverty rates in Takoma Park are highest for single women and single men living with children (at `r pull_fem_child_pov`% and `r pull_mal_child_pov`% respectively), and lowest for men without children living with family members (at 0%), and married families with and without children (at `r pull_marr_child_pov`% and `r pull_marr_nochild_pov`%). Married families with and without children have a significantly lower poverty rate than the City's household-poverty rate of `r pull_house_pov`%, and single-female families with children have a significantly lower poverty rate than single-female headed families in Maryland of `r pull
pull_fem_child_pov_md`%.

```{r plot poverty family}

plots_poverty_family <- subplot(plot_family_pov_loc, plot_family_pov_tp, nrows = 2, shareX = F) %>%
  layout(title = "Family poverty by householder and children")

plots_poverty_family

```

*Note: the City poverty rate of `r pull_tp_poverty`% differs from the household rate of `r pull_house_pov`% because the city rate applies to people, and the household rate to households.*

Even though single-female families with children and single-male families with children have the same poverty rates, because there are not many single-male householder families with children in Takoma Park, the highest number of families in poverty in Takoma Park are `r pull_fem_child_pov_tot %>% commafy` single-female families with children, followed by `r pull_marr_nochild_pov_tot %>% commafy` married families without children, and then `r pull_mal_child_pov_tot` single-male families with children.

#### Poverty by race and sex

`r text_pov_race_sex_p1`

```{r display pov race sex pov section}
plots_pov_race_sex

```

`r text_pov_race_sex_p2`


#### Poverty by race and age

`r text_poverty_race_age`

```{r plot_race_age_poverty print econ section}

plot_race_age_poverty

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*

#### Poverty by sex and age

**Except for ages 0 to 17 and 45-54 in Takoma Park, estimates of womens' poverty rates exceed men.** No differences appear as statistically significant in the data for Takoma Park; however, differences in the larger-samples of Montgomery County and Maryland show up as statistically significant in all age-groups 18 and over.


```{r plot sex age poverty}
plots_pov_sex_age
```


<!-- #### Poverty by household-type and age -->

<!-- The small sample sizes and high margin of error make it difficult to draw conclusions about poverty-levels broken out by age and household type, and family-type broken out by race. It still may be useful to see Census totals, while keeping in mind the high margin of error. -->

<!-- By age and household type, the largest number of households in poverty are female nonfamily householders older than 65 making up `r pull_fem_nf_pov_65 %>% commafy`, followed by single-female householders aged 25-44--representing `r pull_fem_fam_pov_2544 %>% commafy`--and single male nonfamily households aged 45 to 64, representing `r pull_mal_nf_pov_4564 %>% commafy`. -->

<!-- ```{r family poverty plot} -->
<!-- plot_hous_type_age_pov -->

<!-- ``` -->


### Unemployment

#### Table of contents

1) [Unemployment]

2) [Unemployment by race]

3) [Unemployment by age]

#### Unemployment {-}

**The total number of unemployed residents in Takoma Park is `r pull_tp_unemploy_num`, for an unemployment rate of `r pull_tp_unemploy`%.** The rate estimate is higher than Montgomery County's `r pull_mont_unemploy`% or Maryland's `r pull_md_unemploy`%, but the difference is not statistically significant at a 90% confidence-level (meaning we cannot conclude that Takoma Park's unemployment rate is actually different from Montgomery County's or Maryland's).

```{r plot unemployment overall}

plot_ly(unemploy_overall_processed %>%
          filter(employment_status != "Employed"),
        x = ~ location,
        y = ~ pct_workers %>% round(., 1),
        text = ~ glue("Total: {workers_est %>% commafy}
        Margin of error: {pct_moe}%
        Significant differences: {signif_check}"),
        color = ~ location,
        name = ~ location,
        type = "bar") %>%
  layout(title = "Unemployment rate by place",
         xaxis = list(title = ""),
         yaxis = list(title = "Percent civilian labor force"))

```

#### Unemployment by race {-}

`r text_raceunemploy`

```{r print plot race unemploy}
plot_race_unemploy


```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*


#### Unemployment by age {-}

**As with Montgomery County and Maryland, unemployment rates in Takoma Park generally decline with age, with a high estimate in Takoma Park of `r pull_tp_unemploy_2021`% at 20-21 and a low of 0 percent for people aged 60 to 69.** People aged 45 to 54 have a statistically-significant, higher unemployment rate in Takoma Park than Montgomery County or Maryland at `r pull_tp_unemploy_4554`% compared to `r pull_mont_unemploy_4554`% in Montgomery County and `r pull_md_unemploy_4554`% in Maryland.

```{r plot unemploy age}

sub_pct_unemploy <- plot_ly(unemploy_age_processed %>%
                              filter(employment_status != "Employed"), 
                            x = ~ age_new,
                            y = ~ pct_labor,
                            name = ~ location,
                            legendgroup = ~ location,
                            showlegend = T,
                            color = ~ location,
                            text = ~ glue("Total: {labor_est %>% commafy}
                            Margin of Error: {pct_moe}%
                            Significant differences: {signif_check}"),
                            type = "scatter",
                            colors = "Set1",
                            mode = "line+marker") %>%
  layout(title = "Civilian unemployment rate by age",
         xaxis = list(title = "Age range"),
         yaxis = list(title = "Total civilian labor force")) %>%
  subplot_title("Percent unemployed")

sub_tot_unemploy <- plot_ly(unemploy_age_processed %>%
                              filter(employment_status != "Employed" & grepl("Takoma", location)), 
                            x = ~ age_new,
                            y = ~ labor_est,
                            name = ~ age_new,
                            legendgroup = ~ age_new,
                            showlegend = F,
                            color = ~ age_new,
                            text = ~ paste0("Percent unemployed: ", pct_labor, "%",
                                            "\nMargin of error: ", labor_moe %>% round(., 0)),
                            type = "bar") %>%
  layout(title = "Civilian unemployment rate by age",
         xaxis = list(title = "Age range"),
         yaxis = list(title = "Percent civilian labor force")) %>%
  subplot_title("Total unemployed")

subplot(sub_pct_unemploy, sub_tot_unemploy, nrows = 2, shareX = T) %>%
  layout(title = "Unemployment by age range")

```

## Education, health insurance, and computer-access {- .tabset .tabset-pills}

### Summary

#### *Education*

**Compared to Montgomery County and Maryland, Takoma Park has a larger share of people with both the highest and lowest-levels of educational attainment.** `r pull_tp_bachelor + pull_tp_graduate`% of the city's population has a graduate or bachelor's degree--exceeding Maryland--and `r pull_tp_graduate`% have a graduate degree, exceeding Montgomery County and Maryland. At the other end, `r pull_tp_lesshs`% of residents did not complete high school--exceeding Montgomery County and Maryland--and `r pull_tp_lesshs + pull_tp_hs`% of residents' highest level of educational attainment was a high school degree or less, exceeding Montgomery County.

`r text_race_educ_summary`

#### *Internet access*

**`r pull_tp_broadband`% of Takoma Park residents have access to broadband internet, a lower share than Montgomery County's `r pull_mont_broadband`%.** Of those without broadband access, `r pull_tp_noint`% have a computer but no internet, and `r pull_tp_nocomp`% have no computer.

`r text_computer_race_summary`

**Takoma Park residents under 18 and between 18 and 65 have similar levels of access to broadband internet, while residents over 65 have much lower levels.** `r pull_broadband_under18`% of under-18 residents have broadband access and `r pull_broadband_1865`% of residents 18-64 have access to broadband internet, while only `r pull_broadband_65`% of 65 and over residents do. Levels of computer and internet access by age are similar between Maryland and Takoma Park, but Montgomery County residents aged 18-64 and over 65 especially have higher levels of internet access.

#### *Health insurance*

**A higher share of Takoma Park residents do not have any health insurance than Montgomery County or Maryland, and a higher share rely on income-based healthcare programs than Montgomery County.** `r pull_tp_noinsur_tot %>% commafy` total and `r pull_tp_noinsur`% of Takoma Park residents do not have any insurance, compared to `r pull_mont_noinsur`% of Montgomery County residents and `r pull_md_noinsur`% of Maryland residents.

**Compared to other age-groups, Takoma Park residents under 18 are most-likely to either be on Medicaid or other income-based programs, and 19-34 year-old residents are most-likely to not have any health insurance.** `r pull_means_under18_pct`% of residents under 19 (`r pull_means_under18_tot %>% commafy` total) are on Medicaid or other means-tested programs, and `r pull_none_1934_pct`% (`r pull_none_1934_tot` total) of 19-34 year olds lack health insurance. Compared to Montgomery County and Maryland, a higher share of Takoma Park residents across all age-groups either do not have insurance or are on an income-based health insurance program.

`r text_health_race_noinsur_summary`

`r text_race_age_health_summary`

### Education


#### Table of contents

1) [Education overall]

2) [Education by race]

#### Education overall {-}

**Education levels are stratified in Takoma Park.** The City has a higher share of its adult population with graduate degrees at `r pull_tp_graduate`% than either Montgomery County (`r pull_mont_graduate`%) or Maryland (`r pull_md_graduate`%), and the `r pull_tp_graduate + pull_tp_bachelor`% of its population with a graduate or bachelor's degree exceeds Maryland. However, a larger share of Takoma Park's population than Maryland or Montgomery County did not graduate from high school--`r pull_tp_lesshs`% compared to `r pull_md_lesshs`% and `r pull_mont_lesshs`%--and a larger share of Takoma Park's population concluded their education after or before completing high school than Montgomery County at `r pull_tp_hs + pull_tp_lesshs`% compared to `r pull_mont_hs+pull_mont_lesshs`%.

```{r education overall plot , echo=FALSE}
plot_ly(educ_overall,
        x = ~ location,
        y = ~ percent_pop,
        color = ~ educ_recode,
        name = ~ educ_recode,
        text = ~ paste0(educ_recode, ":\n", percent_pop, "%"),
        textposition = "inside",
        textfont = list(color = "black"),
        opacity = 1,
        colors = "Pastel2",
        type = "bar",
        hovertext = ~ glue("Total: {estimate %>% commafy}
                             Margin of error: {pct_moe}%
                             Significant differences: {signif_check}")) %>%
  layout(xaxis = list(title = ""),
         yaxis = list(title = "Percent"),
         barmode = "stack",
         title= "Educational attainment by place")


```

#### Education by race {-}

`r text_race_educ`

```{r print plot_race_educ}

plot_race_educ

```

*Note: To avoid misrepresenting percentage data, the above graph is limited to racial/ethnic groups with more than 30 residents in Takoma Park, omitting American Indians and Alaska Natives (30 residents, with a margin of error of 29 residents), and Native Hawaiian and Other Pacific Islanders (0 residents).*

`r text_race_educ_compare`

```{r print race educ comparison plot educ section}

sub_race_compare_educ

```


### Internet access

#### Table of contents

1) [Internet access overall]

2) [Internet access by race]

3) [Internet access by age]

#### Internet access overall

**`r pull_tp_noint_tot` total and `r pull_tp_noint`% of Takoma Park residents have a computer but no internet access, and `r pull_tp_nocomp_tot` total and `r pull_tp_nocomp`% more residents do not have a computer.** Rates of internet and computer access mostly are similar to Montgomery County and Maryland, except that the percent of residents without a computer exceeds Montgomery County's share of `r pull_mont_nocomp`%, and the `r pull_tp_broadband`% of Takoma Park residents with broadband internet falls below Montgomery County's share of `r pull_mont_broadband`%.

```{r plot computer}
plot_ly(comp,
        x = ~ location,
        y = ~ pct_comp_int,
        color = ~ comp_int,
        name = ~ comp_int,
        type = "bar",
        text = ~ glue("{comp_int}: {pct_comp_int}%"),
        hovertext = ~ glue("Margin of error: {pct_moe}%
                           Total: {estimate %>% commafy}
                           Significant differences: {signif_check}"),
        textposition = "inside",
        textfont = list(color = "black"),
        opacity = 0.8,
        colors = "Set3"
) %>%
  layout(barmode = "stack",
         xaxis = list(title = ""),
         yaxis = list(title = "Percent population")) %>%
  layout(title = "Internet access by location")

```

#### Internet access by race {-}

`r text_computers_race`

```{r print plot computer race}


plot_computer_race

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*

`r text_computer_compare_race`

```{r print plot internet access race}

plot_int_access_race_comp

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*



#### Internet access by age

**Takoma Park residents under 18 and between 18 and 65 have similar levels of access to broadband internet, while residents over 65 have much lower levels.** `r pull_broadband_under18`% of under-18 residents have broadband access and `r pull_broadband_1865`% of residents 18-64 have access to broadband internet, while only `r pull_broadband_65`% of 65 and over residents do. Of those over-65 without broadband internet access, `r pull_comp_65`% do not have a computer, and `r pull_noint_65`% have no internet access.

**Levels of computer and internet access by age are similar between Maryland and Takoma Park, but Montgomery County residents aged 18-64 and over 65 especially have higher levels of internet access.** `r pull_broadband_65_mont`% of Montgomery County residents over 65 have broadband internet access, compared to `r pull_broadband_65`% of Takoma Park residents. Only `r pull_comp_65_mont`% of Montgomery County residents over 65 do not have computers, compared to `r pull_comp_65`% of Takoma Park residents over 65. Additionally a slightly higher share of Montgomery County residents between 18 and 64 have broadband internet access (`r pull_broadband_1865_mont`%) than Takoma Park residents (`r pull_broadband_1865`%).

```{r plot comp age}

plot_gen_agecomp <- function(location_val, showleg = F){
  
  # plot_ly(comp_age %>%
  #         filter(grepl(location_val, age_new)),
  #       x = ~ rev(comp_int),
  #       showlegend = showleg,
  #       y = ~ cumul_pct,
  #       legendgroup = ~ location,
  #       type = "scatter",
  #       mode = "line+marker",
  #       # text = ~ glue("{location}:\n{pct_comp_int}"),
  #       # textposition = "inside",
  #       # textfont = list(color = "black"),
  #       hovertext = ~ glue("Margin of error: {pct_moe}%
  #                          Total: {estimate %>% commafy}"),
  #       opacity = 0.8,
  #       name = ~ location,
  #       color = ~ location) %>%
  # layout(
  #   # barmode = "stack",
  #        xaxis = list(title = ""),
  #        yaxis = list(title = "")) %>%
  # plotly::add_annotations(text = paste0("<i><b>",
  #                                       location_val, "</i></b>"), x = 0.1, y = 1, yref = "paper",
  #                         xref = "paper", xanchor = "left", yanchor = "top",
  #                         showarrow = FALSE, font = list(size = 12))
  # 
  # 
  plot_ly(comp_age %>%
            filter(grepl(location_val, age_new)),
          x = ~ comp_int,
          showlegend = showleg,
          y = ~ pct_comp_int,
          legendgroup = ~ location,
          type = "bar",
          # text = ~ glue("{location}:\n{pct_comp_int}"),
          # textposition = "inside",
          # textfont = list(color = "black"),
          hovertext = ~ glue("Margin of error: {pct_moe}%
                             Total: {estimate %>% commafy}
                             Significant differences: {signif_check}"),
          opacity = 0.8,
          name = ~ location,
          color = ~ location) %>%
    layout(
      # barmode = "stack",
      xaxis = list(title = ""),
      yaxis = list(title = "")) %>%
    plotly::add_annotations(text = paste0("<i><b>",
                                          location_val, "</i></b>"), x = 0.1, y = 1, yref = "paper",
                            xref = "paper", xanchor = "left", yanchor = "top",
                            showarrow = FALSE, font = list(size = 12))
  
  # plot_ly(comp_age %>%
  #           filter(grepl(location_val, location)),
  #         x = ~ age_new,
  #         showlegend = showleg,
  #         y = ~ pct_comp_int,
  #         type = "bar",
  #         text = ~ glue("{location}:\n{pct_comp_int}"),
  #         textposition = "inside",
  #         textfont = list(color = "black"),
  #         opacity = 0.8,
  #         name = ~ comp_int,
  #         color = ~ comp_int) %>%
  # layout(barmode = "stack",
  #        xaxis = list(title = ""),
  #        yaxis = list(title = "")) %>%
  #   plotly::add_annotations(text = paste0("<i><b>",
  #       location_val, "</i></b>"), x = 0.1, y = 1.1, yref = "paper",
  #       xref = "paper", xanchor = "left", yanchor = "top",
  #       showarrow = FALSE, font = list(size = 12))
}

subplot(plot_gen_agecomp("< 18", T),
        plot_gen_agecomp("18-64"),
        plot_gen_agecomp("65+"), 
        nrows = 1,
        shareX = T,
        shareY = T) %>%
  layout(title = "Internet access by age and location",
         yaxis = list(title = "Percent"))

```



### Health insurance

#### Table of contents

1) [Health insurance overall]

2) [Health insurance by age]

3) [Health insurance by race]

4) [Health insurance by race and age]

#### Health insurance overall

**A higher share of Takoma Park residents do not have any health insurance than Montgomery County or Maryland, and a higher share rely on income-based healthcare programs than Montgomery County.** `r pull_tp_noinsur_tot %>% commafy` total and `r pull_tp_noinsur`% of Takoma Park residents do not have any insurance, compared to `r pull_mont_noinsur`% of Montgomery County residents and `r pull_md_noinsur`% of Maryland residents. Additionally, `r (pull_tp_medicaid_tot + pull_tp_medicaidmedicare_tot) %>% commafy` total and `r pull_tp_medicaid + pull_tp_medicaidmedicare`% of residents are on Medicaid (`r pull_tp_medicaid`% on Medicaid alone and `r pull_tp_medicaidmedicare`% on both Medicaid and Medicare) compared to `r pull_mont_medicaid + pull_mont_medicaidmedicare`% of Montgomery County residents.

```{r health insurance overall}
# health_insur_overall <- 

plot_ly(health_insur_overall,
        x = ~ location,
        y = ~ pct_health,
        color = ~ health_new,
        text = ~ glue("{health_new}:
        {pct_health}"),
        textfont = list(color = "black"),
        textposition = "inside",
        hovertext = ~ glue("Margin of error: {pct_moe}%
                          Total: {health_est %>% commafy}
                          Significant differences: {signif_check}"),
        name = ~ health_new) %>%
  layout(barmode = "stack",
         title = "Health insurance by location",
         xaxis = list(title = ""),
         yaxis = list(title = "Percent population"))

```


#### Health insurance by age

**By age-range, younger Takoma Park residents are most-likely to either be on Medicaid or other income-based programs.** `r pull_means_under18_pct`% of residents under 19 (`r pull_means_under18_tot` total) are on Medicaid or other means-tested programs, compared to `r pull_means_1934_pct`% of residents aged 19-34 (`r pull_means_1934_tot` total), `r pull_means_3564_pct`% of residents aged 35-64 (`r pull_means_3564_pct` total), and `r pull_means_65_pct`% of residents aged 65 and older on both Medicaid and Medicare (`r pull_means_65_tot` total).

**Compared to other age groups, 19-64 year old residents are most likely to not have any insurance.** `r pull_none_1934_pct`% of 19-34 year-old residents (`r pull_none_1934_tot` total) and `r pull_none_3564_pct`% of 35-64 year old residents (`r pull_none_3564_tot` total) have no insurance, followed by `r pull_none_under18_pct`% of under-19 residents (`r pull_none_under18_tot` total).

```{r plot health age}

plot_health_age <- function(age_val, showleg = F){
  plot_ly(health_insur_age_process %>%
            filter(health_new %in% types_concern) %>%
            filter(grepl(age_val, age_new)),
          x = ~ location,
          y = ~ pct_health,
          name = ~ health_new,
          color = ~ health_new,
          legendgroup = ~ health_new,
          showlegend = showleg,
          hovertext = ~ glue("Total: {estimate}
                           Margin of error: {pct_moe}%
                           Significant differences: {signif_check}"),
          text = ~ glue("\n{pct_health}%"),
          textposition = "inside",
          textfont = list(color = "black"),
          opacity = 0.8,
          type = "bar") %>%
    layout(xaxis = list(title= ""),
           yaxis = list(title = ""),
           barmode = "stack",
           title = "") %>%
    subplot_title(age_val)
}

plot_health_under19 <- plot_health_age("< 19", T)


plot_health_1934 <- plot_health_age("19-34", F)
plot_health_3564 <- plot_health_age("35-64", F)
plot_health_over65 <- plot_health_age("65+", F)

subplot(plot_health_under19,
        plot_health_1934,
        plot_health_3564, 
        plot_health_over65,
        shareY = T, nrows = 1, shareX = T) %>%
  layout(title = "No insurance/means-tested health-care by age",
         yaxis = list(title = "Percent"))


```

**Compared to Montgomery County and Maryland, a higher share of Takoma Park residents in all age-groups either don't have insurance, or are on Medicaid or another income-based health insurance program** (although some are within the margin of error of Maryland). In particular, the share of Takoma Park residents over 65 that are on Medicaid and Medicare (`r pull_means_65_pct`%) more than doubles the share of Maryland (`r pull_means_65_pct_md`%) and Montgomery County (`r pull_means_65_pct_mont`%). Other statistically-significant differences include that in Takoma Park, `r pull_none_3564_pct`% of 35-64 year olds have no health insurance compared to `r pull_none_3564_pct_md`% of Maryland residents and `r pull_none_3564_pct_mont`% of Montgomery County residents; and `r pull_means_1934_pct`% of 19-34 year olds are on income-based health insurance compared to `r pull_means_1934_pct_mont`% in Montgomery County and `r pull_means_1934_pct_md`% in Maryland. 

#### Health insurance by race

`r text_health_race_noinsur`

```{r print plot health race no insurance}

plot_health_race_noinsur


```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*

`r text_health_race_noinsur_compare`

#### Health insurance by race and age

`r text_race_age_health`

```{r plot display race age health}
plot_race_age_health

```

*Note: Due to the low number of NHPI and AIAN residents in Takoma Park, they are omitted from the above chart.*


## Methodology {-}

### Methodology

#### Data sources

This webpage displays selected data from the 2015-2019 American Community Survey. The webpage was produced using RMarkdown. Data is downloaded from the Census using R's tidycensus package. Block-group data in the racial demographics map as well as the shapefile come from NHGIS, cited below. Data will be updated periodically (potentially with additional visualizations), and with 2016-2020 data once the newest version of the American Community Survey is released. Updates are described at the bottom of the page.

#### Organization of race/ethnicity data

Race and ethnicity data are consolidated in the "Race and Ethnicity" tab, and repeat in each subject-area heading tab (e.g., race/ethnicity housing data can be found in the "Housing" sub-tab of the "Race and Ethnicity" heading-tab, as well as in the "Housing" heading-tab).

#### The ACS vs. the decennial Census

Decennial Census results for 2020 will be analyzed separately. This is because the 5-year ACS updates each year rather than every 10 years (allowing more regular update to this webpage), contains some different data than the decennial Census, reflects different data than the decennial Census (survey results from a 5-year period rather than just 2020), and is collected differently (e.g., using statistical sampling to generate estimates rather than trying to survey every household).

#### Race in the ACS

The ACS survey asks residents whether they are one or multiple of the following races: white, Black or African American, Asian, Native Hawaiian and Other Pacific Islander, and American Indian and Alaska Native. The Census also leaves a sixth option, "Some Other Race," which people can fill in on their own (e.g., the Census [reports](https://www.census.gov/library/stories/2021/08/improved-race-ethnicity-measures-reveal-united-states-population-much-more-multiracial.html) that many Hispanic or Latino respondents listed "their race as 'Mexican,' 'Hispanic,' 'Latin American,' [or] 'Puerto Rican').

#### Households and families defined

[The Census defines](https://www.census.gov/programs-surveys/cps/technical-documentation/subject-definitions.html#familyhousehold) a household as all people in a housing unit. A housing unit is a separate living quarters, meaning occupants have a dedicated space or structure for them. A single-family house is a housing unit, one apartment in an apartment building is a housing unit, and one room in a grouphouse is a housing unit. A householder is the person renting or owning a housing unit (in the case of a couple, it could be either of the two).

#### Statistical significance and margins of error

Text descriptions of the data generally focus on statistically significant differences at a minimum 90% significance level. For a difference to be statistically significant at a 90% level means that we would expect the difference to appear in the data due to randomness or sampling no more than 10% of the time.

For a place as small as Takoma Park it can be difficult to assess whether differences in the data are 'real,' or due to chance or the particular sample of people that the Census surveyed. This is especially true for analyses involving smaller subgroups or deeper-breakdowns of the data. For example, Takoma Park has a very small population of Native Hawaiians and Pacific Islanders, and populations of most groups become small when you break out data by race, age, and sex. Many interactive graphs have hover text showing whether there are statistically significant differences between the selected group and other groups, the level of confidence in a given difference, and/or the margin of error of the estimate.

For instance, in the plot below of internet access for residents 65 and over, hovering over Takoma Park's broadband internet results shows "Margin of error: 7.19%" and "Significant Differences: Overall, MC." 

- **The significant differences** results means that we have at least 90% confidence that there are actual-differences--and not just observed differences--between broadband access for Takoma Park residents 65+ and broadband access for all residents in the city ("Overall"), and between broadband access for 65+ residents of Takoma Park and 65+ residents of Montgomery County ("MC"). We don't see "MD" appear in the list of significant differences because we cannot have confidence at a 90% significance level that Takoma Park's 65+ broadband-access rate of 75.97% is actually-different than Maryland's 65+ access rate of 77.12%.
- **The margin of error** means that we are 90% confident that the actual level of broadband internet access of people 65 and over--not just the 'observed' estimate, which is what we see in the survey data--is between `r 75.97 - 7.19`% and `r 75.97 + 7.19`%. The margin of error suggests that Takoma Park's rate could be either higher or lower than Maryland's access rate due to randomness or sampling.

```{r demo subplot}
plot_gen_agecomp("65+", showleg = T) %>%
  layout(title = "Internet access or residents 65 and over",
         yaxis = list(title = "Percent"))

```
#### Reproducability and other analyses

Code used to produce this webpage and pre-process the data can be found on the [City's Github page](https://github.com/City-of-Takoma-Park/hced). Similar information can be found in the [City's interactive demographic map](https://takomaparkmd.gov/news/learn-about-your-neighborhood-with-interactive-maps/) and in the [City's Social Vulnerability Index maps](https://takomaparkmd.gov/government/housing-and-community-development/planning-and-community-development/data-driven-approach-to-disaster-pandemic-response/).

### Updates and citations

**List of updates:**

- *11/18/2021:* Changed graph width options so resizes to screen and more mobile-friendly.
- *11/17/2021:* Webpage public.
- *9/15/2021:* Some language changes, esp. around statistical significance. Added disability by type graphs. Added poverty by sex graphs.
- *9/8/2021:* Reformatted methodology. Moved map layers position.
- *9/2/2021:* Uploaded webpage.

*Steven Manson, Jonathan Schroeder, David Van Riper, Tracy Kugler, and Steven Ruggles. IPUMS National Historical Geographic Information System: Version 16.0 [dataset]. Minneapolis, MN: IPUMS. 2021. http://doi.org/10.18128/D050.V16.0*


